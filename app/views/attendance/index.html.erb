<div class="dashboard-container">
  <h1>ダッシュボード</h1>

  <!-- ユーザー情報 -->
  <div class="user-info">
    <span id="user-name"><%= @employee_name %></span>
    <span id="user-role"><%= @is_owner ? 'オーナー' : '従業員' %></span>
  </div>

  <!-- 打刻機能（メインエリア） -->
  <div class="time-clock-section main-section">
    <h2>勤怠打刻</h2>
    <div class="time-clock-buttons">
      <button id="clock-in-btn" class="button clock-in main-button" onclick="clockIn()">出勤</button>
      <button id="clock-out-btn" class="button clock-out main-button" onclick="clockOut()">退勤</button>
    </div>
    <div id="clock-status" class="clock-status"><%= @clock_status[:message] %></div>
  </div>

  <!-- 勤怠履歴 -->
  <div class="attendance-history-section">
    <h3 id="attendance-title">勤怠履歴
      <span class="month-navigation-buttons">
        <button class="button" onclick="prevMonth()">前月</button>
        <button class="button" onclick="nextMonth()">次月</button>
      </span>
    </h3>
    <div id="attendance-container">
      <p>勤怠履歴を読み込んでいます...</p>
    </div>
  </div>


  <!-- メッセージ表示 -->
  <div id="message" class="message" style="display: none;"></div>
</div>

<script>
  const current_employee_id = '<%= @employee_id %>';
  const current_employee_name = '<%= @employee_name %>';

  // 勤怠履歴の変数
  let attendanceYear = <%= Date.current.year %>;
  let attendanceMonth = <%= Date.current.month %>;
  let allAttendanceData;

  // ページ読み込み時の初期化
  document.addEventListener('DOMContentLoaded', function() {
    updateClockButtons();
    initializeAttendanceHistory();
  });

  // 勤怠履歴の初期化
  function initializeAttendanceHistory() {
    if (!current_employee_id) {
      showAttendanceError('従業員IDが取得できません');
      return;
    }

    // 勤怠履歴を読み込み
    loadAttendanceData();
  }

  // 勤怠データを読み込み
  function loadAttendanceData() {
    const yearMonth = attendanceYear + '-' + String(attendanceMonth).padStart(2, '0');

    fetch('<%= attendance_history_path %>?year=' + attendanceYear + '&month=' + attendanceMonth)
      .then(response => response.json())
      .then(data => {
        displayAttendanceData(data);
      })
      .catch(error => {
        showAttendanceError('勤怠データの取得に失敗しました: ' + error.message);
      });
  }

  // 勤怠データを表示
  function displayAttendanceData(attendance_records) {
    try {
      const attendance_container = document.getElementById('attendance-container');
      const title = document.getElementById('attendance-title');

      // タイトルを更新（ページネーションボタンを保持）
      title.innerHTML = attendanceYear + '年' + attendanceMonth + '月の勤怠履歴' +
        '<span class="month-navigation-buttons">' +
        '<button class="button" onclick="prevMonth()">前月</button>' +
        '<button class="button" onclick="nextMonth()">次月</button>' +
        '</span>';

      // テーブルを生成
      let html = '<table border="1">';
      html += '<thead><tr><th>種別</th><th>日時</th></tr></thead>';
      html += '<tbody>';

      if (!attendance_records || attendance_records.length === 0) {
        // データがない場合は空の行を表示
        html += '<tr><td colspan="2" style="text-align: center; padding: 40px; color: #999;">この月の勤怠記録がありません</td></tr>';
      } else {
        for (let i = 0; i < attendance_records.length; i++) {
          const attendance_record = attendance_records[i];
          html += '<tr>';
          html += '<td>' + attendance_record.type + '</td>';
          html += '<td>' + attendance_record.date + '</td>';
          html += '</tr>';
        }
      }

      html += '</tbody></table>';
      attendance_container.innerHTML = html;

    } catch (error) {
      showAttendanceError('勤怠データの表示に失敗しました: ' + error.message);
    }
  }

  // 前の月に移動
  function prevMonth() {
    attendanceMonth--;
    if (attendanceMonth < 1) {
      attendanceMonth = 12;
      attendanceYear--;
    }
    loadAttendanceData();
  }

  // 次の月に移動
  function nextMonth() {
    attendanceMonth++;
    if (attendanceMonth > 12) {
      attendanceMonth = 1;
      attendanceYear++;
    }
    loadAttendanceData();
  }

  // 勤怠エラー表示
  function showAttendanceError(message) {
    const container = document.getElementById('attendance-container');
    container.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">' + message + '</p>';
  }

  // 打刻ボタンの状態更新
  function updateClockButtons() {
    if (!current_employee_id) return;

    fetch('<%= clock_status_path %>')
      .then(response => response.json())
      .then(clockStatus => {
        const clockInBtn = document.getElementById('clock-in-btn');
        const clockOutBtn = document.getElementById('clock-out-btn');
        const statusDiv = document.getElementById('clock-status');

        if (clockStatus.can_clock_in) {
          clockInBtn.disabled = false;
          clockInBtn.textContent = '出勤';
        } else {
          clockInBtn.disabled = true;
          clockInBtn.textContent = '出勤';
        }

        if (clockStatus.can_clock_out) {
          clockOutBtn.disabled = false;
          clockOutBtn.textContent = '退勤';
        } else {
          clockOutBtn.disabled = true;
          clockOutBtn.textContent = '退勤';
        }

        if (clockStatus.message) {
          statusDiv.textContent = clockStatus.message;
          statusDiv.style.display = 'block';
        } else {
          statusDiv.style.display = 'none';
        }
      })
      .catch(error => {
        console.error('打刻状態取得エラー:', error);
      });
  }

  // 出勤打刻
  function clockIn() {
    if (!current_employee_id) return;

    fetch('<%= clock_in_path %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      }
    })
    .then(response => response.json())
    .then(result => {
      showMessage(result.message, result.success ? 'success' : 'error');
      if (result.success) {
        updateClockButtons();
        loadAttendanceData();
      }
    })
    .catch(error => {
      console.error('出勤打刻エラー:', error);
      showMessage('出勤打刻中にエラーが発生しました', 'error');
    });
  }

  // 退勤打刻
  function clockOut() {
    if (!current_employee_id) return;

    fetch('<%= clock_out_path %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      }
    })
    .then(response => response.json())
    .then(result => {
      showMessage(result.message, result.success ? 'success' : 'error');
      if (result.success) {
        updateClockButtons();
        loadAttendanceData();
      }
    })
    .catch(error => {
      console.error('退勤打刻エラー:', error);
      showMessage('退勤打刻中にエラーが発生しました', 'error');
    });
  }

  function showMessage(message, type) {
    if (window.messageHandler) {
      return window.messageHandler.show(message, type);
    }
  }
</script>
