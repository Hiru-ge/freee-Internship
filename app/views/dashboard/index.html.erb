<div class="my-page-container">
  <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
  
  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
  <div class="user-info">
    <span id="user-name"><%= @employee_name %></span>
    <span id="user-role"><%= @is_owner ? 'ã‚ªãƒ¼ãƒŠãƒ¼' : 'å¾“æ¥­å“¡' %></span>
  </div>

  <!-- æ‰“åˆ»æ©Ÿèƒ½ -->
  <div class="time-clock-section">
    <h3>å‹¤æ€ æ‰“åˆ»</h3>
    <div class="time-clock-buttons">
      <button id="clock-in-btn" class="button clock-in" onclick="clockIn()">å‡ºå‹¤æ‰“åˆ»</button>
      <button id="clock-out-btn" class="button clock-out" onclick="clockOut()">é€€å‹¤æ‰“åˆ»</button>
    </div>
    <div id="clock-status" class="clock-status"><%= @clock_status[:message] %></div>
  </div>

  <!-- çµ¦ä¸æƒ…å ±ï¼ˆ103ä¸‡ã®å£ã‚²ãƒ¼ã‚¸ï¼‰ -->
  <div class="wage-section">
    <h3>103ä¸‡ã®å£ã‚²ãƒ¼ã‚¸ <span style="font-size: 0.7em; color: #999;">â€»</span></h3>
    <p style="font-size: 0.8em; color: #999; margin: 5px 0;">â€»ã“ã®ã‚²ãƒ¼ã‚¸çŠ¶æ…‹ã¯ã€ã™ã§ã«å…¥ã£ã¦ã„ã‚‹ã‚·ãƒ•ãƒˆã‚’ã‚‚ã¨ã«è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã™</p>
    <div class="wage-gauge">
      <div class="wage-info">
        <span class="wage-amount">Â¥<%= number_with_delimiter(@wage_info[:wage]) %></span>
        <span class="wage-target">/ Â¥<%= number_with_delimiter(@wage_info[:target]) %></span>
      </div>
      <div class="gauge-container">
        <div class="gauge-bar">
          <div class="gauge-fill" style="width: <%= [@wage_info[:percentage], 100].min %>%"></div>
        </div>
        <div class="gauge-percentage"><%= @wage_info[:percentage] %>%</div>
      </div>
      <% if @wage_info[:wage] >= @wage_info[:target] %>
        <div class="wage-achievement">ğŸ‰ ç›®æ¨™é”æˆï¼</div>
      <% else %>
        <div class="wage-remaining">æ®‹ã‚Š: Â¥<%= number_with_delimiter(@wage_info[:target] - @wage_info[:wage]) %></div>
      <% end %>
      
      <script>
        // çµ¦ä¸ã‚²ãƒ¼ã‚¸ã®è‰²ã‚’å‹•çš„ã«å¤‰æ›´
        document.addEventListener('DOMContentLoaded', function() {
          var percentage = <%= @wage_info[:percentage] %>;
          var gaugeFill = document.querySelector('.gauge-fill');
          
          if (percentage >= 100) {
            gaugeFill.style.backgroundColor = '#ff4444'; // èµ¤
          } else if (percentage >= 80) {
            gaugeFill.style.backgroundColor = '#ffaa44'; // ã‚ªãƒ¬ãƒ³ã‚¸
          } else {
            gaugeFill.style.backgroundColor = '#44ff44'; // ç·‘
          }
        });
      </script>
    </div>
  </div>

  <!-- å‹¤æ€ å±¥æ­´ -->
  <div class="attendance-history-section">
    <h3 id="attendance-title">å‹¤æ€ å±¥æ­´
      <span class="month-navigation-buttons">
        <button class="button" onclick="prevMonth()">å‰æœˆ</button>
        <button class="button" onclick="nextMonth()">æ¬¡æœˆ</button>
      </span>
    </h3>
    <div id="attendance-container">
      <p>å‹¤æ€ å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>

  <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="navigation">
    <%= link_to "ã‚·ãƒ•ãƒˆãƒšãƒ¼ã‚¸", shifts_path, class: "button nav-button" %>
    <%= link_to "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´", password_change_auth_path, class: "button nav-button" %>
    <%= form_with url: logout_auth_path, method: :post, local: true, class: "logout-form" do |form| %>
      <%= form.submit "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", class: "button nav-button logout" %>
    <% end %>
  </div>

  <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
  <div id="message" class="message" style="display: none;"></div>
</div>

<script>
  var currentEmployeeId = '<%= @employee_id %>';
  var currentEmployeeName = '<%= @employee_name %>';
  
  // å‹¤æ€ å±¥æ­´ã®å¤‰æ•°
  var attendanceYear = <%= Date.current.year %>;
  var attendanceMonth = <%= Date.current.month %>;
  var allAttendanceData;

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    updateClockButtons();
    initializeAttendanceHistory();
  });

  // å‹¤æ€ å±¥æ­´ã®åˆæœŸåŒ–
  function initializeAttendanceHistory() {
    if (!currentEmployeeId) {
      showAttendanceError('å¾“æ¥­å“¡IDãŒå–å¾—ã§ãã¾ã›ã‚“');
      return;
    }

    // å‹¤æ€ å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    loadAttendanceData();
  }

  // å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  function loadAttendanceData() {
    var yearMonth = attendanceYear + '-' + String(attendanceMonth).padStart(2, '0');
    console.log('å‹¤æ€ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');
    console.log('å¾“æ¥­å“¡ID:', currentEmployeeId);
    console.log('å¹´æœˆ:', yearMonth);
    
    fetch('<%= dashboard_attendance_history_path %>?year=' + attendanceYear + '&month=' + attendanceMonth)
      .then(response => response.json())
      .then(data => {
        console.log('å‹¤æ€ ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data);
        displayAttendanceData(data);
      })
      .catch(error => {
        console.log('å‹¤æ€ ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', error);
        showAttendanceError('å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      });
  }

  // å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
  function displayAttendanceData(records) {
    try {
      var container = document.getElementById('attendance-container');
      var title = document.getElementById('attendance-title');
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’ä¿æŒï¼‰
      title.innerHTML = attendanceYear + 'å¹´' + attendanceMonth + 'æœˆã®å‹¤æ€ å±¥æ­´' +
        '<span class="month-navigation-buttons">' +
        '<button class="button" onclick="prevMonth()">å‰æœˆ</button>' +
        '<button class="button" onclick="nextMonth()">æ¬¡æœˆ</button>' +
        '</span>';
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆ
      var html = '<table border="1">';
      html += '<thead><tr><th>ç¨®åˆ¥</th><th>æ—¥æ™‚</th></tr></thead>';
      html += '<tbody>';
      
      if (!records || records.length === 0) {
        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºã®è¡Œã‚’è¡¨ç¤º
        html += '<tr><td colspan="2" style="text-align: center; padding: 40px; color: #999;">ã“ã®æœˆã®å‹¤æ€ è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      } else {
        for (var i = 0; i < records.length; i++) {
          var record = records[i];
          html += '<tr>';
          html += '<td>' + record.type + '</td>';
          html += '<td>' + record.date + '</td>';
          html += '</tr>';
        }
      }
      
      html += '</tbody></table>';
      container.innerHTML = html;
      
    } catch (error) {
      showAttendanceError('å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    }
  }

  // å‰ã®æœˆã«ç§»å‹•
  function prevMonth() {
    attendanceMonth--;
    if (attendanceMonth < 1) {
      attendanceMonth = 12;
      attendanceYear--;
    }
    loadAttendanceData();
  }

  // æ¬¡ã®æœˆã«ç§»å‹•
  function nextMonth() {
    attendanceMonth++;
    if (attendanceMonth > 12) {
      attendanceMonth = 1;
      attendanceYear++;
    }
    loadAttendanceData();
  }

  // å‹¤æ€ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
  function showAttendanceError(message) {
    var container = document.getElementById('attendance-container');
    container.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">' + message + '</p>';
  }

  // æ‰“åˆ»ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
  function updateClockButtons() {
    if (!currentEmployeeId) return;
    
    fetch('<%= dashboard_clock_status_path %>')
      .then(response => response.json())
      .then(clockStatus => {
        var clockInBtn = document.getElementById('clock-in-btn');
        var clockOutBtn = document.getElementById('clock-out-btn');
        var statusDiv = document.getElementById('clock-status');
        
        if (clockStatus.can_clock_in) {
          clockInBtn.disabled = false;
          clockInBtn.textContent = 'å‡ºå‹¤æ‰“åˆ»';
        } else {
          clockInBtn.disabled = true;
          clockInBtn.textContent = 'å‡ºå‹¤æ¸ˆã¿';
        }
        
        if (clockStatus.can_clock_out) {
          clockOutBtn.disabled = false;
          clockOutBtn.textContent = 'é€€å‹¤æ‰“åˆ»';
        } else {
          clockOutBtn.disabled = true;
          clockOutBtn.textContent = 'é€€å‹¤æ¸ˆã¿';
        }
        
        if (clockStatus.message) {
          statusDiv.textContent = clockStatus.message;
          statusDiv.style.display = 'block';
        } else {
          statusDiv.style.display = 'none';
        }
      })
      .catch(error => {
        console.error('æ‰“åˆ»çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      });
  }

  // å‡ºå‹¤æ‰“åˆ»
  function clockIn() {
    if (!currentEmployeeId) return;
    
    fetch('<%= dashboard_clock_in_path %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      }
    })
    .then(response => response.json())
    .then(result => {
      showMessage(result.message, result.success ? 'success' : 'error');
      if (result.success) {
        updateClockButtons();
        loadAttendanceData();
      }
    })
    .catch(error => {
      console.error('å‡ºå‹¤æ‰“åˆ»ã‚¨ãƒ©ãƒ¼:', error);
      showMessage('å‡ºå‹¤æ‰“åˆ»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    });
  }

  // é€€å‹¤æ‰“åˆ»
  function clockOut() {
    if (!currentEmployeeId) return;
    
    fetch('<%= dashboard_clock_out_path %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      }
    })
    .then(response => response.json())
    .then(result => {
      showMessage(result.message, result.success ? 'success' : 'error');
      if (result.success) {
        updateClockButtons();
        loadAttendanceData();
      }
    })
    .catch(error => {
      console.error('é€€å‹¤æ‰“åˆ»ã‚¨ãƒ©ãƒ¼:', error);
      showMessage('é€€å‹¤æ‰“åˆ»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    });
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  function showMessage(message, type) {
    var messageDiv = document.getElementById('message');
    messageDiv.textContent = message;
    messageDiv.className = 'message ' + type;
    messageDiv.style.display = 'block';
    
    // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    setTimeout(function() {
      messageDiv.style.display = 'none';
    }, 3000);
  }
</script>

<style>
  /* çµ¦ä¸ã‚²ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .wage-section {
    background-color: #4a4a4a;
    border: 1px solid #777;
    border-radius: 6px;
    padding: 6px;
    margin: 3px 0;
  }

  .wage-gauge {
    text-align: center;
  }

  .wage-info {
    margin-bottom: 6px;
  }

  .wage-amount {
    font-size: 0.8em;
    font-weight: bold;
    color: #f0f0f0;
  }

  .wage-target {
    font-size: 0.8em;
    color: #f0f0f0;
  }

  .gauge-container {
    position: relative;
    margin: 6px 0;
  }

  .gauge-bar {
    width: 100%;
    height: 16px;
    background-color: #333;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    border: 1px solid #777;
  }

  .gauge-fill {
    height: 100%;
    background-color: #44ff44;
    border-radius: 8px;
    transition: width 0.5s ease, background-color 0.3s ease;
    position: relative;
  }

  .gauge-percentage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
    color: #f0f0f0;
    font-size: 0.8em;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
  }

  .wage-achievement {
    color: #f0f0f0;
    font-weight: bold;
    font-size: 0.8em;
    margin-top: 6px;
  }

  .wage-remaining {
    color: #f0f0f0;
    font-size: 0.8em;
    margin-top: 6px;
  }
</style>