<div class="shift-page-container <%= @is_owner ? 'owner-mode' : 'employee-mode' %>">
  <h1>ã‚·ãƒ•ãƒˆãƒšãƒ¼ã‚¸</h1>


  <!-- ã‚·ãƒ•ãƒˆè¡¨ -->
  <div class="shift-calendar-section">
    <h2>ã‚·ãƒ•ãƒˆè¡¨</h2>
    <p>äº¤ä»£ã‚’ä¾é ¼ã—ãŸã„<strong>è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆ</strong>ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ ã¸é·ç§»ã—ã¾ã™ã€‚<br>
    <small class="help-text">â€» é»„è‰²ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚·ãƒ•ãƒˆãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã§ã™</small></p>

    <!-- ã‚·ãƒ•ãƒˆç®¡ç†ãƒœã‚¿ãƒ³ -->
    <div class="shift-management">
      <button class="button" onclick="goToRequestList()">è‡ªåˆ†ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§</button>
      <button class="button" onclick="goToDeletionForm()">æ¬ å‹¤ç”³è«‹</button>
      <button id="shift-add-btn" class="button owner-only hidden" onclick="goToShiftAddForm()">ã‚·ãƒ•ãƒˆè¿½åŠ ä¾é ¼</button>
    </div>

    <div class="month-navigation">
      <h3 id="calendar-title"></h3>
      <div class="month-navigation-buttons">
        <button class="button small-button" onclick="prevWeek()"><</button>
        <button class="button small-button" onclick="nextWeek()">></button>
      </div>
    </div>

    <div id="shift-calendar-container">
      <p>ã‚·ãƒ•ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>

  <!-- å¾“æ¥­å“¡ä¸€è¦§ã¨103ä¸‡ã®å£ã‚²ãƒ¼ã‚¸ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ï¼‰ -->
  <% if @is_owner %>
  <div id="employee-list-section" class="employee-list-section">
    <h2>å…¨å¾“æ¥­å“¡ã®çµ¦ä¸çŠ¶æ³</h2>
    <table border="1" class="employee-list">
      <thead>
        <tr>
          <th>å¾“æ¥­å“¡å</th>
          <th>çµ¦ä¸çŠ¶æ³ï¼ˆ103ä¸‡ã®å£ã‚²ãƒ¼ã‚¸ï¼‰</th>
        </tr>
      </thead>
      <tbody id="employee-list-body">
        <tr><td colspan="2">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
      </tbody>
    </table>
  </div>
  <% end %>

  <!-- å€‹äººã®103ä¸‡ã®å£ã‚²ãƒ¼ã‚¸ï¼ˆå¾“æ¥­å“¡ã®ã¿ï¼‰ -->
  <% unless @is_owner %>
  <div id="personal-gauge-section" class="personal-gauge-section">
    <h2>103ä¸‡ã®å£ã‚²ãƒ¼ã‚¸ <span class="help-text small">â€»</span></h2>
    <p class="help-text">â€»ã“ã®ã‚²ãƒ¼ã‚¸çŠ¶æ…‹ã¯ã€ã™ã§ã«å…¥ã£ã¦ã„ã‚‹ã‚·ãƒ•ãƒˆã‚’ã‚‚ã¨ã«è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã™</p>
    <div class="wage-gauge" id="personal-wage-gauge">
      <div class="gauge-container">
        <div class="gauge-bar">
          <div class="gauge-fill" style="width: 0%"></div>
        </div>
        <div class="gauge-text">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
  <% end %>

  <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
  <div id="message" class="message hidden"></div>
</div>

<script>
  var current_employee_id = '<%= @employee_id %>';
  var is_owner = <%= @is_owner %>;
  var calendarYear;
  var calendarMonth;
  var allShiftsData;
  var currentStartDate;
  var daysInMonth;

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    checkOwnerPermissions();
    loadShifts();
  });

  // ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ãƒã‚§ãƒƒã‚¯
  function checkOwnerPermissions() {

    // ã‚³ãƒ³ãƒ†ãƒŠã«æ¨©é™ãƒ¢ãƒ¼ãƒ‰ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
    var shift_page_container = document.querySelector('.shift-page-container');
    shift_page_container.classList.remove('owner-mode', 'employee-mode');

    if (is_owner) {
      // ã‚ªãƒ¼ãƒŠãƒ¼ã®å ´åˆï¼šå¾“æ¥­å“¡ä¸€è¦§ã¨çµ¦ä¸ã‚²ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      shift_page_container.classList.add('owner-mode');
      document.getElementById('shift-add-btn').style.display = 'inline-block';
      loadEmployeeList();
    } else {
      // å¾“æ¥­å“¡ã®å ´åˆï¼šå€‹äººã®çµ¦ä¸ã‚²ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      shift_page_container.classList.add('employee-mode');
      document.getElementById('shift-add-btn').style.display = 'none';
      loadPersonalGauge();
    }
  }

  // å¾“æ¥­å“¡ä¸€è¦§ã®èª­ã¿è¾¼ã¿ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ï¼‰
  function loadEmployeeList() {
    // é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
    if (window.employeeListLoading) return;
    window.employeeListLoading = true;

    // å¾“æ¥­å“¡ä¸€è¦§ã®å–å¾—
    fetch('<%= shifts_employees_path %>')
      .then(response => response.json())
      .then(employees => {
        var tbody = document.getElementById('employee-list-body');
        tbody.innerHTML = '';

        if (employees && employees.length > 0) {
          employees.forEach(function(employee) {
            var row = document.createElement('tr');
            row.innerHTML =
              '<td>' + employee.display_name + '</td>' +
              '<td><div class="wage-gauge" data-employee-id="' + employee.id + '">' +
              '<div class="gauge-container">' +
              '<div class="gauge-bar"><div class="gauge-fill" style="width: 0%"></div></div>' +
              '<div class="gauge-text">èª­ã¿è¾¼ã¿ä¸­...</div>' +
              '</div></div></td>';
            tbody.appendChild(row);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="2">å¾“æ¥­å“¡æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        }

        // å¾“æ¥­å“¡ä¸€è¦§ã®èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«çµ¦ä¸ã‚²ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿
        loadWageGauge();
      })
      .catch(error => {
        console.error('å¾“æ¥­å“¡ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('employee-list-body').innerHTML = '<tr><td colspan="2">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</td></tr>';
      });
  }

  // çµ¦ä¸ã‚²ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ï¼‰
  function loadWageGauge() {
    // å…¨å¾“æ¥­å“¡ã®çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    fetch('/wages/all_wages')
      .then(response => response.json())
      .then(wages => {
        if (wages && wages.length > 0) {
          wages.forEach(function(wage) {
            updateWageGaugeForEmployee(wage.employee_id, wage);
          });
        } else {
          // ç©ºãƒ‡ãƒ¼ã‚¿æ™‚ã®è¡¨ç¤º
          var gauges = document.querySelectorAll('.wage-gauge[data-employee-id]');
          gauges.forEach(function(gauge) {
            var gaugeText = gauge.querySelector('.gauge-text');
            if (gaugeText) {
              gaugeText.innerHTML = 'ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
            }
          });
        }
      })
      .catch(error => {
        console.error('å…¨å¾“æ¥­å“¡çµ¦ä¸ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', error);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®è¡¨ç¤º
        var gauges = document.querySelectorAll('.wage-gauge[data-employee-id]');
        gauges.forEach(function(gauge) {
          var gaugeText = gauge.querySelector('.gauge-text');
          if (gaugeText) {
            gaugeText.innerHTML = 'ã‚¨ãƒ©ãƒ¼: çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ<br>' + error.message;
          }
        });
      });
  }

  // å€‹äººã®çµ¦ä¸ã‚²ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ï¼ˆå¾“æ¥­å“¡ã®ã¿ï¼‰
  function loadPersonalGauge() {
    // èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’è¨­å®š
    var gaugeText = document.querySelector('#personal-wage-gauge .gauge-text');
    if (gaugeText) {
      gaugeText.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
    }

    // å€‹äººã®çµ¦ä¸æƒ…å ±ã‚’å–å¾—
    fetch('/wages/wage_info?employee_id=' + current_employee_id)
      .then(response => response.json())
      .then(wageInfo => {
        updatePersonalWageGauge(wageInfo);
      })
      .catch(error => {
        console.error('çµ¦ä¸æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        if (current_employee_id) { // å®Ÿéš›ã®IDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
          document.querySelector('#personal-wage-gauge .gauge-text').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        }
      });
  }

  // ã‚·ãƒ•ãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿
  function loadShifts() {
    var shift_calendar_container = document.getElementById('shift-calendar-container');
    shift_calendar_container.innerHTML = '<p>ã‚·ãƒ•ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>';

    fetch('<%= shifts_data_path %>')
      .then(response => response.json())
      .then(data => {
        initializeShifts(data);
      })
      .catch(error => {
        console.error('ã‚·ãƒ•ãƒˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        shift_calendar_container.innerHTML = '<p>ã‚·ãƒ•ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
      });
  }

  function initializeShifts(dataFromServer) {
    allShiftsData = dataFromServer;

    calendarYear = allShiftsData.year;
    calendarMonth = allShiftsData.month;
    daysInMonth = new Date(calendarYear, calendarMonth, 0).getDate();

    // æœ€åˆã®è¡¨ç¤ºç¯„å›²ã‚’è¨­å®šï¼ˆä»Šæ—¥ã®æ—¥ä»˜ã‚’å«ã‚€é€±ã®é–‹å§‹æ—¥ï¼‰
    var now = new Date();
    var today = now.getDate();
    var dayOfWeek = now.getDay(); // 0=æ—¥æ›œæ—¥, 1=æœˆæ›œæ—¥, ...

    // ä»Šæ—¥ã‚’å«ã‚€é€±ã®é–‹å§‹æ—¥ã‚’è¨ˆç®—ï¼ˆæœˆæ›œæ—¥ã‚’é€±ã®é–‹å§‹ã¨ã™ã‚‹ï¼‰
    var startOfWeek = today - (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
    currentStartDate = new Date(now.getFullYear(), now.getMonth(), startOfWeek);

    updateCalendarTitle();
    displayShifts();
  }

  function updateCalendarTitle() {
    var title = document.getElementById('calendar-title');
    title.textContent = calendarYear + 'å¹´' + calendarMonth + 'æœˆ';
  }

  function displayShifts() {
    var titleEl = document.getElementById('calendar-title');
    titleEl.textContent = calendarYear + 'å¹´' + calendarMonth + 'æœˆ';

    var shift_calendar_container = document.getElementById('shift-calendar-container');
    if (!shift_calendar_container) {
      console.error('shift-calendar-containerè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    shift_calendar_container.innerHTML = "";

    var table = document.createElement('table');
    table.className = 'shift-calendar';
    var thead = document.createElement('thead');
    var tbody = document.createElement('tbody');

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ç”Ÿæˆ
    var headerRow = document.createElement('tr');
    var nameHeader = document.createElement('th');
    nameHeader.textContent = 'å¾“æ¥­å“¡å';
    headerRow.appendChild(nameHeader);

    var datesToShow = []; // è¡¨ç¤ºã™ã‚‹æ—¥ä»˜ã®é…åˆ—
    var currentMonth = currentStartDate.getMonth();
    var currentYear = currentStartDate.getFullYear();
    var lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆè¡¨ç¤ºã•ã‚Œã‚‹æœ€å¾Œã®æ—¥ãŒæœˆã®æœ€çµ‚æ—¥ä»¥ä¸Šã®å ´åˆï¼‰
    var lastDayOfDisplayedPeriod = currentStartDate.getDate() + 6;
    var isLastPage = lastDayOfDisplayedPeriod >= lastDayOfMonth;

    if (isLastPage) {
        // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã®å ´åˆï¼šãã®æœˆã®æœ€å¾Œã®7æ—¥åˆ†ã‚’è¡¨ç¤º
        var startDay = Math.max(1, lastDayOfMonth - 6);
        for (var day = startDay; day <= lastDayOfMonth; day++) {
            datesToShow.push({
                day: day,
                month: currentMonth,
                year: currentYear,
                displayText: day + 'æ—¥'
            });
            var dayHeader = document.createElement('th');
            dayHeader.textContent = day + 'æ—¥';
            headerRow.appendChild(dayHeader);
        }
    } else {
        // é€šå¸¸ã®ãƒšãƒ¼ã‚¸ã®å ´åˆï¼šé€±ã®é–‹å§‹æ—¥ã‹ã‚‰7æ—¥åˆ†ã‚’è¡¨ç¤º
        var currentDate = new Date(currentStartDate);
        for(var i = 0; i < 7; i++) {
            var day = currentDate.getDate();
            var month = currentDate.getMonth();
            var year = currentDate.getFullYear();

            // ç¾åœ¨ã®æœˆå†…ã®æ—¥ä»˜ã®ã¿è¡¨ç¤ºï¼ˆç¿Œæœˆã¯å«ã‚ãªã„ï¼‰
            if (month === currentMonth && year === currentYear) {
                datesToShow.push({
                    day: day,
                    month: month,
                    year: year,
                    displayText: day + 'æ—¥'
                });
                var dayHeader = document.createElement('th');
                dayHeader.textContent = day + 'æ—¥';
                headerRow.appendChild(dayHeader);
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }
    thead.appendChild(headerRow);

    // ãƒœãƒ‡ã‚£è¡Œã®ç”Ÿæˆ
    for (var employeeId in allShiftsData.shifts) {
      var employeeData = allShiftsData.shifts[employeeId];
      var employeeRow = document.createElement('tr');
      var nameCell = document.createElement('td');
      nameCell.textContent = employeeData.name;
      employeeRow.appendChild(nameCell);

      datesToShow.forEach(function(dateInfo) {
        var shiftCell = document.createElement('td');
        var shiftTime = employeeData.shifts[dateInfo.day] || "";
        if (shiftTime) {
          // è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆã®ã¿ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
        if (String(employeeId) === String(current_employee_id)) {
          // ã‚·ãƒ•ãƒˆæ™‚é–“ã‚’è¡¨ç¤º
          shiftCell.textContent = shiftTime;
          shiftCell.style.color = '#ffca28'; // è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆã¯é»„è‰²ã§å¼·èª¿
        } else {
          // ä»–äººã®ã‚·ãƒ•ãƒˆã¯ã‚¯ãƒªãƒƒã‚¯ä¸å¯
          shiftCell.style.cursor = 'default';
          shiftCell.style.color = '#999'; // ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
          shiftCell.title = 'ä»–ã®äººã®ã‚·ãƒ•ãƒˆã¯ã‚¯ãƒªãƒƒã‚¯ã§ãã¾ã›ã‚“';
          shiftCell.textContent = shiftTime;
        }
        } else {
          shiftCell.textContent = '';
        }
        employeeRow.appendChild(shiftCell);
      });
      tbody.appendChild(employeeRow);
    }

    table.appendChild(thead);
    table.appendChild(tbody);
    shift_calendar_container.appendChild(table);

    updatePaginationButtons();
  }

  function updatePaginationButtons() {
    var prevBtn = document.querySelector('.month-navigation .button:first-of-type');
    var nextBtn = document.querySelector('.month-navigation .button:last-of-type');

    // 1æ—¥ãŒé–‹å§‹æ—¥ãªã‚‰ã€Œå‰ã¸ã€ã‚’ç„¡åŠ¹åŒ–
    if (currentStartDate.getDate() === 1) {
        prevBtn.disabled = true;
        prevBtn.style.opacity = '0.5';
    } else {
        prevBtn.disabled = false;
        prevBtn.style.opacity = '1.0';
    }

    // æœ€çµ‚æ—¥ãŒè¡¨ç¤ºç¯„å›²ã«å«ã¾ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    var lastDayOfDisplayedPeriod = currentStartDate.getDate() + 6;
    var lastDayOfMonth = new Date(currentStartDate.getFullYear(), currentStartDate.getMonth() + 1, 0).getDate();

    // è¡¨ç¤ºã•ã‚Œã‚‹æœ€å¾Œã®æ—¥ãŒæœˆã®æœ€çµ‚æ—¥ä»¥ä¸Šã®å ´åˆã€ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    if (lastDayOfDisplayedPeriod >= lastDayOfMonth) {
        nextBtn.disabled = true;
        nextBtn.style.opacity = '0.5';
    } else {
        nextBtn.disabled = false;
        nextBtn.style.opacity = '1.0';
    }
  }

  function prevWeek() {
    if (currentStartDate.getDate() > 1) {
        currentStartDate.setDate(currentStartDate.getDate() - 7);
        displayShifts();
    }
  }

  function nextWeek() {
    var nextWeekStart = new Date(currentStartDate);
    nextWeekStart.setDate(currentStartDate.getDate() + 7);

    // æ¬¡ã®é€±ã®é–‹å§‹æ—¥ãŒæœˆã®æœ€çµ‚æ—¥ã‚’è¶…ãˆã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    if (nextWeekStart.getMonth() === currentStartDate.getMonth()) {
      currentStartDate = nextWeekStart;
      displayShifts();
    } else {
      // æœˆã‚’ã¾ãŸãå ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆç¿Œæœˆã¯è¡¨ç¤ºã—ãªã„ï¼‰
      // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã§ã¯ãã®æœˆã®æœ€å¾Œã®7æ—¥åˆ†ã®ã¿ã‚’è¡¨ç¤º
    }
  }

  function startRequestForShift(employeeId, day, timeString) {
    // è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆã‹ã©ã†ã‹å†ç¢ºèª
    if (String(employeeId) !== String(current_employee_id)) {
      if (window.messageHandler) {
        window.messageHandler.show("ä»–ã®äººã®ã‚·ãƒ•ãƒˆã¯ã‚¯ãƒªãƒƒã‚¯ã§ãã¾ã›ã‚“ã€‚è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆã®ã¿äº¤ä»£ä¾é ¼ãŒå¯èƒ½ã§ã™ã€‚", "warning");
      } else {
        alert("ä»–ã®äººã®ã‚·ãƒ•ãƒˆã¯ã‚¯ãƒªãƒƒã‚¯ã§ãã¾ã›ã‚“ã€‚");
      }
      return;
    }

    var times = timeString.split('-');
    var startTime = times[0].padStart(2, '0') + ':00';
    var endTime = times[1].padStart(2, '0') + ':00';

    var monthStr = String(calendarMonth).padStart(2, '0');
    var dayStr = String(day).padStart(2, '0');
    var dateStr = calendarYear + '-' + monthStr + '-' + dayStr;

    var baseUrl = '<%= new_shift_exchange_path %>';
    var params = '?applicant_id=' + encodeURIComponent(employeeId) +
                '&date=' + encodeURIComponent(dateStr) +
                '&start=' + encodeURIComponent(startTime) +
                '&end=' + encodeURIComponent(endTime);
    window.location.href = baseUrl + params;
  }

  // æ¬ å‹¤ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ã«é·ç§»ã™ã‚‹é–¢æ•°
  function goToDeletionForm() {
    window.location.href = '<%= new_shift_deletion_path %>';
  }


  // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
  function goToRequestList() {
    window.location.href = '<%= shift_approvals_path %>';
  }

  function goToShiftAddForm() {
    window.location.href = '<%= new_shift_addition_path %>';
  }

  // å€‹äººã®çµ¦ä¸ã‚²ãƒ¼ã‚¸ã®æ›´æ–°
  function updatePersonalWageGauge(wageInfo) {
    var gaugeElement = document.getElementById('personal-wage-gauge');
    if (!gaugeElement) return;

    var gaugeFill = gaugeElement.querySelector('.gauge-fill');
    var gaugeText = gaugeElement.querySelector('.gauge-text');

    if (!wageInfo || wageInfo.wage === undefined || wageInfo.target === undefined) {
      gaugeText.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
      return;
    }

    var percentage = Math.min(wageInfo.percentage, 100);
    var wageFormatted = (wageInfo.wage / 10000).toFixed(1) + 'ä¸‡å††';
    var targetFormatted = (wageInfo.target / 10000).toFixed(0) + 'ä¸‡å††';

    // ã‚²ãƒ¼ã‚¸ã®å¹…ã‚’æ›´æ–°
    gaugeFill.style.width = percentage + '%';

    // è‰²ã‚’æ›´æ–°ï¼ˆGASã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    if (percentage >= 100) {
      gaugeFill.style.backgroundColor = '#ff4444'; // èµ¤
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>ğŸ‰ ç›®æ¨™é”æˆï¼';
    } else if (percentage >= 80) {
      gaugeFill.style.backgroundColor = '#ffaa44'; // ã‚ªãƒ¬ãƒ³ã‚¸
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>ã‚ã¨' + ((wageInfo.target - wageInfo.wage) / 10000).toFixed(1) + 'ä¸‡å††';
    } else {
      gaugeFill.style.backgroundColor = '#44ff44'; // ç·‘
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>ã‚ã¨' + ((wageInfo.target - wageInfo.wage) / 10000).toFixed(1) + 'ä¸‡å††';
    }
  }

  // çµ¦ä¸ã‚²ãƒ¼ã‚¸ã®æ›´æ–°ï¼ˆå¾“æ¥­å“¡æŒ‡å®šï¼‰
  function updateWageGaugeForEmployee(employeeId, wageInfo) {
    var gaugeElement = document.querySelector('.wage-gauge[data-employee-id="' + employeeId + '"]');
    if (!gaugeElement) {
      return;
    }

    var gaugeFill = gaugeElement.querySelector('.gauge-fill');
    var gaugeText = gaugeElement.querySelector('.gauge-text');

    var percentage = Math.min(wageInfo.percentage, 100);
    var wageFormatted = (wageInfo.wage / 10000).toFixed(1) + 'ä¸‡å††';
    var targetFormatted = (wageInfo.target / 10000).toFixed(0) + 'ä¸‡å††';

    // ã‚²ãƒ¼ã‚¸ã®å¹…ã‚’æ›´æ–°
    gaugeFill.style.width = percentage + '%';

    // è‰²ã‚’æ›´æ–°ï¼ˆGASã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    if (percentage >= 100) {
      gaugeFill.style.backgroundColor = '#ff4444'; // èµ¤
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>ğŸ‰ ç›®æ¨™é”æˆï¼';
    } else if (percentage >= 80) {
      gaugeFill.style.backgroundColor = '#ffaa44'; // ã‚ªãƒ¬ãƒ³ã‚¸
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>ã‚ã¨' + ((wageInfo.target - wageInfo.wage) / 10000).toFixed(1) + 'ä¸‡å††';
    } else {
      gaugeFill.style.backgroundColor = '#44ff44'; // ç·‘
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>ã‚ã¨' + ((wageInfo.target - wageInfo.wage) / 10000).toFixed(1) + 'ä¸‡å††';
    }
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  function showMessage(message, type) {
    var messageDiv = document.getElementById('message');
    messageDiv.textContent = message;
    messageDiv.className = 'message ' + type;
    messageDiv.style.display = 'block';

    // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    setTimeout(function() {
      messageDiv.style.display = 'none';
    }, 3000);
  }
</script>

<!-- CSSã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†é›¢æ¸ˆã¿ -->
