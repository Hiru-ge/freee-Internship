<div class="shift-page-container <%= @is_owner ? 'owner-mode' : 'employee-mode' %>">
  <h1>シフトページ</h1>
  
  <!-- ナビゲーション -->
  <div class="page-navigation">
    <%= link_to "マイページに戻る", dashboard_path, class: "button nav-button" %>
    <%= link_to "パスワード変更", password_change_auth_path, class: "button nav-button" %>
    <%= form_with url: logout_auth_path, method: :post, local: true, class: "logout-form" do |form| %>
      <%= form.submit "ログアウト", class: "button nav-button logout" %>
    <% end %>
  </div>
  
  <!-- シフト表 -->
  <div class="shift-calendar-section">
    <h2>シフト表</h2>
    <p>交代を依頼したい<strong>自分のシフト</strong>をクリックすると、依頼フォームへ遷移します。<br>
    <small style="color: #999;">※ 黄色で表示されているシフトがクリック可能です</small></p>
    
    <div class="month-navigation">
      <h3 id="calendar-title"></h3>
      <div class="month-navigation-buttons">
        <button class="button small-button" onclick="prevWeek()"><</button>
        <button class="button small-button" onclick="nextWeek()">></button>
      </div>
    </div>
    
    <div id="shift-calendar-container">
      <p>シフト情報を読み込んでいます...</p>
    </div>
  </div>

  <!-- 従業員一覧と103万の壁ゲージ（オーナーのみ） -->
  <% if @is_owner %>
  <div id="employee-list-section" class="employee-list-section">
    <h2>全従業員の給与状況</h2>
    <table border="1" class="employee-list">
      <thead>
        <tr>
          <th>従業員名</th>
          <th>給与状況（103万の壁ゲージ）</th>
        </tr>
      </thead>
      <tbody id="employee-list-body">
        <tr><td colspan="2">読み込み中...</td></tr>
      </tbody>
    </table>
  </div>
  <% end %>

  <!-- 個人の103万の壁ゲージ（従業員のみ） -->
  <% unless @is_owner %>
  <div id="personal-gauge-section" class="personal-gauge-section">
    <h2>103万の壁ゲージ <span style="font-size: 0.7em; color: #999;">※</span></h2>
    <p style="font-size: 0.8em; color: #999; margin: 5px 0;">※このゲージ状態は、すでに入っているシフトをもとに計算されています</p>
    <div class="wage-gauge" id="personal-wage-gauge">
      <div class="gauge-container">
        <div class="gauge-bar">
          <div class="gauge-fill" style="width: 0%"></div>
        </div>
        <div class="gauge-text">読み込み中...</div>
      </div>
    </div>
  </div>
  <% end %>
  
  <!-- シフト管理ボタン -->
  <div class="shift-management">
    <button class="button" onclick="goToRequestList()">自分へのリクエスト一覧</button>
    <button id="shift-add-btn" class="button owner-only" onclick="goToShiftAddForm()" style="display: none;">シフト追加依頼</button>
  </div>

  <!-- メッセージ表示 -->
  <div id="message" class="message" style="display: none;"></div>
</div>

<script>
  var currentEmployeeId = '<%= @employee_id %>';
  var isOwner = <%= @is_owner %>;
  var calendarYear;
  var calendarMonth;
  var allShiftsData;
  var currentStartDate;
  var daysInMonth;

  // ページ読み込み時の初期化
  document.addEventListener('DOMContentLoaded', function() {
    checkOwnerPermissions();
    loadShifts();
  });

  // オーナー権限チェック
  function checkOwnerPermissions() {
    
    // コンテナに権限モードのクラスを追加
    var container = document.querySelector('.shift-page-container');
    container.classList.remove('owner-mode', 'employee-mode');
    
    if (isOwner) {
      // オーナーの場合：従業員一覧と給与ゲージを表示
      container.classList.add('owner-mode');
      document.getElementById('shift-add-btn').style.display = 'inline-block';
      loadEmployeeList();
    } else {
      // 従業員の場合：個人の給与ゲージを表示
      container.classList.add('employee-mode');
      document.getElementById('shift-add-btn').style.display = 'none';
      loadPersonalGauge();
    }
  }
  
  // 従業員一覧の読み込み（オーナーのみ）
  function loadEmployeeList() {
    // 重複実行を防ぐ
    if (window.employeeListLoading) return;
    window.employeeListLoading = true;

    // 従業員一覧の取得
    fetch('<%= shifts_employees_path %>')
      .then(response => response.json())
      .then(employees => {
        var tbody = document.getElementById('employee-list-body');
        tbody.innerHTML = '';

        if (employees && employees.length > 0) {
          employees.forEach(function(employee) {
            var row = document.createElement('tr');
            row.innerHTML = 
              '<td>' + employee.display_name + '</td>' +
              '<td><div class="wage-gauge" data-employee-id="' + employee.id + '">' +
              '<div class="gauge-container">' +
              '<div class="gauge-bar"><div class="gauge-fill" style="width: 0%"></div></div>' +
              '<div class="gauge-text">読み込み中...</div>' +
              '</div></div></td>';
            tbody.appendChild(row);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="2">従業員情報がありません</td></tr>';
        }
        
        // 従業員一覧の読み込み完了後に給与ゲージを読み込み
        loadWageGauge();
      })
      .catch(error => {
        console.error('従業員一覧取得エラー:', error);
        document.getElementById('employee-list-body').innerHTML = '<tr><td colspan="2">エラーが発生しました</td></tr>';
      });
  }

  // 給与ゲージの読み込み（オーナーのみ）
  function loadWageGauge() {
    // 全従業員の給与データを取得
    fetch('/wages/api_all_wages')
      .then(response => response.json())
      .then(wages => {
        if (wages && wages.length > 0) {
          wages.forEach(function(wage) {
            updateWageGaugeForEmployee(wage.employee_id, wage);
          });
        } else {
          // 空データ時の表示
          var gauges = document.querySelectorAll('.wage-gauge[data-employee-id]');
          gauges.forEach(function(gauge) {
            var gaugeText = gauge.querySelector('.gauge-text');
            if (gaugeText) {
              gaugeText.innerHTML = 'シフトデータがありません';
            }
          });
        }
      })
      .catch(error => {
        console.error('全従業員給与データ取得失敗:', error);
        // エラー時の表示
        var gauges = document.querySelectorAll('.wage-gauge[data-employee-id]');
        gauges.forEach(function(gauge) {
          var gaugeText = gauge.querySelector('.gauge-text');
          if (gaugeText) {
            gaugeText.innerHTML = 'エラー: 給与データの取得に失敗しました<br>' + error.message;
          }
        });
      });
  }

  // 個人の給与ゲージの読み込み（従業員のみ）
  function loadPersonalGauge() {
    // 読み込み状態を設定
    var gaugeText = document.querySelector('#personal-wage-gauge .gauge-text');
    if (gaugeText) {
      gaugeText.textContent = '読み込み中...';
    }
    
    // 個人の給与情報を取得
    fetch('/wages/api_wage_info?employee_id=' + currentEmployeeId)
      .then(response => response.json())
      .then(wageInfo => {
        updatePersonalWageGauge(wageInfo);
      })
      .catch(error => {
        console.error('給与情報取得エラー:', error);
        if (currentEmployeeId) { // 実際のIDが設定されている場合のみエラー表示
          document.querySelector('#personal-wage-gauge .gauge-text').textContent = 'エラーが発生しました';
        }
      });
  }

  // シフト情報の読み込み
  function loadShifts() {
    var container = document.getElementById('shift-calendar-container');
    container.innerHTML = '<p>シフト情報を読み込んでいます...</p>';
    
    fetch('<%= shifts_data_path %>')
      .then(response => response.json())
      .then(data => {
        initializeShifts(data);
      })
      .catch(error => {
        console.error('シフト情報取得エラー:', error);
        container.innerHTML = '<p>シフト情報の取得に失敗しました</p>';
      });
  }

  function initializeShifts(dataFromServer) {
    allShiftsData = dataFromServer;
    
    calendarYear = allShiftsData.year;
    calendarMonth = allShiftsData.month;
    daysInMonth = new Date(calendarYear, calendarMonth, 0).getDate();

    // 最初の表示範囲を設定
    var now = new Date();
    currentStartDate = new Date(now.getFullYear(), now.getMonth(), 1);
    
    updateCalendarTitle();
    displayShifts();
  }

  function updateCalendarTitle() {
    var title = document.getElementById('calendar-title');
    title.textContent = calendarYear + '年' + calendarMonth + '月';
  }

  function displayShifts() {
    var titleEl = document.getElementById('calendar-title');
    titleEl.textContent = calendarYear + '年' + calendarMonth + '月';
    
    var container = document.getElementById('shift-calendar-container');
    container.innerHTML = "";

    var table = document.createElement('table');
    table.className = 'shift-calendar';
    var thead = document.createElement('thead');
    var tbody = document.createElement('tbody');

    // ヘッダー行の生成
    var headerRow = document.createElement('tr');
    var nameHeader = document.createElement('th');
    nameHeader.textContent = '従業員名';
    headerRow.appendChild(nameHeader);
    
    var datesToShow = []; // 表示する日付の配列
    var currentDate = new Date(currentStartDate);
    for(var i = 0; i < 7; i++) {
        var day = currentDate.getDate();
        if (currentDate.getMonth() === currentStartDate.getMonth() && day <= daysInMonth) {
            datesToShow.push(day);
            var dayHeader = document.createElement('th');
            dayHeader.textContent = day + '日';
            headerRow.appendChild(dayHeader);
        }
        currentDate.setDate(currentDate.getDate() + 1);
    }
    thead.appendChild(headerRow);

    // ボディ行の生成
    for (var employeeId in allShiftsData.shifts) {
      var employeeData = allShiftsData.shifts[employeeId];
      var employeeRow = document.createElement('tr');
      var nameCell = document.createElement('td');
      nameCell.textContent = employeeData.name;
      employeeRow.appendChild(nameCell);

      datesToShow.forEach(function(day) {
        var shiftCell = document.createElement('td');
        var shiftTime = employeeData.shifts[day] || "";
        if (shiftTime) {
          // 自分のシフトのみクリック可能にする
          if (String(employeeId) === String(currentEmployeeId)) {
            shiftCell.style.cursor = 'pointer';
            shiftCell.style.textDecoration = 'underline';
            shiftCell.style.color = '#ffca28'; // 自分のシフトは黄色で強調
            shiftCell.onclick = function(id, d, time) {
              return function() {
                startRequestForShift(id, d, time);
              };
            }(employeeId, day, shiftTime);
          } else {
            // 他人のシフトはクリック不可
            shiftCell.style.cursor = 'default';
            shiftCell.style.color = '#999'; // グレーアウト
            shiftCell.title = '他の人のシフトはクリックできません';
          }
        }
        shiftCell.textContent = shiftTime;
        employeeRow.appendChild(shiftCell);
      });
      tbody.appendChild(employeeRow);
    }

    table.appendChild(thead);
    table.appendChild(tbody);
    container.appendChild(table);
    
    updatePaginationButtons();
  }
  
  function updatePaginationButtons() {
    var prevBtn = document.querySelector('.month-navigation .button:first-of-type');
    var nextBtn = document.querySelector('.month-navigation .button:last-of-type');

    // 1日が開始日なら「前へ」を無効化
    if (currentStartDate.getDate() === 1) {
        prevBtn.disabled = true;
        prevBtn.style.opacity = '0.5';
    } else {
        prevBtn.disabled = false;
        prevBtn.style.opacity = '1.0';
    }

    // 最終日が表示範囲に含まれるかチェック
    var lastDayOfDisplayedPeriod = currentStartDate.getDate() + 6;
    
    if (lastDayOfDisplayedPeriod >= daysInMonth) {
        nextBtn.disabled = true;
        nextBtn.style.opacity = '0.5';
    } else {
        nextBtn.disabled = false;
        nextBtn.style.opacity = '1.0';
    }
  }

  function prevWeek() {
    if (currentStartDate.getDate() > 1) {
        currentStartDate.setDate(currentStartDate.getDate() - 7);
        displayShifts();
    }
  }

  function nextWeek() {
    var nextWeekStart = new Date(currentStartDate);
    nextWeekStart.setDate(currentStartDate.getDate() + 7);
    
    // 次の週の開始日が月の最終日を超えていないかチェック
    if (nextWeekStart.getMonth() === currentStartDate.getMonth()) {
      currentStartDate = nextWeekStart;
      displayShifts();
    } else {
      // 最終日を含む週に移動
      var lastDayOfCurrentMonth = new Date(currentStartDate.getFullYear(), currentStartDate.getMonth() + 1, 0);
      currentStartDate = new Date(currentStartDate.getFullYear(), currentStartDate.getMonth(), lastDayOfCurrentMonth.getDate() - (lastDayOfCurrentMonth.getDate() % 7) + 1);
      if (currentStartDate.getDate() > lastDayOfCurrentMonth.getDate()) {
        currentStartDate.setDate(lastDayOfCurrentMonth.getDate() - 6);
      }
      displayShifts();
    }
  }

  function startRequestForShift(employeeId, day, timeString) {
    // 自分のシフトかどうか再確認
    if (String(employeeId) !== String(currentEmployeeId)) {
      if (window.messageHandler) {
        window.messageHandler.show("他の人のシフトはクリックできません。自分のシフトのみ交代依頼が可能です。", "warning");
      } else {
        alert("他の人のシフトはクリックできません。");
      }
      return;
    }
    
    var times = timeString.split('-');
    var startTime = times[0].padStart(2, '0') + ':00';
    var endTime = times[1].padStart(2, '0') + ':00';
    
    var monthStr = String(calendarMonth).padStart(2, '0');
    var dayStr = String(day).padStart(2, '0');
    var dateStr = calendarYear + '-' + monthStr + '-' + dayStr;

    var baseUrl = '<%= new_shift_request_path %>';
    var params = '?applicant_id=' + encodeURIComponent(employeeId) +
                '&date=' + encodeURIComponent(dateStr) +
                '&start=' + encodeURIComponent(startTime) +
                '&end=' + encodeURIComponent(endTime);
    window.location.href = baseUrl + params;
  }

  // ナビゲーション関数
  function goToRequestList() {
    window.location.href = '<%= shift_approvals_path %>';
  }

  function goToShiftAddForm() {
    window.location.href = '<%= new_shift_addition_path %>';
  }

  // 個人の給与ゲージの更新
  function updatePersonalWageGauge(wageInfo) {
    var gaugeElement = document.getElementById('personal-wage-gauge');
    if (!gaugeElement) return;
    
    var gaugeFill = gaugeElement.querySelector('.gauge-fill');
    var gaugeText = gaugeElement.querySelector('.gauge-text');
    
    if (!wageInfo || wageInfo.wage === undefined || wageInfo.target === undefined) {
      gaugeText.textContent = 'データがありません';
      return;
    }
    
    var percentage = Math.min(wageInfo.percentage, 100);
    var wageFormatted = (wageInfo.wage / 10000).toFixed(1) + '万円';
    var targetFormatted = (wageInfo.target / 10000).toFixed(0) + '万円';
    
    // ゲージの幅を更新
    gaugeFill.style.width = percentage + '%';
    
    // 色を更新（GASと同じロジック）
    if (percentage >= 100) {
      gaugeFill.style.backgroundColor = '#ff4444'; // 赤
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>🎉 目標達成！';
    } else if (percentage >= 80) {
      gaugeFill.style.backgroundColor = '#ffaa44'; // オレンジ
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>あと' + ((wageInfo.target - wageInfo.wage) / 10000).toFixed(1) + '万円';
    } else {
      gaugeFill.style.backgroundColor = '#44ff44'; // 緑
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>あと' + ((wageInfo.target - wageInfo.wage) / 10000).toFixed(1) + '万円';
    }
  }

  // 給与ゲージの更新（従業員指定）
  function updateWageGaugeForEmployee(employeeId, wageInfo) {
    var gaugeElement = document.querySelector('.wage-gauge[data-employee-id="' + employeeId + '"]');
    if (!gaugeElement) {
      return;
    }

    var gaugeFill = gaugeElement.querySelector('.gauge-fill');
    var gaugeText = gaugeElement.querySelector('.gauge-text');
    
    var percentage = Math.min(wageInfo.percentage, 100);
    var wageFormatted = (wageInfo.wage / 10000).toFixed(1) + '万円';
    var targetFormatted = (wageInfo.target / 10000).toFixed(0) + '万円';
    
    // ゲージの幅を更新
    gaugeFill.style.width = percentage + '%';
    
    // 色を更新（GASと同じロジック）
    if (percentage >= 100) {
      gaugeFill.style.backgroundColor = '#ff4444'; // 赤
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>🎉 目標達成！';
    } else if (percentage >= 80) {
      gaugeFill.style.backgroundColor = '#ffaa44'; // オレンジ
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>あと' + ((wageInfo.target - wageInfo.wage) / 10000).toFixed(1) + '万円';
    } else {
      gaugeFill.style.backgroundColor = '#44ff44'; // 緑
      gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>あと' + ((wageInfo.target - wageInfo.wage) / 10000).toFixed(1) + '万円';
    }
  }
  
  // メッセージ表示
  function showMessage(message, type) {
    var messageDiv = document.getElementById('message');
    messageDiv.textContent = message;
    messageDiv.className = 'message ' + type;
    messageDiv.style.display = 'block';
    
    // 3秒後にメッセージを非表示
    setTimeout(function() {
      messageDiv.style.display = 'none';
    }, 3000);
  }
</script>

<style>
  /* ===== 給与ゲージ（GAS互換） ===== */
  .wage-gauge {
    padding: 6px;
    background-color: #4a4a4a;
    border-radius: 6px;
    margin: 3px 0;
  }

  .gauge-container {
    text-align: center;
  }

  .gauge-bar {
    width: 100%;
    height: 16px;
    background-color: #333;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 6px;
    border: 1px solid #777;
  }

  .gauge-fill {
    height: 100%;
    background-color: #44ff44;
    transition: width 0.5s ease, background-color 0.3s ease;
    border-radius: 8px;
  }

  .gauge-text {
    font-size: 0.8em;
    color: #f0f0f0;
    line-height: 1.3;
  }

  /* オーナーモードと従業員モードの表示制御 */
  .owner-mode #personal-gauge-section {
    display: none;
  }

  .employee-mode #employee-list-section {
    display: none;
  }

  /* 従業員一覧テーブル */
  .employee-list {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background-color: #2c2c2c;
    border-radius: 8px;
    overflow: hidden;
  }

  .employee-list th,
  .employee-list td {
    padding: 12px;
    text-align: left;
    border: 1px solid #444;
  }

  .employee-list th {
    background-color: #3c3c3c;
    color: #f0f0f0;
    font-weight: bold;
    border-bottom: 2px solid #555;
  }

  .employee-list td {
    background-color: #2c2c2c;
    color: #f0f0f0;
  }

  .employee-list tr:nth-child(even) td {
    background-color: #333;
  }
</style>