<div class="form-container">
  <h1>初回パスワード設定</h1>
  <p class="form-description">メールアドレスに送信された認証コードを入力してください。</p>

  <%= form_with url: verify_initial_code_path, method: :post, local: true, id: "verification-form" do |form| %>
    <%= form.hidden_field :employee_id, value: @employee_id %>

    <div class="form-group">
      <div class="form-row">
        <label for="verification-code" class="form-label">認証コード:</label>
        <%= form.text_field :verification_code,
            placeholder: "6桁の認証コードを入力",
            required: true,
            id: "verification-code",
            maxlength: 6,
            pattern: "[0-9]{6}",
            class: "form-input" %>
      </div>
    </div>

    <div class="form-buttons">
      <%= form.submit "認証", class: "form-button" %>
      <%= link_to "戻る", password_initial_path, class: "form-button secondary" %>
    </div>
  <% end %>

  <div class="login-links">
    <%= link_to "ログイン画面に戻る", login_path, class: "link" %>
  </div>
</div>

<script>
  // ページ読み込み時の初期化
  document.addEventListener('DOMContentLoaded', function() {
    const verificationCodeInput = document.getElementById('verification-code');

    // 認証コードの入力制限（数字のみ）
    if (verificationCodeInput) {
      verificationCodeInput.addEventListener('input', function(e) {
        // 数字以外を除去
        e.target.value = e.target.value.replace(/[^0-9]/g, '');

        // 6桁を超えた場合は切り詰め
        if (e.target.value.length > 6) {
          e.target.value = e.target.value.substring(0, 6);
        }
      });

      // フォーカス時の全選択
      verificationCodeInput.addEventListener('focus', function(e) {
        e.target.select();
      });
    }

    // フォーム送信時のバリデーション
    const form = document.getElementById('verification-form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const verificationCode = verificationCodeInput.value.trim();

        if (verificationCode.length !== 6) {
          e.preventDefault();
          if (window.messageHandler) {
            window.messageHandler.show('認証コードは6桁で入力してください。', 'error');
          } else {
            alert('認証コードは6桁で入力してください。');
          }
          verificationCodeInput.focus();
          return false;
        }

        if (!/^[0-9]{6}$/.test(verificationCode)) {
          e.preventDefault();
          if (window.messageHandler) {
            window.messageHandler.show('認証コードは数字のみで入力してください。', 'error');
          } else {
            alert('認証コードは数字のみで入力してください。');
          }
          verificationCodeInput.focus();
          return false;
        }
      });
    }
  });
</script>
