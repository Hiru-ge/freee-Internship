<div class="container">
  <div class="password-change-section">
    <h2>パスワード変更</h2>
    <p>現在のパスワードを入力し、新しいパスワードを設定してください。</p>
    
    <%= form_with url: auth_password_change_path, method: :post, local: true, id: "password-change-form" do |form| %>
      <div class="form-group">
        <%= form.label :current_password, "現在のパスワード:" %>
        <%= form.password_field :current_password, required: true, id: "current-password" %>
      </div>
      
      <div class="form-group">
        <%= form.label :new_password, "新しいパスワード:" %>
        <%= form.password_field :new_password, required: true, id: "new-password" %>
        <div class="password-requirements">
          <small>パスワード要件:</small>
          <ul>
            <li>8文字以上</li>
            <li>英字と数字を含む</li>
            <li>特殊文字を含む（推奨）</li>
          </ul>
        </div>
      </div>
      
      <div class="form-group">
        <%= form.label :confirm_password, "パスワード（確認）:" %>
        <%= form.password_field :confirm_password, required: true, id: "confirm-password" %>
      </div>
      
      <div class="form-actions">
        <%= form.submit "パスワードを変更", class: "button primary" %>
        <%= link_to "マイページに戻る", dashboard_path, class: "button secondary" %>
      </div>
    <% end %>
    
    <div class="logout-section">
      <%= form_with url: logout_auth_path, method: :post, local: true, class: "logout-form" do |form| %>
        <%= form.submit "ログアウト", class: "button logout" %>
      <% end %>
    </div>
    
    <% if flash[:alert] %>
      <div class="message error">
        <%= flash[:alert] %>
      </div>
    <% end %>
    
    <% if flash[:notice] %>
      <div class="message success">
        <%= flash[:notice] %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // ページ読み込み時の初期化
  document.addEventListener('DOMContentLoaded', function() {
    setupFormHandler();
  });
  
  // フォームハンドラーの設定
  function setupFormHandler() {
    document.getElementById('password-change-form').addEventListener('submit', function(e) {
      var currentPassword = document.getElementById('current-password').value;
      var newPassword = document.getElementById('new-password').value;
      var confirmPassword = document.getElementById('confirm-password').value;
      
      if (!currentPassword) {
        e.preventDefault();
        showMessage('現在のパスワードを入力してください', 'error');
        return;
      }
      
      if (!newPassword) {
        e.preventDefault();
        showMessage('新しいパスワードを入力してください', 'error');
        return;
      }
      
      if (!validatePassword(newPassword)) {
        e.preventDefault();
        showMessage('パスワードが要件を満たしていません', 'error');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        e.preventDefault();
        showMessage('パスワードが一致しません', 'error');
        return;
      }
      
      // 送信ボタンを無効化
      var submitButton = document.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.textContent = '変更中...';
    });
  }
  
  // パスワードバリデーション
  function validatePassword(password) {
    if (password.length < 8) return false;
    if (!/[a-zA-Z]/.test(password)) return false;
    if (!/[0-9]/.test(password)) return false;
    return true;
  }
  
  // メッセージ表示
  function showMessage(message, type) {
    // 既存のメッセージを削除
    var existingMessage = document.querySelector('.message');
    if (existingMessage) {
      existingMessage.remove();
    }
    
    // 新しいメッセージを作成
    var messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + type;
    messageDiv.textContent = message;
    
    // フォームの後に挿入
    var form = document.getElementById('password-change-form');
    form.parentNode.insertBefore(messageDiv, form.nextSibling);
  }
</script>