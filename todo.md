# 勤怠管理システム - タスク管理

## 概要
勤怠管理チェックアプリのタスク管理一覧です。
現在の基本機能は実装完了しており、以下の項目は今後の改善・拡張として管理しています。

---

## 完了済みフェーズ（要約）

### 基盤構築・移行（Phase 1-5）
- [x] **Rails基盤構築**: アプリケーション基盤、データベース設計
- [x] **既存機能完全移行**: 認証、シフト管理、給与管理、ダッシュボード
- [x] **統合・最適化**: UI/UX統一、バックグラウンド処理
- [x] **UX改善**: ユーザビリティ向上、情報設計最適化

### セキュリティ・デプロイ（Phase 6-8）
- [x] **セキュリティ強化**: セッション管理、入力値検証、データベースセキュリティ
- [x] **機能修正・安定性向上**: 不具合修正、パフォーマンス最適化
- [x] **本番環境構築・デプロイ**: Fly.io移行、運用準備

### LINE Bot機能（Phase 9-12）
- [x] **LINE Bot基盤**: 接続テスト、基本機能実装
- [x] **シフト交代・追加機能**: リクエスト処理、承認・否認機能
- [x] **責務分離・リファクタリング**: アーキテクチャ改善、テスト修復

### 最新機能（Phase 10-13）
- [x] **打刻忘れアラート**: 自動検知・通知システム
- [x] **統合通知サービス**: メール・LINE通知の統合
- [x] **共通サービス**: ShiftExchangeService、ShiftAdditionService
- [x] **バックエンド処理統合**: WebとLINEの共通処理統合

### テスト・品質改善（Phase 15）
- [x] **サービス統合**: 29サービス → 15サービス（48%削減）
- [x] **テストファイル整理**: 重複テスト統合、責任分離違反修正
- [x] **ディレクトリ構造整理**: 適切なレイヤー配置、空ディレクトリ削除
- [x] **テスト品質向上**: 475テスト、1,191アサーション、100%通過率

---

## 現在進行中・計画中

### Phase 14: アプリケーション改善・最適化
**優先度**: 🔴 高 | **見積時間**: 25時間

#### Phase 14-1: LINE Bot文言変更と不要機能削除
- [x] 現在のLINE Botメッセージの見直し
- [x] ユーザビリティ向上のための文言改善
- [x] 不要な機能・メッセージの削除
- [x] メッセージテンプレートの最適化
- [x] 従業員名入力方法の統一（半角なし、部分検索アリ）

#### Phase 14-2: 機能見直しとユーザビリティ向上
- [x] コマンド名の統一と明確化
- [x] 従業員名検索の柔軟性向上
- [x] 絵文字使用の最適化
- [x] ヘルプメッセージの統一
- [x] グループ・個人チャット制限の見直し

#### Phase 14-3: リファクタリング（共通化）
- [x] 従業員検索ロジックの統一
- [x] メッセージ生成の統一
- [x] バリデーション処理の統一
- [x] Flex Message生成の統一
- [x] 共通化サービスの作成

#### Phase 14-4: 実装クリーンアップ
- [x] WebhookControllerの冗長な分岐削除
- [x] LineBotServiceの重複メソッド統合
- [x] 個人・グループメッセージ処理の統一
- [x] テストの安定性確保
- [x] ドキュメント整備

#### Phase 14-5: アクセス制限機能実装
- [x] 特定メールアドレスからのみアクセス可能にする機能
- [x] トップページでのアクセス制限実装
- [x] 認証前のメールアドレスチェック機能
- [x] アクセス拒否時の適切なメッセージ表示

#### Phase 14-6: 欠勤（シフト削除）申請機能実装
- [x] 欠勤申請のデータベース設計（ShiftDeletionモデル、マイグレーション）
- [x] 欠勤申請フォームの実装（シフト選択式、未来のシフトのみ）
- [x] 承認・否認機能の実装（オーナー権限チェック）
- [x] 通知機能の実装（メール通知のみ、LINE通知無効化）
- [x] シフトページからの遷移機能（管理ボタンエリアに配置）
- [x] 既存パターンとの統合とリファクタリング（TDD実装）
- [x] UI/UX改善（テキストエリア拡大、セレクトボックス幅調整）
- [x] メールテンプレート統一（既存デザインパターンに準拠）

#### Phase 14-7: 欠勤申請機能のLINE連携実装
- [x] LineShiftDeletionServiceのTDD実装（Red → Green → Refactor）
- [x] 欠勤申請コマンドの追加（「欠勤申請」）
- [x] シフト選択機能の実装（Flex Message形式）
- [x] 欠勤理由入力機能の実装
- [x] 承認・拒否機能のLINE連携実装
- [x] 会話状態管理の実装
- [x] テストの実装と動作確認
- [x] ドキュメントの更新

#### Phase 14-8: UX改善実装完了
- [x] セレクトボックスの幅が狭くて項目が収まりきっていない問題を調査・修正
- [x] シフト表の最後のページも7日分表示されるように変更
- [x] 最初にシフト表ページを出した時、今日の日付を含むセクションが表示されるように変更
- [x] ドキュメント整備（CHANGELOG.md、VIEW_SPEC.md、USER_GUIDE.mdの更新）

#### Phase 14-9: アプリケーション全体の粗探し
- [x] セキュリティ脆弱性のチェック
- [x] パフォーマンス問題の特定
- [x] ユーザビリティ問題の洗い出し
- [x] コード品質の改善点特定
- [x] エラーハンドリングの改善
- [x] 高優先度の改善項目の実装（XSS脆弱性修正、重複メソッド削除、パフォーマンス最適化、ユーザビリティ向上、エラーハンドリング統一）

#### Phase 14-10: アプリケーション利用ドキュメント整備
- [x] ユーザーマニュアルの作成
- [x] トラブルシューティングガイドの作成
- [x] FAQの作成
- [x] 動画マニュアルの検討

#### Phase 14-11: 企画書の整備
- [x] プロジェクト企画書の作成・更新
- [x] 機能仕様書の整備
- [x] 技術仕様書の整備
- [x] 運用計画書の作成
- [x] 成果物の整理・まとめ

---

## 現在進行中・計画中

### Phase 16: アプリケーション本体リファクタリング
**優先度**: 🔴 高 | **目的**: 可読性向上・コード理解促進

KISS原則を厳守し、過剰に複雑な実装にしてしまう「逆リファクタリング」とならないように注意

#### Phase 16-1: コントローラーファイル統合・分離と適切な共通化（優先度: 🔴 高）

**目標**: コントローラーの責任範囲を明確化し、透明性と保守性を向上させる

**最終的なコントローラー構成**:
```
1. 基底（ApplicationController）
2. 共通機能ディレクトリ（concerns/）
3. 勤怠打刻（AttendanceController）
4. 勤怠リマインダー（ClockReminderController）
5. シフト表示（ShiftDisplayController）
6. シフト交代（ShiftExchangesController）
7. シフト追加（ShiftAdditionsController）
8. シフト削除（ShiftDeletionsController）
9. シフト承認（ShiftApprovalsController）
10. 給与（WagesController）
11. 認証・アクセス制御（AuthController + AccessControlController）
12. LINEbot（WebhookController）
```

**タスク**:
- [x] ApplicationControllerの分割（認証・セッション・エラーハンドリングをConcernに分離）
- [x] 各Concernの責任範囲明確化
- [x] サービス間依存関係の可視化
- [x] DashboardControllerの分割（勤怠打刻機能をAttendanceControllerに分離）
- [x] ShiftDisplayControllerの整理（給与・従業員機能の分離）
- [x] コントローラー命名の統一（透明性向上）
- [x] 重複コードの統合（FreeeApiServiceインスタンス化の共通化）
- [x] マジックナンバー・文字列の外部化（セッションタイムアウト、認証コード長等）
- [x] InputValidationの共通化（7つのコントローラーで使用）
- [x] ErrorHandlerの共通化（3つのコントローラーで使用、完全共通化はPhase 16-2で実施）
- [x] 最終的なコントローラー構成への統合・分離（EmployeesController削除、DashboardController削除）
- [x] 不要なコントローラーの削除（home_controller.rb、api/shift_requests_controller.rb）
- [x] AuthControllerとAccessControlControllerの統合
- [x] ShiftsControllerをShiftDisplayControllerにリネーム
- [x] テスト通過率100%の達成（認証フローの修正）
- [x] ドキュメント整備（現状を正しく反映した内容に修正）

#### Phase 16-2: コード品質改善（優先度: 🔴 高）
- [x] 共通化すべき箇所の特定と分析
- [x] 共通化Concernの作成（Authorization、FreeeApiHelper、ServiceResponseHandler）
- [x] コントローラーへの共通化適用（ShiftApprovals、ShiftExchanges、ShiftAdditions、ShiftDeletions、Wages）
- [x] テスト通過率100%の達成
- [x] Concernの粒度見直しと統合・再配置
- [x] 古いコントローラー参照の修正とドキュメント更新
- [x] Concern内メソッドの適切な配置場所への再配置
- [x] ドキュメント整備（Concern再配置とメソッド配置の反映）

#### Phase 16-3: 保守性向上（優先度: 🔴 高）
- [x] 長いメソッドの特定と改善案の分析
- [x] 可読性向上のためのリファクタリング（既存構造維持）
- [x] 長いファイルの分割（InputValidation、AuthController、Authentication Concern）
  - [x] InputValidation の分割（基本バリデーション + Security.rb内セキュリティバリデーション） - 分割不要と判断
  - [x] AuthController の分割（基本認証・アクセス制御 + PasswordController） - 分割不要と判断
  - [x] Authentication Concern の分割（基本認証・認可 + SessionManagement） - 分割不要と判断
- [x] バリデーションロジックの統合（各コントローラーでの重複処理の統合） - Phase 16-2で完了
- [x] セキュリティチェックの標準化（権限チェックロジックの統一） - Phase 16-2で完了
- [x] エラーメッセージの統一（エラーレスポンス形式の標準化） - Phase 16-2で完了
- [x] ErrorHandlerの完全共通化（全コントローラーでの使用） - Phase 16-2で完了

**完了内容**:
- 全Concernとコントローラーファイルの可読性向上（過剰なコメントの削除、自然な定義順の整理）
- メソッドの分割、重複コードの共通化、一貫性のあるスタイルの適用
- ファイル分割の必要性再評価（KISS原則に基づく判断により分割不要と結論）
- 現在の構造が最適（各ファイルが適切な責任範囲と長さを維持）

#### Phase 16-4: サービス層リファクタリング（完了）
**目標**: サービスファイルの可読性向上と責任範囲の明確化

**対象ファイル（15個）**:
- **長いファイル**: `line_shift_management_service.rb` (967行), `line_message_service.rb` (751行), `notification_service.rb` (634行)
- **中程度**: `line_utility_service.rb` (571行), `line_validation_service.rb` (467行), `auth_service.rb` (396行)
- **その他**: 9個のサービスファイル

**統合・分割計画**:
1. **LINE Bot関連サービスの再構成** → Web側と統一感のある構成 (5ファイル → 5ファイル)
   - `LineBotService` (基礎機能・バリデーション・状態管理) ← `line_bot_service.rb` + `line_utility_service.rb` + `line_validation_service.rb`
   - `LineShiftExchangeService` (シフト交代) ← `line_shift_management_service.rb` の交代部分
   - `LineShiftAdditionService` (シフト追加) ← `line_shift_management_service.rb` の追加部分
   - `LineShiftDeletionService` (シフト削除) ← `line_shift_management_service.rb` の削除部分
   - `LineShiftDisplayService` (シフト表示) ← `line_shift_management_service.rb` の表示部分 + `line_message_service.rb`

2. **通知サービスの簡素化** → `EmailNotificationService` (1ファイル)
   - `notification_service.rb` (634行) → メール通知のみに簡素化
   - LINE通知関連の不要なコードを削除

3. **AuthServiceの統合維持** → 現状維持
   - コントローラーとの粒度を合わせて1ファイルで管理

**完了内容**:
- [x] LINE Bot関連サービスの再構成（Web側と統一感のある構成）
  - [x] `LineBotService` の作成（基礎機能・バリデーション・状態管理）
  - [x] `LineShiftExchangeService` の作成（シフト交代）
  - [x] `LineShiftAdditionService` の作成（シフト追加）
  - [x] `LineShiftDeletionService` の作成（シフト削除）
  - [x] `LineShiftDisplayService` の作成（シフト表示）
- [x] 通知サービスの簡素化（LINE通知関連の削除、メール通知のみに）
- [x] 重複メソッドの統合（LineBotService内の4組の重複メソッドを統合）
- [x] 削除されたテストファイルの復元・統合（適切なサービスに分散・統合）
- [x] テスト通過率100%の達成（436テスト中436テスト通過）

**完了内容（残存タスク）**:
- [x] 全サービスファイルの可読性向上（過剰なコメントの削除、自然な定義順の整理）
- [x] メソッドの分割と共通化（重複コードの統合）
- [x] 一貫性のあるスタイルの適用（命名規則、インデント、空行の統一）

#### Phase 16-5: モデル・ヘルパー・Mailerリファクタリング（完了）
**目標**: モデル、ヘルパー、Mailerファイルの可読性向上と責任範囲の明確化

**対象ファイル（23個）**:
- **モデル**: 11個（`password_validator.rb` 77行, `employee.rb` 59行等）
- **ヘルパー**: 0個（8個の空ファイルを削除）
- **Mailer**: 4個（`shift_mailer.rb` 112行, `auth_mailer.rb` 48行等）

**実行順序**:
1. **現状分析と可読性向上**（優先度: 🔴 高）
   - [x] 各モデル・ヘルパー・メイラーファイルの内容確認と現状分析
   - [x] 過剰なコメントの削除
   - [x] 自然な定義順の整理
   - [x] 一貫性のあるスタイルの適用

2. **Mailerファイルの可読性向上**（優先度: 🟡 中）
   - [x] `shift_mailer.rb` (121行) のテンプレート処理整理
   - [x] `auth_mailer.rb` (48行) のメール送信ロジック整理
   - [x] 一貫性のあるスタイルの適用

3. **ヘルパーファイルの統合検討**（優先度: 🟢 低）
   - [x] 8個の4行ファイルの重複機能分析
   - [x] 統合可能性の検討
   - [x] 必要に応じて統合実施（8個の空ファイルを削除）

4. **責任範囲の再評価と再構築**（優先度: 🟢 低）
   - [x] テーブルとモデルの対応関係の確認
   - [x] ビジネスロジックの適切な配置の検討
   - [x] モデル、サービス、Concernの責任分離の見直し
   - [x] 必要に応じて統合・分離の再構築（適切な分離のため現状維持）

#### Phase 16-6: 静的ファイル整理（優先度: 🟡 中）
**目標**: JavaScript、CSSファイルの整理と最適化

**対象ファイル（4個）**:
- **CSS**: `application.css` (1,835行)
- **JavaScript**: `loading_handler.js` (273行), `message_handler.js` (207行)
- **Service Worker**: `service-worker.js` (26行)

**タスク**:
- [x] CSSファイルの整理（重複スタイルの統合、構造化）
- [x] JavaScriptファイルの可読性向上（関数の分割、コメント整理）
- [x] 静的ファイルの最適化（不要なコードの削除）
- [x] 一貫性のあるスタイルの適用

#### Phase 16-7: 依存関係整理（優先度: 🟡 中）
- [ ] 依存関係の整理と可視化
- [ ] 循環依存の解消
- [ ] インターフェースの定義
- [ ] 設定管理の統一（設定ファイル統合、環境別設定整理）

#### Phase 16-8: テスト品質向上（優先度: 🟢 低）
- [ ] テストの重複削除
- [ ] テストヘルパーの共通化
- [ ] テストデータの統一
- [ ] エッジケースのテスト追加
- [ ] 複雑なロジックのテスト強化

#### Phase 16-9: セッション管理改善（優先度: 🟢 低）
- [ ] セッション設定の外部化
- [ ] セッション情報の暗号化強化
- [ ] セッションタイムアウトの動的設定

#### Phase 16-10: パフォーマンス最適化（優先度: 🟢 低）
- [ ] N+1クエリ問題の完全解決
- [ ] API呼び出しの最適化
- [ ] キャッシュ戦略の強化
- [ ] 重複呼び出しの削除

### 将来の改善項目
- **テストカバレッジ拡充**: 不足テストファイルの作成
- **パフォーマンス最適化**: データベースクエリの最適化
- **UI/UX改善**: ユーザビリティの継続的向上
- **セキュリティ強化**: 定期的なセキュリティ監査

---

## 実装状況サマリー

### 完了済み
- **総実装時間**: 約250時間
- **テスト数**: 475テスト（成功率100%）
- **主要機能**: 認証、シフト管理、給与管理、LINE Bot、通知システム
- **Phase 14**: アプリケーション改善・最適化完了
- **Phase 15**: サービス統合・テスト品質改善完了

### 現在の状況
- **品質**: アプリケーション全体の粗探しと改善完了
- **ドキュメント**: 利用ドキュメントと企画書の整備完了
- **テスト**: 責任分離違反修正、ディレクトリ構造整理完了
- **Phase 16**: アプリケーション本体リファクタリング進行中（Phase 16-4完了、残存タスク：可読性向上）

### 最新完了
- **Phase 15**: テスト・品質改善完了（サービス統合、テストファイル整理、責任分離違反修正）
- **Phase 16-1**: コントローラーファイル統合・分離と適切な共通化完了
- **Phase 16-2**: コード品質改善とConcern最適化完了
- **Phase 16-3**: 保守性向上（可読性向上とファイル構造最適化）完了
- **Phase 16-4**: サービス層リファクタリング完了（LINE Bot関連サービス再構成、通知サービス簡素化、重複メソッド統合、テストファイル復元・統合、可読性向上、定義順改善）
- **Phase 16-5**: モデル・ヘルパー・Mailerリファクタリング完了（可読性向上、ヘルパーファイル削除、責任範囲の明確化）

### 緊急修正完了
- **Line::Bot::Clientエラー修正**: line-bot-api gemのバージョンダウングレード（2.2.0 → 1.20.0）
- **シフト交代リクエスト機能復旧**: リファクタリング後のサービス統合で発生した問題を解決
- **シフト追加リクエスト機能復旧**: ShiftOverlapService → ShiftDisplayServiceへの修正
- **サービス統合による潜在的問題修正**: ClockReminderService → ClockServiceへの修正（rakeタスク）
- **不要テストファイル削除**: LineShiftDeletionServiceのテストファイル削除（統合済み）
