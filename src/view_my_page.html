<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
</head>
<body>
  <div class="my-page-container">
    <h1>マイページ</h1>
    
    <!-- ユーザー情報 -->
    <div class="user-info">
      <span id="user-name">読み込み中...</span>
      <span id="user-role">読み込み中...</span>
    </div>

    <!-- 打刻機能 -->
    <div class="time-clock-section">
      <h3>勤怠打刻</h3>
      <div class="time-clock-buttons">
        <button id="clock-in-btn" class="button clock-in" onclick="clockIn()">出勤打刻</button>
        <button id="clock-out-btn" class="button clock-out" onclick="clockOut()">退勤打刻</button>
      </div>
      <div id="clock-status" class="clock-status"></div>
    </div>

    <!-- 勤怠履歴 -->
    <div class="attendance-history-section">
      <h3 id="attendance-title">勤怠履歴
        <span class="month-navigation-buttons">
          <button class="button" onclick="prevMonth()">前月</button>
          <button class="button" onclick="nextMonth()">次月</button>
        </span>
      </h3>
      <div id="attendance-container">
        <p>勤怠履歴を読み込んでいます...</p>
      </div>
    </div>

    <!-- ナビゲーション -->
    <div class="navigation">
      <button class="button nav-button" onclick="goToShiftPage()">シフトページ</button>
              <button class="button nav-button" onclick="goToAuthSettings()">パスワード変更</button>
      <button class="button nav-button logout" onclick="logout()">ログアウト</button>
    </div>

    <!-- メッセージ表示 -->
    <div id="message" class="message" style="display: none;"></div>
  </div>

  <script>
    var currentEmployeeId = null;
    var currentEmployeeName = null;
    
    // 勤怠履歴の変数（既存コンポーネントから）
    var attendanceYear;
    var attendanceMonth;
    var allAttendanceData;

    // ページ読み込み時の初期化
    document.addEventListener('DOMContentLoaded', function() {
      loadUserInfo();
      // 勤怠履歴の初期化はloadUserInfoの成功後に実行
      updateClockButtons();
    });

    // ユーザー情報の読み込み
    function loadUserInfo() {
      google.script.run
        .withSuccessHandler(function(employeeId) {
          if (employeeId) {
            currentEmployeeId = employeeId;
            google.script.run
              .withSuccessHandler(function(employees) {
                var employee = employees.find(function(emp) {
                  return emp.id == employeeId;
                });
                if (employee) {
                  currentEmployeeName = employee.display_name;
                  document.getElementById('user-name').textContent = employee.display_name;
                  
                  // 権限の表示
                  google.script.run
                    .withSuccessHandler(function(isOwner) {
                      document.getElementById('user-role').textContent = isOwner ? 'オーナー' : '従業員';
                      // ユーザー情報読み込み完了後に勤怠履歴を初期化
                      initializeAttendanceHistory();
                    })
                    .isOwner(employeeId);
                }
              })
              .getEmployees();
          }
        })
        .getSelectedEmployeeId();
    }

    // 勤怠履歴の初期化（既存コンポーネントから）
    function initializeAttendanceHistory() {
      // 従業員IDを取得
      currentEmployeeId = getCurrentEmployeeId();
      if (!currentEmployeeId) {
        showAttendanceError('従業員IDが取得できません');
        return;
      }

      // 現在の年月を設定
      var now = new Date();
      attendanceYear = now.getFullYear();
      attendanceMonth = now.getMonth() + 1;
      
      // 勤怠履歴を読み込み
      loadAttendanceData();
    }

    // 現在の従業員IDを取得
    function getCurrentEmployeeId() {
      console.log('従業員ID取得を開始...');
      
      // サーバーサイドから取得を試行
      try {
        console.log('サーバーサイドから取得を試行...');
        var selectedEmpId = google.script.run.getSelectedEmployeeId();
        console.log('サーバーサイドから取得:', selectedEmpId);
        if (selectedEmpId) {
          console.log('サーバーサイドで従業員ID取得成功:', selectedEmpId);
          return selectedEmpId;
        }
      } catch (e) {
        console.log('サーバーサイド取得でエラー:', e);
      }

      // フォールバック: デフォルトの従業員IDを使用（店長 太郎）
      console.log('フォールバック: デフォルトの従業員IDを使用');
      return '3313254'; // 店長 太郎のID
    }

    // 勤怠データを読み込み（既存コンポーネントから）
    function loadAttendanceData() {
      var yearMonth = attendanceYear + '-' + String(attendanceMonth).padStart(2, '0');
      console.log('勤怠データ読み込み開始...');
      console.log('従業員ID:', currentEmployeeId);
      console.log('年月:', yearMonth);
      
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('勤怠データ取得成功:', data);
          displayAttendanceData(data);
        })
        .withFailureHandler(function(error) {
          console.log('勤怠データ取得失敗:', error);
          showAttendanceError('勤怠データの取得に失敗しました: ' + error.message);
        })
        .getTimeClocksForMonth(currentEmployeeId, yearMonth);
    }

    // 勤怠データを表示（既存コンポーネントから）
    function displayAttendanceData(dataJson) {
      try {
        var records = JSON.parse(dataJson);
        var container = document.getElementById('attendance-container');
        var title = document.getElementById('attendance-title');
        
        // タイトルを更新（ページネーションボタンを保持）
        title.innerHTML = attendanceYear + '年' + attendanceMonth + '月の勤怠履歴' +
          '<span class="month-navigation-buttons">' +
          '<button class="button" onclick="prevMonth()">前月</button>' +
          '<button class="button" onclick="nextMonth()">次月</button>' +
          '</span>';
        
        // テーブルを生成
        var html = '<table border="1">';
        html += '<thead><tr><th>種別</th><th>日時</th></tr></thead>';
        html += '<tbody>';
        
        if (!records || records.length === 0) {
          // データがない場合は空の行を表示
          html += '<tr><td colspan="2" style="text-align: center; padding: 40px; color: #999;">この月の勤怠記録がありません</td></tr>';
        } else {
          for (var i = 0; i < records.length; i++) {
            var record = records[i];
            html += '<tr>';
            html += '<td>' + record.type + '</td>';
            html += '<td>' + record.date + '</td>';
            html += '</tr>';
          }
        }
        
        html += '</tbody></table>';
        container.innerHTML = html;
        
      } catch (error) {
        showAttendanceError('勤怠データの表示に失敗しました: ' + error.message);
      }
    }

    // 前の月に移動（既存コンポーネントから）
    function prevMonth() {
      attendanceMonth--;
      if (attendanceMonth < 1) {
        attendanceMonth = 12;
        attendanceYear--;
      }
      loadAttendanceData();
    }

    // 次の月に移動（既存コンポーネントから）
    function nextMonth() {
      attendanceMonth++;
      if (attendanceMonth > 12) {
        attendanceMonth = 1;
        attendanceYear++;
      }
      loadAttendanceData();
    }

    // 勤怠エラー表示（既存コンポーネントから）
    function showAttendanceError(message) {
      var container = document.getElementById('attendance-container');
      container.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">' + message + '</p>';
    }

    // 打刻ボタンの状態更新
    function updateClockButtons() {
      if (!currentEmployeeId) return;
      
      google.script.run
        .withSuccessHandler(function(clockStatus) {
          var clockInBtn = document.getElementById('clock-in-btn');
          var clockOutBtn = document.getElementById('clock-out-btn');
          var statusDiv = document.getElementById('clock-status');
          
          if (clockStatus.canClockIn) {
            clockInBtn.disabled = false;
            clockInBtn.textContent = '出勤打刻';
          } else {
            clockInBtn.disabled = true;
            clockInBtn.textContent = '出勤済み';
          }
          
          if (clockStatus.canClockOut) {
            clockOutBtn.disabled = false;
            clockOutBtn.textContent = '退勤打刻';
          } else {
            clockOutBtn.disabled = true;
            clockOutBtn.textContent = '退勤済み';
          }
          
          if (clockStatus.message) {
            statusDiv.textContent = clockStatus.message;
            statusDiv.style.display = 'block';
          } else {
            statusDiv.style.display = 'none';
          }
        })
        .withFailureHandler(function(error) {
          console.error('打刻状態取得エラー:', error);
        })
        .getClockStatus(currentEmployeeId);
    }

    // 出勤打刻
    function clockIn() {
      if (!currentEmployeeId) return;
      
      google.script.run
        .withSuccessHandler(function(result) {
          showMessage(result.message, result.success ? 'success' : 'error');
          if (result.success) {
            updateClockButtons();
            loadAttendanceData();
          }
        })
        .withFailureHandler(function(error) {
          console.error('出勤打刻エラー:', error);
          showMessage('出勤打刻中にエラーが発生しました', 'error');
        })
        .clockIn(currentEmployeeId);
    }

    // 退勤打刻
    function clockOut() {
      if (!currentEmployeeId) return;
      
      google.script.run
        .withSuccessHandler(function(result) {
          showMessage(result.message, result.success ? 'success' : 'error');
          if (result.success) {
            updateClockButtons();
            loadAttendanceData();
          }
        })
        .withFailureHandler(function(error) {
          console.error('退勤打刻エラー:', error);
          showMessage('退勤打刻中にエラーが発生しました', 'error');
        })
        .clockOut(currentEmployeeId);
    }

    // ナビゲーション関数
    function goToShiftPage() {
      window.top.location.href = '<?= getAppUrl() ?>?page=shift_page';
    }


    function goToAuthSettings() {
      window.top.location.href = '<?= getAppUrl() ?>?page=password_change';
    }

    function logout() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            window.top.location.href = '<?= getAppUrl() ?>?page=login';
          } else {
            showMessage(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ログアウトエラー:', error);
          showMessage('ログアウト中にエラーが発生しました', 'error');
        })
        .logout();
    }

    // メッセージ表示
    function showMessage(message, type) {
      var messageDiv = document.getElementById('message');
      messageDiv.textContent = message;
      messageDiv.className = 'message ' + type;
      messageDiv.style.display = 'block';
      
      // 3秒後にメッセージを非表示
      setTimeout(function() {
        messageDiv.style.display = 'none';
      }, 3000);
    }
  </script>

  <style>
    .my-page-container {
      margin: 10px;
      padding: 10px;
    }

    .my-page-container h1 {
      color: #ffca28;
      margin: 0 0 10px 0;
      font-size: 1.5em;
    }

    .user-info {
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .user-info span {
      color: #f0f0f0;
      font-size: 1.1em;
    }

    .user-info #user-role {
      color: #ffca28;
    }

    .time-clock-section, .attendance-history-section {
      margin-bottom: 15px;
    }

    .time-clock-section h3, .attendance-history-section h3 {
      color: #f0f0f0;
      margin: 0 0 8px 0;
      font-size: 1.1em;
    }

    .time-clock-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      justify-content: flex-start;
    }

    .time-clock-buttons .button {
      width: 140px;
      height: 60px;
      padding: 10px;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .clock-in {
      background-color: #4caf50;
    }

    .clock-out {
      background-color: #f44336;
    }

    .clock-status {
      color: #f0f0f0;
      font-size: 12px;
    }

    .month-navigation-buttons {
      display: inline-flex;
      gap: 5px;
      margin-left: 10px;
    }

    .month-navigation-buttons .button {
      padding: 6px 12px;
      font-size: 12px;
      height: auto;
      width: auto;
    }

    .attendance-history-section table {
      width: 100%;
      border-collapse: collapse;
      background-color: #555;
    }

    .attendance-history-section th, 
    .attendance-history-section td {
      border: 1px solid #777;
      padding: 4px;
      text-align: left;
      color: #f0f0f0;
      font-size: 12px;
    }

    .attendance-history-section th {
      background-color: #666;
      font-weight: bold;
    }

    .navigation {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }

    .nav-button {
      padding: 8px 12px;
      font-size: 12px;
    }

    .nav-button.logout {
      background-color: #666;
    }

    .nav-button.logout:hover {
      background-color: #777;
    }

    .message {
      margin-top: 10px;
      padding: 8px;
      border-radius: 3px;
      font-weight: bold;
      font-size: 12px;
    }

    .message.success {
      background-color: #4caf50;
      color: white;
    }

    .message.error {
      background-color: #f44336;
      color: white;
    }
  </style>
</body>
</html>
