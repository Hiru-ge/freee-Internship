<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
    <script>
      // https://developers.google.com/apps-script/guides/html/communication#forms
      function preventFormSubmit() {
        var forms = document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener('submit', function(event) {
            event.preventDefault();
          });
        }
      }
      window.addEventListener('load', preventFormSubmit);

      // 給与ゲージと勤怠履歴の初期化
      window.addEventListener('load', function() {
        initializeWageGauge();
        initializeAttendanceHistory();
      });

      /**
       *  タイムレコーダーの登録ボタンクリック時に発火
       */ 
      function handleWorkRecordFormSubmit(formObject) {
        updateWRMessage('更新中....')
        // .gsファイルのpostWorkRecordファンクションを呼び出し、成功したらmessage更新
        google.script.run.withSuccessHandler(updateWRMessage).postWorkRecord(formObject);
      }
      /**
       *  タイムレコーダーの登録ボタン下のメッセージを更新
       */
      function updateWRMessage(message) {
        var div = document.getElementById('wr_submit_message');
        div.innerHTML = message;
      }

      // 勤怠履歴の変数（シフト表と同様のパターン）
      var attendanceYear;
      var attendanceMonth;
      var allAttendanceData;
      var currentEmployeeId;

      // 勤怠履歴の初期化
      function initializeAttendanceHistory() {
        // ローディングスピナーを表示
        showLoadingSpinner();
        
        // 従業員IDを取得
        currentEmployeeId = getCurrentEmployeeId();
        if (!currentEmployeeId) {
          showAttendanceError('従業員IDが取得できません');
          return;
        }

        // 現在の年月を設定
        var now = new Date();
        attendanceYear = now.getFullYear();
        attendanceMonth = now.getMonth() + 1;
        
        // 勤怠履歴を読み込み
        loadAttendanceData();
      }

      // 現在の従業員IDを取得
      function getCurrentEmployeeId() {
        console.log('従業員ID取得を開始...');
        console.log('現在のURL:', window.location.href);
        console.log('URLパラメータ:', window.location.search);
        
        // 親ウィンドウのURLから取得を試行（Google Apps Scriptのiframe内での実行を考慮）
        try {
          var parentUrl = window.parent.location.href;
          console.log('親ウィンドウのURL:', parentUrl);
          
          var match = parentUrl.match(/[?&]empId=(\d+)/);
          console.log('親ウィンドウURLの正規表現マッチ結果:', match);
          if (match && match[1]) {
            console.log('親ウィンドウURLで従業員ID取得成功:', match[1]);
            return match[1];
          }
        } catch (e) {
          console.log('親ウィンドウURL取得でエラー（セキュリティ制限の可能性）:', e);
        }

        // 現在のウィンドウのURLパラメータから取得を試行
        try {
          var urlParams = new URLSearchParams(window.location.search);
          var empId = urlParams.get('empId');
          console.log('URLパラメータから取得:', empId);
          if (empId) {
            console.log('URLパラメータで従業員ID取得成功:', empId);
            return empId;
          }
        } catch (e) {
          console.log('URLパラメータ取得でエラー:', e);
        }

        // URLから正規表現で取得を試行
        try {
          var url = window.location.href;
          var match = url.match(/[?&]empId=(\d+)/);
          console.log('正規表現マッチ結果:', match);
          if (match && match[1]) {
            console.log('正規表現で従業員ID取得成功:', match[1]);
            return match[1];
          }
        } catch (e) {
          console.log('正規表現取得でエラー:', e);
        }

        // サーバーサイドから取得を試行
        try {
          console.log('サーバーサイドから取得を試行...');
          var selectedEmpId = google.script.run.getSelectedEmployeeId();
          console.log('サーバーサイドから取得:', selectedEmpId);
          if (selectedEmpId) {
            console.log('サーバーサイドで従業員ID取得成功:', selectedEmpId);
            return selectedEmpId;
          }
        } catch (e) {
          console.log('サーバーサイド取得でエラー:', e);
        }

        // フォールバック: デフォルトの従業員IDを使用（店長 太郎）
        console.log('フォールバック: デフォルトの従業員IDを使用');
        return '3313254'; // 店長 太郎のID
      }

      // 勤怠データを読み込み
      function loadAttendanceData() {
        var yearMonth = attendanceYear + '-' + String(attendanceMonth).padStart(2, '0');
        console.log('勤怠データ読み込み開始...');
        console.log('従業員ID:', currentEmployeeId);
        console.log('年月:', yearMonth);
        
        // ローディングスピナーを表示
        showLoadingSpinner();
        
        google.script.run
          .withSuccessHandler(function(data) {
            console.log('勤怠データ取得成功:', data);
            displayAttendanceData(data);
          })
          .withFailureHandler(function(error) {
            console.log('勤怠データ取得失敗:', error);
            showAttendanceError('勤怠データの取得に失敗しました: ' + error.message);
          })
          .getTimeClocksForMonth(currentEmployeeId, yearMonth);
      }

      // 勤怠データを表示
      function displayAttendanceData(dataJson) {
        try {
          var records = JSON.parse(dataJson);
          var container = document.getElementById('attendance-container');
          var title = document.getElementById('attendance-title');
          
          // タイトルを更新
          title.textContent = attendanceYear + '年' + attendanceMonth + '月の勤怠履歴';
          
          // テーブルを生成
          var html = '<table border="1">';
          html += '<thead><tr><th>種別</th><th>日時</th></tr></thead>';
          html += '<tbody>';
          
          if (!records || records.length === 0) {
            // データがない場合は空の行を表示
            html += '<tr><td colspan="2" style="text-align: center; padding: 40px; color: #999;">この月の勤怠記録がありません</td></tr>';
          } else {
            for (var i = 0; i < records.length; i++) {
              var record = records[i];
              html += '<tr>';
              html += '<td>' + record.type + '</td>';
              html += '<td>' + record.date + '</td>';
              html += '</tr>';
            }
          }
          
          html += '</tbody></table>';
          container.innerHTML = html;
          
        } catch (error) {
          showAttendanceError('勤怠データの表示に失敗しました: ' + error.message);
        }
      }

      // 前の月に移動
      function prevMonth() {
        attendanceMonth--;
        if (attendanceMonth < 1) {
          attendanceMonth = 12;
          attendanceYear--;
        }
        loadAttendanceData();
      }

      // 次の月に移動
      function nextMonth() {
        attendanceMonth++;
        if (attendanceMonth > 12) {
          attendanceMonth = 1;
          attendanceYear++;
        }
        loadAttendanceData();
      }

      // ローディングスピナーを表示
      function showLoadingSpinner() {
        var container = document.getElementById('attendance-container');
        container.innerHTML = '<div class="loading-container">' +
                             '<div class="loading-spinner"></div>' +
                             '勤怠履歴を読み込み中...' +
                             '</div>';
      }

      // エラー表示
      function showAttendanceError(message) {
        var container = document.getElementById('attendance-container');
        container.innerHTML = '<p style="color: red;">エラー: ' + message + '</p>';
      }

      // 給与ゲージの初期化
      function initializeWageGauge() {
        var now = new Date();
        var currentMonth = now.getMonth() + 1;
        var currentYear = now.getFullYear();
        
        // 現在の従業員IDを取得（複数の方法を試行）
        var empId = null;
        
        // 方法1: URLパラメータから取得
        try {
          var urlParams = new URLSearchParams(window.location.search);
          empId = urlParams.get('empId');
        } catch (error) {
          // エラーは無視して次の方法を試行
        }
        
        // 方法2: 現在のURLから直接抽出
        if (!empId) {
          try {
            var currentUrl = window.location.href;
            var empIdMatch = currentUrl.match(/empId=(\d+)/);
            if (empIdMatch) {
              empId = empIdMatch[1];
            }
          } catch (error) {
            // エラーは無視して次の方法を試行
          }
        }
        
        // 方法3: サーバーサイドから従業員IDを取得
        if (!empId) {
          google.script.run
            .withSuccessHandler(function(serverEmpId) {
              if (serverEmpId) {
                initializeWageGaugeWithId(serverEmpId, currentMonth, currentYear);
              } else {
                showWageGaugeError('従業員IDが取得できません');
              }
            })
            .withFailureHandler(function(error) {
              // デバッグ用の固定値を使用
              var debugEmpId = '3316116';
              initializeWageGaugeWithId(debugEmpId, currentMonth, currentYear);
            })
            .getSelectedEmployeeId();
          return; // 非同期処理のため、ここで終了
        }
        
        // 従業員IDが取得できた場合
        if (empId) {
          initializeWageGaugeWithId(empId, currentMonth, currentYear);
        } else {
          showWageGaugeError('従業員IDが取得できません');
        }
      }

      // 従業員IDを使用して給与ゲージを初期化
      function initializeWageGaugeWithId(empId, month, year) {
        google.script.run
          .withSuccessHandler(function(result) {
            updateWageGaugeDetail(result);
          })
          .withFailureHandler(function(error) {
            showWageGaugeError('給与データの取得に失敗しました: ' + error.message);
          })
          .getEmployeeWageInfo(empId, month, year);
      }

      // 給与ゲージのエラー表示
      function showWageGaugeError(message) {
        var gaugeText = document.querySelector('.gauge-text');
        if (gaugeText) {
          gaugeText.innerHTML = 'エラー: ' + message;
        }
      }

      // 給与ゲージの詳細表示を更新
      function updateWageGaugeDetail(wageData) {
        try {
          var wageInfo = JSON.parse(wageData);
          
          // エラーチェック
          if (wageInfo.error) {
            var gaugeText = document.querySelector('.gauge-text');
            if (gaugeText) {
              gaugeText.innerHTML = 'エラー: ' + wageInfo.error;
            }
            return;
          }
          
          var gaugeFill = document.querySelector('.gauge-fill');
          var gaugeText = document.querySelector('.gauge-text');
          var breakdownDiv = document.getElementById('wage-breakdown');
          
          if (!gaugeFill || !gaugeText || !breakdownDiv) {
            return;
          }
          
          var percentage = Math.min(wageInfo.percentage, 100);
          var wageFormatted = (wageInfo.wage / 10000).toFixed(1) + '万円';
          var targetFormatted = (wageInfo.target / 10000).toFixed(0) + '万円';
          
          // ゲージバーの幅を更新
          gaugeFill.style.width = percentage + '%';
          
          // 色を設定（103万円に近づくほど赤くなる）
          if (percentage >= 90) {
            gaugeFill.style.backgroundColor = '#ff4444'; // 赤
          } else if (percentage >= 70) {
            gaugeFill.style.backgroundColor = '#ffaa00'; // オレンジ
          } else if (percentage >= 50) {
            gaugeFill.style.backgroundColor = '#ffff00'; // 黄色
          } else {
            gaugeFill.style.backgroundColor = '#44ff44'; // 緑
          }
          
          // テキストを更新
          gaugeText.innerHTML = wageFormatted + ' / ' + targetFormatted + '<br>' + 
                               percentage.toFixed(1) + '%';
          
          // 103万円を超えている場合の警告表示
          if (wageInfo.wage >= wageInfo.target) {
            gaugeText.innerHTML += '<br><span style="color: red; font-weight: bold;">⚠️ 103万円超過！</span>';
          }
          
          // 給与内訳を表示
          var breakdownHtml = '<h4>給与内訳</h4>';
          breakdownHtml += '<table border="1" style="width: 100%; margin-top: 10px;">';
          breakdownHtml += '<tr><th>時間帯</th><th>勤務時間</th><th>時給</th><th>給与</th></tr>';
          
          if (wageInfo.breakdown && Object.keys(wageInfo.breakdown).length > 0) {
            for (var timeZone in wageInfo.breakdown) {
              var detail = wageInfo.breakdown[timeZone];
              breakdownHtml += '<tr>';
              breakdownHtml += '<td>' + detail.name + '</td>';
              breakdownHtml += '<td>' + detail.hours + '時間</td>';
              breakdownHtml += '<td>' + detail.rate.toLocaleString() + '円</td>';
              breakdownHtml += '<td>' + detail.wage.toLocaleString() + '円</td>';
              breakdownHtml += '</tr>';
            }
          } else {
            breakdownHtml += '<tr><td colspan="4">シフトデータがありません</td></tr>';
          }
          
          breakdownHtml += '<tr style="font-weight: bold;">';
          breakdownHtml += '<td colspan="3">合計</td>';
          breakdownHtml += '<td>' + wageInfo.wage.toLocaleString() + '円</td>';
          breakdownHtml += '</tr>';
          breakdownHtml += '</table>';
          
          breakdownDiv.innerHTML = breakdownHtml;
          
        } catch (error) {
          var gaugeText = document.querySelector('.gauge-text');
          if (gaugeText) {
            gaugeText.innerHTML = 'エラー: 給与データの処理に失敗しました<br>' + error.message;
          }
        }
      }
    </script>
  </head>
  <body>
    <div>
      <h3>
      <span>
          <?
            var emp = getEmployee()
            if (emp && emp.display_name) {
          ?>
          <?= emp.display_name ?>
          <? } else { ?>
          従業員情報が取得できません
          <? } ?>
      </span>さんの勤怠履歴
      </h3>
      
      <!-- 月別ページネーション（シフト表と同様のUI） -->
      <div class="month-navigation">
        <h3 id="attendance-title">勤怠履歴</h3>
        <div class="month-navigation-buttons">
          <button class="button small-button" onclick="prevMonth()"><</button>
          <button class="button small-button" onclick="nextMonth()">></button>
        </div>
      </div>
      
      <!-- 勤怠履歴表示エリア -->
      <div id="attendance-container">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          勤怠履歴を読み込み中...
        </div>
      </div>
    </div>

    <div>
      <h3>給与状況（103万の壁ゲージ）</h3>
      <div id="wage-gauge-detail" class="wage-gauge-detail">
        <div class="gauge-container">
          <div class="gauge-bar">
            <div class="gauge-fill" style="width: 0%"></div>
          </div>
          <div class="gauge-text">計算中...</div>
        </div>
        <div id="wage-breakdown" class="wage-breakdown">
          <!-- 給与内訳がここに表示されます -->
        </div>
      </div>
    </div>

    <div>
      <h3>勤怠を登録</h3>
      <form id="workRecordForm" onsubmit="handleWorkRecordFormSubmit(this)">
        <div>
          <label>タイプ</label>
          <select name="target_type" id="pet-select">
            <option value="clock_in">出勤</option>
            <option value="break_begin">休憩開始</option>
            <option value="break_end">休憩終了</option>
            <option value="clock_out">退勤</option>
          </select>
          <br/>
          <label>登録日時: </label>
          <input type="date" name="target_date"/>
          <input type="time" name="target_time"/>
          <div class="btn-frame">
            <input type="submit" value="登録" class="btn"/>
            <div id="wr_submit_message"></div>
          </div>
        </div>
      </form>
      <div>
    <div class="btn-frame">
      <a href="<?= getAppUrl() ?>">ホーム画面に戻る</a>
    </div>
  </body>
</html>
