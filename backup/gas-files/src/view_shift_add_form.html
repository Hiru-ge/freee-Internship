<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
  </head>
  <body>
    <h1>シフト追加リクエスト</h1>
    <p>従業員を選択し、追加したいシフトの日時を入力して依頼を送信します。</p>
    <p>※ このシフト追加は、オーナーの方が臨時シフトを追加することを想定したものです。シフト交代は、シフト一覧ページからお願いします。</p>

    <form id="add-form">
      <div class="form-group">
        <label for="employee-select">依頼する相手:</label>
        <select id="employee-select" name="employee" required>
          <option value="">従業員を読み込んでいます...</option>
        </select>
      </div>

      <div class="form-group">
        <label for="shift-date">追加したいシフトの日付:</label>
        <input type="date" id="shift-date" name="shift_date" required>
      </div>

      <div class="form-group">
        <label>追加したいシフトの時間:</label>
        <input type="time" id="start-time" name="start_time" required> ～ 
        <input type="time" id="end-time" name="end_time" required>
      </div>

      <button type="submit" class="button">この内容でリクエストを送信</button>
    </form>

    <hr>
    <a href="#" onclick="goBack(); return false;">ホーム画面に戻る</a>

  <script>
    /**
     * ページが読み込まれたときに実行される
     */
    window.addEventListener('load', function() {
      // 従業員リストを取得して、ドロップダウンを生成
      google.script.run.withSuccessHandler(populateEmployees).getEmployees();
      
      // フォームの送信イベントを監視
      document.getElementById('add-form').addEventListener('submit', handleFormSubmit);
    });

    /**
     * サーバーから受け取った従業員リストを基に、ドロップダウンを描画する
     */
    function populateEmployees(employees) {
      var select = document.getElementById('employee-select');
      select.innerHTML = '<option value="">選択してください</option>'; // 初期化

      if (employees && employees.length > 0) {
        employees.forEach(function(employee) {
          // オーナー自身（例: 店長 太郎）はリストに表示しない
          if (employee.display_name === '店長 太郎') {
            return;
          }
          var option = document.createElement('option');
          option.value = employee.id;
          option.textContent = employee.display_name;
          select.appendChild(option);
        });
      }
    }

    /**
     * フォームが送信されたときに実行される
     */
    function handleFormSubmit(event) {
      event.preventDefault(); // ページの再読み込みを防止

      // フォームから値を取得
      var approverId = document.getElementById('employee-select').value;
      var shiftDate = document.getElementById('shift-date').value;
      var startTime = document.getElementById('start-time').value;
      var endTime = document.getElementById('end-time').value;

      // 入力チェック
      if (!approverId || !shiftDate || !startTime || !endTime) {
        alert("すべての項目を選択・入力してください。");
        return;
      }

      // 日時を文字列として結合
      var startDateTimeStr = shiftDate + 'T' + startTime;
      var endDateTimeStr = shiftDate + 'T' + endTime;

      // ボタンを無効化
      document.querySelector('button[type="submit"]').disabled = true;
      document.querySelector('button[type="submit"]').textContent = "送信中...";

      // サーバーサイドの関数を呼び出し
      google.script.run
        .withSuccessHandler(onRequestSuccess)
        .withFailureHandler(onRequestFailure)
        .createShiftAdditionRequest(approverId, startDateTimeStr, endDateTimeStr);
    }

    /**
     * リクエスト成功時の処理
     */
    function onRequestSuccess() {
      alert("シフト追加リクエストを送信しました。");
      goBack();
    }
    
    /**
     * リクエスト失敗時の処理
     */
    function onRequestFailure(error) {
      alert("エラーが発生しました: " + error.message);
      // ボタンを再度有効化
      document.querySelector('button[type="submit"]').disabled = false;
      document.querySelector('button[type="submit"]').textContent = "この内容でリクエストを送信";
    }

    function goBack() {
      var url = "<?= ScriptApp.getService().getUrl() ?>";
      window.top.location.href = url;
    }
  </script>
  </body>
</html>