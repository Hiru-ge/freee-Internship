<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
  </head>
  <body>
    <h1>シフト交代リクエスト</h1>
    
    <form id="request-form">
      <div class="form-group">
        <label for="applicant-select">申請者 (あなたの名前):</label>
        <select id="applicant-select" name="applicant" required>
          <option value="">選択してください</option>
        </select>
      </div>

      <div class="form-group">
        <label for="shift-date">交代したいシフトの日付:</label>
        <input type="date" id="shift-date" name="shift_date" required>
      </div>

      <div class="form-group">
        <label>交代したいシフトの時間:</label>
        <input type="time" id="start-time" name="start_time" required> ～ 
        <input type="time" id="end-time" name="end_time" required>
      </div>
      
      <div class="form-group">
        <label>交代を依頼する相手 (複数選択可)</label>
        <div id="employee-list">
          <p>従業員を読み込んでいます...</p>
        </div>
      </div>
      
      <button type="submit" class="button">この内容でリクエストを送信</button>
    </form>

    <hr>
    <a href="#" onclick="goBack(); return false;">ホーム画面に戻る</a>

    <script>
      // サーバーから渡された変数を、JavaScriptの変数として受け取る
      var applicantIdFromUrl = "<?= applicantId ?>";
      var dateFromUrl = "<?= date ?>";
      var startFromUrl = "<?= start ?>";
      var endFromUrl = "<?= end ?>";

      /**
       * ページが読み込まれたときに実行される
       */
      window.addEventListener('load', function() {
        google.script.run.withSuccessHandler(populateEmployees).getEmployees();
        document.getElementById('request-form').addEventListener('submit', handleFormSubmit);

        // 【修正点】URLSearchParamsを使わず、受け取った変数でフォームの値をセットする
        if (dateFromUrl && dateFromUrl !== 'undefined') {
          document.getElementById('shift-date').value = dateFromUrl;
        }
        if (startFromUrl && startFromUrl !== 'undefined') {
          document.getElementById('start-time').value = startFromUrl;
        }
        if (endFromUrl && endFromUrl !== 'undefined') {
          document.getElementById('end-time').value = endFromUrl;
        }
      });

      /**
       * サーバーから受け取った従業員リストを基に、UIを生成する
       */
      function populateEmployees(employees) {
        var applicantSelect = document.getElementById('applicant-select');
        var approverContainer = document.getElementById('employee-list');
        approverContainer.innerHTML = '';
        approverContainer.className = 'approver-card-container';

        if (!employees || employees.length === 0) {
          approverContainer.textContent = '従業員が見つかりませんでした。';
          return;
        }

        var applicantFoundInList = false;
        employees.forEach(function(employee) {
          var option = document.createElement('option');
          option.value = employee.id;
          option.textContent = employee.display_name;
          applicantSelect.appendChild(option);
          
          if (String(employee.id) === String(applicantIdFromUrl)) {
            applicantFoundInList = true;
          }
        });

        applicantSelect.addEventListener('change', function(event) {
            var selectedApplicantId = event.target.value;
            approverContainer.innerHTML = '';

            employees.forEach(function(employee) {
                if (String(employee.id) !== String(selectedApplicantId)) {
                    var wrapper = document.createElement('div');
                    wrapper.className = 'approver-wrapper';
                    
                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = 'emp-' + employee.id;
                    checkbox.name = 'approvers';
                    checkbox.value = employee.id;
                    
                    var label = document.createElement('label');
                    label.className = 'approver-card';
                    label.htmlFor = 'emp-' + employee.id;
                    label.textContent = employee.display_name;

                    // ★修正: クリックイベントでカードの見た目とチェック状態を切り替える
                    label.onclick = function(e) {
                        e.preventDefault(); // デフォルトの動作を防止
                        if (label.classList.contains('selected')) {
                            label.classList.remove('selected');
                            checkbox.checked = false;
                        } else {
                            label.classList.add('selected');
                            checkbox.checked = true;
                        }
                    };
                    
                    wrapper.appendChild(checkbox);
                    wrapper.appendChild(label);
                    approverContainer.appendChild(wrapper);
                }
            });
        });

        if (applicantIdFromUrl && applicantIdFromUrl !== 'undefined' && applicantFoundInList) {
          applicantSelect.value = applicantIdFromUrl;
          applicantSelect.dispatchEvent(new Event('change'));
        }
      }

      function handleFormSubmit(event) {
        event.preventDefault();
        var applicantId = document.getElementById('applicant-select').value;
        var shiftDate = document.getElementById('shift-date').value;
        var startTime = document.getElementById('start-time').value;
        var endTime = document.getElementById('end-time').value;
        var selectedApprovers = [];
        
        document.querySelectorAll('.approver-card.selected').forEach(function(card) {
          selectedApprovers.push(card.htmlFor.replace('emp-', ''));
        });
        
        if (!applicantId || !shiftDate || !startTime || !endTime || selectedApprovers.length === 0) {
          alert("申請者を含め、すべての項目を入力・選択してください。");
          return;
        }
        var startDateTimeStr = shiftDate + 'T' + startTime;
        var endDateTimeStr = shiftDate + 'T' + endTime;
        document.querySelector('button[type="submit"]').disabled = true;
        document.querySelector('button[type="submit"]').textContent = "送信中...";
        google.script.run
          .withSuccessHandler(onRequestSuccess)
          .withFailureHandler(onRequestFailure)
          .createShiftChangeRequest(applicantId, startDateTimeStr, endDateTimeStr, selectedApprovers);
      }
      function onRequestSuccess() {
        alert("シフト交代リクエストを送信しました。");
        goBack();
      }
      function onRequestFailure(error) {
        alert("エラーが発生しました: " + error.message);
        document.querySelector('button[type="submit"]').disabled = false;
        document.querySelector('button[type="submit"]').textContent = "この内容でリクエストを送信";
      }
      function goBack() {
        var url = "<?= ScriptApp.getService().getUrl() ?>";
        window.top.location.href = url;
      }
    </script>
  </body>
</html>