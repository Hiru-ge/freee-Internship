<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
  </head>
  <body>
    <h1>自分へのシフトリクエスト一覧</h1>

    <ul id="request-list-container">
      <p>リクエストを読み込んでいます...</p>
    </ul>

    <hr>
    <a href="#" onclick="goToMyPage(); return false;">マイページトップに戻る</a>

    <script>
      var currentUserId = null;

      window.addEventListener('load', function() {
        loadCurrentUserRequests();
      });

      function loadCurrentUserRequests() {
        // 現在ログインしているユーザーのIDを取得
        google.script.run
          .withSuccessHandler(function(employeeId) {
            if (employeeId) {
              currentUserId = employeeId;
              loadRequestsForUser(employeeId);
            } else {
              document.getElementById('request-list-container').innerHTML = '<p>ユーザー情報の取得に失敗しました。</p>';
            }
          })
          .withFailureHandler(function(error) {
            console.error('ユーザー情報取得エラー:', error);
            document.getElementById('request-list-container').innerHTML = '<p>ユーザー情報の取得に失敗しました。</p>';
          })
          .getSelectedEmployeeId();
      }

      function loadRequestsForUser(userId) {
        var container = document.getElementById('request-list-container');
        container.innerHTML = '<p>リクエストを読み込んでいます...</p>';
        
        google.script.run
          .withSuccessHandler(displayRequests)
          .withFailureHandler(function(error) {
            console.error('リクエスト取得エラー:', error);
            container.innerHTML = '<p>リクエストの取得に失敗しました。</p>';
          })
          .getPendingRequestsForUser(userId);
      }

      function displayRequests(requestsJson) {
        var container = document.getElementById('request-list-container');
        container.innerHTML = '';
        var requests = JSON.parse(requestsJson); // JSON文字列をオブジェクトに戻す

        if (!requests || requests.length === 0) {
          container.innerHTML = '<p>あなた宛の申請中リクエストはありません。</p>';
          return;
        }

        requests.forEach(function(req) {
          var listItem = document.createElement('li');
          listItem.className = 'request-item';
          listItem.id = 'req-' + req.requestId;
          
          var startDate = new Date(req.start);
          var endDate = new Date(req.end);
          var dateString = startDate.toLocaleDateString();
          var timeString = startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + ' - ' +
                           endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

          var infoDiv = document.createElement('div');
          // ★★★ リクエスト種別に応じて表示を変更 ★★★
          var requestTypeText = (req.type === 'change') ? 'シフト交代' : 'シフト追加';
          var applicantText = (req.type === 'change') ? '申請者ID: ' + req.applicantId : '依頼元: ' + req.applicantId;
          infoDiv.innerHTML = '<strong>種別:</strong> ' + requestTypeText + '<br>' +
                              '<strong>' + applicantText + '</strong><br>' +
                              '<strong>依頼日時:</strong> ' + dateString + ' ' + timeString;
          
          var buttonDiv = document.createElement('div');
          buttonDiv.style.marginTop = '10px';

          var approveBtn = document.createElement('button');
          approveBtn.className = 'button approve';
          approveBtn.textContent = '承認';
          approveBtn.onclick = function() { handleApprove(req.type, req.requestId, currentUserId); };

          var denyBtn = document.createElement('button');
          denyBtn.className = 'button deny';
          denyBtn.textContent = '否認';
          denyBtn.onclick = function() { handleDeny(req.type, req.requestId, currentUserId); };
          
          buttonDiv.appendChild(approveBtn);
          buttonDiv.appendChild(denyBtn);
          listItem.appendChild(infoDiv);
          listItem.appendChild(buttonDiv);
          container.appendChild(listItem);
        });
      }

      // ★★★ handleApprove / handleDeny を、リクエスト種別に応じて呼び出す関数を切り替えるように修正 ★★★
      function handleApprove(type, requestId, approverId) {
        document.querySelector('#req-' + requestId + ' .approve').disabled = true;
        document.querySelector('#req-' + requestId + ' .deny').disabled = true;
        
        var functionToCall = (type === 'change') ? 'approveShiftChange' : 'approveShiftAddition';
        
        google.script.run
          .withSuccessHandler(function() {
            document.getElementById('req-' + requestId).innerHTML = '<strong>承認処理が完了しました。</strong>';
            // 処理完了後にリクエスト一覧を再読み込み
            setTimeout(function() {
              loadRequestsForUser(currentUserId);
            }, 1000);
          })
          .withFailureHandler(handleFailure)
          [functionToCall](requestId, approverId); // 動的に関数を呼び出す
      }

      function handleDeny(type, requestId, denierId) {
        document.querySelector('#req-' + requestId + ' .approve').disabled = true;
        document.querySelector('#req-' + requestId + ' .deny').disabled = true;
        
        var functionToCall = (type === 'change') ? 'denyShiftChange' : 'denyShiftAddition';

        google.script.run
          .withSuccessHandler(function() {
            document.getElementById('req-' + requestId).innerHTML = '<strong>否認処理が完了しました。</strong>';
            // 処理完了後にリクエスト一覧を再読み込み
            setTimeout(function() {
              loadRequestsForUser(currentUserId);
            }, 1000);
          })
          .withFailureHandler(handleFailure)
          [functionToCall](requestId, denierId);
      }

      function handleFailure(error) {
        alert('エラーが発生しました: ' + error.message);
        location.reload();
      }

      function goToMyPage() {
        window.top.location.href = '<?= getAppUrl() ?>?page=my_page';
      }
    </script>
  </body>
</html>