# 103万の壁ゲージ 実装状況

## 概要
学生の給与が103万円に達しているかを視覚的に確認できるゲージシステムを実装しました。このシステムにより、学生が計画的な勤務を行い、年末の人手不足を防ぐことができます。

## 実装された機能

### 1. 時間帯別時給システム
- **通常時給**: 9:00-18:00 (1000円/時)
- **夜間手当**: 18:00-22:00 (1200円/時)
- **深夜手当**: 22:00-9:00 (1500円/時)

### 2. 給与計算ロジック
- シフト表から勤務時間を自動計算
- 時間帯別の給与を集計して月給を算出
- 103万円を目標値として進捗率を計算

### 3. 表示画面

#### 3.1 ホーム画面 (`view_home.html`)
- 従業員リストの右側に給与ゲージを表示
- 全従業員の給与状況を一覧表示
- リアルタイムで給与情報を更新

#### 3.2 従業員詳細画面 (`view_detail.html`)
- 個別従業員の詳細な給与情報を表示
- 時間帯別の給与内訳を表形式で表示
- 103万円超過時の警告表示

### 4. 視覚的フィードバック
- **緑色**: 50%未満（安全圏）
- **黄色**: 50-69%（注意圏）
- **オレンジ**: 70-89%（警告圏）
- **赤色**: 90%以上（危険圏）
- **103万円超過**: ⚠️マーク付きの明確な警告

## 技術的実装

### 1. バックエンド (`code.js`)

#### 1.1 給与計算関数
```javascript
// ✅ API連携完了 - 基本時給取得
function getHourlyWage(employeeId) // freee APIから基本時給を取得

// 時間帯別勤務時間計算
function calculateWorkHoursByTimeZone(shiftTime)

// 月間勤務時間計算
function calculateMonthlyWorkHours(employeeId, month, year)

// 月給計算
function calculateMonthlyWage(employeeId, month, year)

// 全従業員給与状況取得
function getAllEmployeesWages(month, year)

// 個別従業員給与状況取得
function getEmployeeWageInfo(employeeId, month, year)
```

#### 1.2 設計の特徴
- **疎結合**: 各計算処理を独立した関数として実装
- **拡張性**: 新しい給与体系への対応が容易
- **設定駆動**: 時間帯別時給を設定で管理

### 2. フロントエンド

#### 2.1 HTML構造
- 従業員リストテーブルに給与ゲージ列を追加
- プログレスバー形式のゲージ表示
- レスポンシブ対応のテーブルレイアウト

#### 2.2 JavaScript機能
- ページ読み込み時の自動給与計算
- エラーハンドリングとデバッグログ
- リアルタイムなゲージ更新

### 3. スタイリング (`css.html`)
- モダンなゲージデザイン
- 色分けによる直感的な状況把握
- ダークテーマに統一されたUI

## データフロー

```
1. シフト表データ取得 (getShifts)
   ↓
2. 従業員情報取得 (getEmployees)
   ↓
3. 勤務時間計算 (calculateMonthlyWorkHours)
   ↓
4. 給与計算 (calculateMonthlyWage)
   ↓
5. フロントエンド表示 (updateWageGauge)
```

## 設定項目

### 時給設定

#### 現在の実装（固定値）
```javascript
var TIME_ZONE_WAGE_RATES = {
  normal: { start: 9, end: 18, rate: 1000, name: '通常時給' },
  evening: { start: 18, end: 22, rate: 1200, name: '夜間手当' },
  night: { start: 22, end: 9, rate: 1500, name: '深夜手当' }
};
```

#### freeeでの実際の設定
- **基本時給**: 1000円/時
- **深夜時給**: 1250円/時（22:00〜27:00）

**設定手順**:
1. freee人事労務にログイン
2. 「従業員」→ 該当従業員選択 → 「基本給と割増賃金」を編集
3. 基本時給: 1000円を設定
4. 「設定」→ 「時給の時間帯設定」→ 「＋新規作成」
5. 名称: 「深夜手当」、時間帯: 22:00〜27:00、時給: 1250円を設定
6. 従業員の「基本給と割増賃金」で「時間帯の追加」から深夜手当を適用

### 目標額設定
- **目標額**: 1,030,000円（103万円）
- **警告レベル**: 50%, 70%, 90%

## 今後の拡張可能性

### 1. 時給体系の複雑化対応
- 業績連動給与
- 固定給 + 時給の組み合わせ

### 2. 通知機能の強化
- 103万円接近時のメール通知
- 管理者へのアラート機能
- 月次レポートの自動生成

### 3. データソースの拡張
- freee APIからの時給情報取得
- 実際の勤怠データとの連携
- 給与計算の精度向上

### 4. freee連携の実装状況
- **Phase 1**: ✅ **完了** - 基本時給をfreee APIから取得（1000円）
  - `getHourlyWage()`関数で`/hr/api/v1/employees/{employee_id}/basic_pay_rule`エンドポイントを使用
  - エラーハンドリングとフォールバック処理（デフォルト1000円）を実装
- **Phase 2**: ⏳ **調査中** - 深夜時給をfreee APIから取得（22:00〜27:00、1250円）
  - 現在のAPIでは時間帯別給与の直接取得ができないため、担当者に問い合わせ中
  - 現時点では固定値設定を維持

## 動作確認方法

### 1. ホーム画面
1. アプリケーションを起動
2. 従業員リストの右側に給与ゲージが表示されることを確認
3. 各ゲージに給与情報が正しく表示されることを確認

### 2. 従業員詳細画面
1. 従業員名をクリック
2. 給与状況セクションに詳細ゲージが表示されることを確認
3. 時間帯別の給与内訳が正しく表示されることを確認

### 3. エラー時の動作
1. シフトデータがない場合の表示確認
2. 給与計算エラー時の表示確認
3. コンソールログでのデバッグ情報確認

## 注意事項

### 1. 現在の制限事項
- 時給は固定値（将来的にfreee APIから取得予定）
- シフト表のデータに依存
- 休憩時間の計算は未実装

### 2. パフォーマンス考慮事項
- 全従業員の給与を一括計算
- 大量データ時の処理時間
- メモリ使用量の最適化

## まとめ

103万の壁ゲージシステムは、学生の計画的な勤務を促し、年末の人手不足を防ぐための実用的なツールとして実装されました。時間帯別時給に対応した疎結合な設計により、将来的な拡張性も確保されています。

このシステムにより、管理者は学生の給与状況を一目で把握でき、学生自身も自分の給与状況を確認できるようになりました。103万円の壁に近づいた際の計画的な勤務調整が可能になり、年末の人手不足防止に貢献します。
