# LINE Bot シフト追加リクエスト機能仕様書

## 1. 概要

LINE Bot経由でシフト追加リクエストを送信できる機能の仕様書。既存のシフト交代機能と同様のフローで、新しいシフトの追加依頼を送信する。

## 2. 機能概要

### 2.1. 目的
- 店舗のグループLINEから新しいシフトの追加依頼を送信
- 対象従業員への自動通知とメール送信
- 承認・拒否の管理とシフト表への自動反映

### 2.2. 対象ユーザー
- 店舗のグループLINE参加者（全従業員）
- シフト追加依頼の送信者
- シフト追加依頼の対象従業員

## 3. 機能フロー

### 3.1. シフト追加リクエスト送信フロー

```
1. 従業員AがグループLINEで「シフト追加」と送信
2. Botが「日付を入力してください（例：2025-01-15）」と返信
3. 従業員Aが日付を入力（例：2025-01-15）
4. Botが「時間を入力してください（例：09:00-18:00）」と返信
5. 従業員Aが時間を入力（例：09:00-18:00）
6. Botが対象従業員の候補を表示（グループ内の従業員）
7. 従業員Aが対象従業員を選択
8. Botが確認メッセージを表示
9. 従業員Aが「はい」で確認
10. Botが対象従業員に依頼メッセージを送信
11. 対象従業員が「リクエスト確認」コマンドで承認待ちリクエストを確認
12. Botが承認待ちリクエストをFlex Message形式のカードで表示
13. 対象従業員が「承認」または「拒否」ボタンをタップ
14. 承認された場合、システムが自動でシフト表を更新
15. 申請者に承認・拒否結果をプッシュメッセージで通知
```

### 3.2. 会話状態管理

#### 状態定義
- `waiting_shift_addition_date`: 日付入力待ち
- `waiting_shift_addition_time`: 時間入力待ち
- `waiting_shift_addition_employee`: 対象従業員選択待ち
- `waiting_shift_addition_confirmation`: 確認待ち

#### 状態遷移
```
初期状態 → waiting_shift_addition_date → waiting_shift_addition_time → waiting_shift_addition_employee → waiting_shift_addition_confirmation → 完了
```

## 4. コマンド仕様

### 4.1. 基本コマンド
- **シフト追加**: シフト追加リクエストの開始

### 4.2. 入力形式

#### 日付入力
- 形式: `YYYY-MM-DD` または `MM/DD`
- 例: `2025-01-15`, `01/15`

#### 時間入力
- 形式: `HH:MM-HH:MM`
- 例: `09:00-18:00`, `13:00-21:00`

#### 従業員選択
- 形式: 従業員名（カンマ区切りで複数選択可能）
- 例: `テスト 太郎`, `テスト 太郎, テスト 次郎`

## 5. メッセージ仕様

### 5.1. 開始メッセージ
```
📝 シフト追加依頼を開始します

📅 追加したいシフトの日付を入力してください
例: 2025-01-15 または 01/15
```

### 5.2. 時間入力メッセージ
```
⏰ シフトの時間を入力してください
例: 09:00-18:00
```

### 5.3. 従業員選択メッセージ
```
👥 対象従業員を選択してください

利用可能な従業員:
1. テスト 太郎
2. テスト 次郎
3. テスト 三郎

📝 従業員名を入力してください
💡 複数選択の場合は「,」で区切って入力
```

### 5.4. 確認メッセージ
```
✅ シフト追加依頼の確認

📅 日付: 2025-01-15
⏰ 時間: 09:00-18:00
👤 対象従業員: テスト 太郎

📤 この内容で依頼を送信しますか？
💬 「はい」または「いいえ」で回答してください
```

### 5.5. 完了メッセージ
```
✅ シフト追加依頼を送信しました

📧 対象従業員にメール通知を送信しました
📱 対象従業員は「リクエスト確認」で承認・拒否できます
```

## 6. エラーハンドリング

### 6.1. 日付エラー
```
⚠️ 日付の形式が正しくありません
📝 YYYY-MM-DD または MM/DD 形式で入力してください
例: 2025-01-15 または 01/15
```

### 6.2. 時間エラー
```
⚠️ 時間の形式が正しくありません
📝 HH:MM-HH:MM 形式で入力してください
例: 09:00-18:00
```

### 6.3. 従業員エラー
```
❌ 従業員が見つかりません: テスト 四郎
📝 正しい従業員名を入力してください
```

### 6.4. 重複エラー
```
⚠️ 指定された時間に既にシフトが入っています
⏰ 重複時間: 09:00-12:00
💡 別の時間を選択してください
```

## 7. データベース設計

### 7.1. 既存テーブル利用
- `shift_additions`: 既存のシフト追加リクエストテーブル
- `employees`: 既存の従業員テーブル
- `shifts`: 既存のシフトテーブル

### 7.2. 会話状態管理
- `conversation_states`: 既存の会話状態管理テーブル

## 8. メール通知

### 8.1. 通知対象
- シフト追加依頼の対象従業員

### 8.2. メール内容
- 依頼者名
- 追加シフトの日付・時間
- 承認・拒否のリンク
- LINEコマンド案内

### 8.3. メールテンプレート
- `shift_addition_request.html.erb`: 既存テンプレート利用

## 9. 承認フロー

### 9.1. 承認方法
- LINE Bot経由（「リクエスト確認」コマンド）
- Web経由（メール内リンク）

### 9.2. 承認結果
- 承認: シフト表に自動追加
- 拒否: 依頼者に通知

## 10. テスト仕様

### 10.1. 単体テスト
- 日付入力の検証
- 時間入力の検証
- 従業員選択の検証
- 会話状態管理の検証

### 10.2. 統合テスト
- 完全なフローのテスト
- メール通知のテスト
- 承認フローのテスト

### 10.3. エラーテスト
- 不正な入力のテスト
- 重複チェックのテスト
- システムエラーのテスト

## 11. 実装優先順位

### 11.1. Phase 1: 基本機能
- [ ] シフト追加リクエストフローの実装
- [ ] 会話状態管理の実装
- [ ] 基本的なメッセージ処理

### 11.2. Phase 2: UI/UX改善
- [ ] Flex Message対応
- [ ] エラーメッセージの改善
- [ ] ユーザビリティの向上

### 11.3. Phase 3: 統合・テスト
- [ ] 既存機能との統合
- [ ] メール通知の統合
- [ ] 包括的なテスト実装

## 12. 注意事項

### 12.1. 既存機能との整合性
- シフト交代機能と同様のフローを維持
- 既存のメール通知システムを活用
- 既存の承認フローを再利用

### 12.2. セキュリティ
- 従業員認証の確認
- 不正な入力の検証
- 適切な権限チェック

### 12.3. パフォーマンス
- 会話状態の適切な管理
- データベースクエリの最適化
- メール送信の非同期処理

## 13. 仕様変更履歴

### 2025年1月: 機能範囲の明確化
- 勤怠状況確認機能を削除（LINE Bot対象外）
- 103万の壁ゲージ表示機能を削除（LINE Bot対象外）
- 給与情報確認機能を削除（LINE Bot対象外）
- シフト管理機能に集中（シフト確認、シフト交代、シフト追加）
