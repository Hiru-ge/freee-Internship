# ローカル環境と本番環境の制限事項

勤怠管理システムの引き渡し時に、ローカル環境でできることとできないことを明確にします。

## 概要

本システムは複数の外部サービスと連携しており、一部の機能は本番環境（fly.io）でのみ動作します。引き渡し先が適切に動作確認できるよう、制限事項を明記します。

## ローカル環境で動作する機能

### ✅ 完全に動作する機能

#### 1. **基本認証・認可機能**
- メールアドレス認証（アクセス制限）
- 従業員ログイン・パスワード認証
- オーナー・従業員権限判定
- セッション管理

#### 2. **シフト管理機能**
- シフト表の表示・編集
- シフト交代リクエストの作成・承認・拒否
- シフト追加リクエストの作成・承認・拒否
- 欠勤申請機能

#### 3. **勤怠管理機能**
- 出勤・退勤打刻
- 勤怠履歴の表示
- 103万の壁ゲージ表示

#### 4. **freee API連携**
- 従業員情報の取得
- 給与情報の取得
- 打刻データの取得・送信

#### 5. **データベース操作**
- 全CRUD操作
- マイグレーション
- シードデータ作成

### ⚠️ 制限がある機能

#### 1. **メール通知機能**
- **動作**: ローカルでもGmail SMTPでメール送信可能
- **制限**: 送信先メールアドレスが環境変数`ALLOWED_EMAIL_ADDRESSES`に含まれている必要がある
- **確認方法**: シフト交代リクエストを作成してメール通知をテスト

## 本番環境（fly.io）でのみ動作する機能

### ❌ ローカルでは動作しない機能

#### 1. **打刻忘れアラート機能**
- **理由**: GitHub Actionsによる定期実行が必要
- **動作環境**: fly.io + GitHub Actions
- **実行頻度**: 日本時間の毎時0分、15分、30分、45分
- **確認方法**:
  ```bash
  # 本番環境で手動実行
  fly ssh console -a freee-internship -C "bundle exec rails clock_reminder:check_all"

  # GitHub Actionsで手動実行
  # GitHubのActionsタブから「Clock Reminder Check」を手動実行
  ```

#### 2. **LINE Bot連携機能**
- **理由**: LINE Messaging APIのWebhook URLが本番環境に設定されている
- **動作環境**: fly.io + LINE Messaging API
- **機能**:
  - シフト情報の確認
  - シフト交代依頼・承認
  - シフト追加依頼・承認
  - 欠勤申請
- **確認方法**: LINE Botに友達追加してコマンドをテスト

#### 3. **本番環境固有の設定**
- **fly.ioの自動起動・停止**
- **本番用データベース（SQLite）**
- **本番用環境変数**

## 引き渡し時の動作確認手順

### 1. ローカル環境での確認

#### 必須確認項目
```bash
# 1. 環境変数設定確認
echo "FREEE_ACCESS_TOKEN: $FREEE_ACCESS_TOKEN"
echo "FREEE_COMPANY_ID: $FREEE_COMPANY_ID"
echo "OWNER_EMPLOYEE_ID: $OWNER_EMPLOYEE_ID"

# 2. データベースセットアップ
bin/rails db:migrate
bin/rails db:seed

# 3. アプリケーション起動
bin/rails server

# 4. 基本機能テスト
# - アクセス制限（メール認証）
# - ログイン機能
# - シフト管理機能
# - 勤怠打刻機能
```

#### 推奨確認項目
- [ ] オーナー権限でのシフト追加依頼機能
- [ ] 従業員権限でのシフト交代依頼機能
- [ ] メール通知機能（シフト交代リクエスト時）
- [ ] 103万の壁ゲージ表示
- [ ] 欠勤申請機能

### 2. 本番環境での確認

#### 必須確認項目
```bash
# 1. アプリケーション状態確認
fly status -a freee-internship

# 2. 環境変数確認
fly secrets list -a freee-internship

# 3. ログ確認
fly logs -a freee-internship
```

#### 推奨確認項目
- [ ] 打刻忘れアラートの手動実行
- [ ] LINE Bot連携機能
- [ ] 本番環境でのメール通知

## トラブルシューティング

### よくある問題

#### 1. **freee API接続エラー**
- **原因**: アクセストークンの期限切れ（6時間で失効）
- **対処**: 新しいアクセストークンを取得して環境変数を更新

#### 2. **メール送信エラー**
- **原因**: Gmail SMTP設定の問題
- **対処**: `GMAIL_USERNAME`と`GMAIL_APP_PASSWORD`を確認

#### 3. **オーナー権限が効かない**
- **原因**: 環境変数`OWNER_EMPLOYEE_ID`の設定ミス
- **対処**: 正しい従業員IDを設定してシードデータを再作成

#### 4. **LINE Botが応答しない**
- **原因**: Webhook URLが本番環境に設定されていない
- **対処**: LINE Developers ConsoleでWebhook URLを確認

## 引き渡し先への推奨事項

### 1. **段階的な確認**
1. ローカル環境での基本機能確認
2. 本番環境でのデプロイ確認
3. 外部サービス連携の確認

### 2. **ドキュメントの活用**
- [セットアップガイド](SETUP_GUIDE.md)
- [引き渡しチェックリスト](HANDOVER_CHECKLIST.md)
- [デプロイガイド](DEPLOYMENT_DOCUMENTATION.md)

### 3. **サポート体制**
- ローカル環境の問題は即座に解決可能
- 本番環境の問題は設定確認が必要
- 外部サービス（LINE Bot、GitHub Actions）の問題は個別対応が必要

## まとめ

**ローカル環境で確認できること**:
- システムの基本機能（認証、シフト管理、勤怠管理）
- freee API連携
- メール通知（制限あり）

**本番環境でしか確認できないこと**:
- 打刻忘れアラート
- LINE Bot連携
- 本番環境固有の設定

引き渡し時は、まずローカル環境で基本機能を確認し、その後本番環境で外部サービス連携を確認することを推奨します。
