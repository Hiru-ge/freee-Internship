# シフト管理システム仕様書

勤怠管理システムのシフト管理機能の詳細仕様です。

## 🎯 概要

従業員がLINE Botを通じてシフトの確認、交代依頼、追加依頼、欠勤申請を行うためのシステムです。

## 📅 シフト確認機能

### 個人シフト確認
```
コマンド: シフト確認
```

**機能**:
- 認証済みユーザーの今月のシフトを表示
- 日付、開始時間、終了時間を表示

**表示形式**:
```
今月のシフト

12/25 (水) 09:00-17:00
12/26 (木) 09:00-17:00
12/27 (金) 09:00-17:00
```

**条件**:
- 認証済みユーザーのみ利用可能
- 個人チャット・グループチャット両方で利用可能

### 全員シフト確認
```
コマンド: 全員シフト確認
```

**機能**:
- 全従業員の今月のシフトを表示
- 従業員ID、日付、時間を表示

**表示形式**:
```
【今月の全員シフト】

12/25 (水)
  ID: tanaka_taro: 09:00-17:00
  ID: yamada_hanako: 18:00-22:00

12/26 (木)
  ID: tanaka_taro: 09:00-17:00
```

**条件**:
- 認証済みユーザーのみ利用可能
- 個人チャット・グループチャット両方で利用可能

## 🔄 シフト交代機能

### 交代依頼フロー
```
1. 「交代依頼」コマンド
2. 日付入力（MM/DD形式）
3. シフト選択（Flex Message）
4. 交代先従業員名入力
5. 確認画面
6. 依頼送信
```

### 日付入力
```
入力例: 12/25, 09/20
形式: MM/DD
```

**処理**:
1. 日付形式の検証
2. 未来の日付のみ許可
3. 該当日付のシフトを検索
4. Flex Messageでシフト一覧を表示

### シフト選択
**Flex Message仕様**:
- カード形式でシフト一覧を表示
- 各シフトに「交代を依頼」ボタン
- Postbackデータ: `shift_{shift_id}`

### 交代先従業員選択
```
入力例: 田中太郎, 山田花子
形式: 従業員名（カンマ区切りで複数選択可能）
```

**処理**:
1. 従業員名の正規化・検索
2. 存在確認
3. 確認画面の表示

### 確認画面
```
シフト交代の確認

日付: 12/25
時間: 09:00 - 17:00
交代先: 田中太郎

「はい」で確定、「いいえ」でキャンセル
```

### 依頼送信
**成功時**:
```
シフト交代依頼を送信しました。
承認をお待ちください。
```

**失敗時**:
```
シフト交代リクエストの作成に失敗しました。
```

## ➕ シフト追加機能

### 追加依頼フロー（オーナーのみ）
```
1. 「追加依頼」コマンド
2. 日付入力（MM/DD形式）
3. 時間入力（HH:MM-HH:MM形式）
4. 対象従業員選択
5. 確認画面
6. 依頼送信
```

### 日付入力
```
入力例: 12/25, 09/20
形式: MM/DD
```

### 時間入力
```
入力例: 9:00-17:00, 09:00-17:00
形式: HH:MM-HH:MM
```

### 対象従業員選択
**利用可能な従業員の表示**:
```
利用可能な従業員:
1. 田中太郎
2. 山田花子
3. 佐藤次郎

番号または名前で選択してください。
例: 1,2 または 田中太郎,山田花子
```

**処理**:
1. 指定日時の既存シフトをチェック
2. 重複しない従業員のみ表示
3. 番号または名前で選択可能
4. 複数選択可能（カンマ区切り）

### 確認画面
```
シフト追加の確認

日付: 12/25
時間: 09:00-17:00
対象従業員: 田中太郎, 山田花子

「はい」で確定、「いいえ」でキャンセル
```

### 依頼送信
**成功時**:
```
シフト追加依頼を送信しました。
送信先の方の承認をお待ちください。
```

## 🚫 欠勤申請機能

### 欠勤申請フロー
```
1. 「欠勤申請」コマンド
2. 日付入力（MM/DD形式）
3. シフト選択（Flex Message）
4. 欠勤理由入力
5. 確認画面
6. 申請送信
```

### 日付入力
```
入力例: 12/25, 09/20
形式: MM/DD
```

**処理**:
1. 日付形式の検証
2. 未来の日付のみ許可
3. 該当日付の自分のシフトを検索
4. Flex Messageでシフト一覧を表示

### シフト選択
**Flex Message仕様**:
- 赤色テーマ（#FF6B6B）のカード
- 各シフトに「このシフトを欠勤申請」ボタン
- Postbackデータ: `deletion_shift_{shift_id}`

### 欠勤理由入力
```
入力例: 体調不良のため, 家族の用事
形式: 自由記述
```

### 確認画面
```
欠勤申請の確認

日付: 12/25
時間: 09:00-17:00
理由: 体調不良のため

「はい」で確定、「いいえ」でキャンセル
```

### 申請送信
**成功時**:
```
欠勤申請を送信しました。承認をお待ちください。
```

## 📋 依頼確認機能

### 依頼確認
```
コマンド: 依頼確認
```

**機能**:
- 自分に来ている承認待ちの依頼を表示
- 承認・拒否ボタンで処理可能

**表示形式**:
```
承認待ちの依頼一覧

【シフト交代依頼】
申請者: 田中太郎
日付: 12/25
時間: 09:00-17:00
[承認] [拒否]

【欠勤申請】
申請者: 山田花子
日付: 12/26
時間: 18:00-22:00
理由: 体調不良のため
[承認] [拒否]
```

**依頼がない場合**:
```
承認待ちの依頼はありません。
```

## 🗄️ データベース設計

### Shift テーブル
```sql
CREATE TABLE shifts (
  id BIGINT PRIMARY KEY,
  employee_id VARCHAR(255) NOT NULL,
  shift_date DATE NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
```

### ShiftExchange テーブル
```sql
CREATE TABLE shift_exchanges (
  id BIGINT PRIMARY KEY,
  request_id VARCHAR(255) UNIQUE NOT NULL,
  requester_id VARCHAR(255) NOT NULL,
  approver_id VARCHAR(255) NOT NULL,
  shift_id BIGINT NOT NULL,
  status VARCHAR(50) NOT NULL,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
```

### ShiftAddition テーブル
```sql
CREATE TABLE shift_additions (
  id BIGINT PRIMARY KEY,
  request_id VARCHAR(255) UNIQUE NOT NULL,
  requester_id VARCHAR(255) NOT NULL,
  approver_id VARCHAR(255) NOT NULL,
  shift_date DATE NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  target_employee_ids TEXT NOT NULL,
  status VARCHAR(50) NOT NULL,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
```

### ShiftDeletion テーブル
```sql
CREATE TABLE shift_deletions (
  id BIGINT PRIMARY KEY,
  request_id VARCHAR(255) UNIQUE NOT NULL,
  requester_id VARCHAR(255) NOT NULL,
  approver_id VARCHAR(255) NOT NULL,
  shift_id BIGINT NOT NULL,
  reason TEXT,
  status VARCHAR(50) NOT NULL,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
```

## 🔍 検索・フィルタリング仕様

### 従業員検索
- **正規化処理**: カタカナ→ひらがな、スペース除去
- **検索方法**: 部分一致検索
- **複数選択**: カンマ区切りで複数従業員選択可能

### シフト検索
- **日付範囲**: 未来のシフトのみ
- **従業員フィルタ**: 指定従業員のシフトのみ
- **重複チェック**: 既存シフトとの重複を自動チェック

### 利用可能従業員フィルタ
- **重複除外**: 指定日時に既にシフトがある従業員を除外
- **権限チェック**: アクティブな従業員のみ
- **表示順序**: 従業員名のアルファベット順

## ⚠️ バリデーション仕様

### 日付バリデーション
- **形式**: MM/DD形式のみ
- **範囲**: 未来の日付のみ
- **年処理**: 12月に1月の日付を入力すると翌年として認識

### 時間バリデーション
- **形式**: HH:MM-HH:MM形式
- **範囲**: 開始時間 < 終了時間
- **重複チェック**: 既存シフトとの重複をチェック

### 従業員名バリデーション
- **存在確認**: Freee APIで従業員の存在を確認
- **正規化**: 入力値の正規化処理
- **複数選択**: カンマ区切りでの複数選択対応

## 🔄 状態管理

### 会話状態
- **waiting_for_shift_exchange_date**: シフト交代日付入力待ち
- **waiting_for_shift_exchange_selection**: シフト選択待ち
- **waiting_for_shift_exchange_employee**: 交代先従業員入力待ち
- **waiting_for_shift_addition_date**: シフト追加日付入力待ち
- **waiting_for_shift_addition_time**: シフト追加時間入力待ち
- **waiting_for_shift_addition_employee**: 対象従業員入力待ち
- **waiting_for_shift_deletion_date**: 欠勤申請日付入力待ち
- **waiting_for_shift_deletion_selection**: 欠勤申請シフト選択待ち
- **waiting_deletion_reason**: 欠勤理由入力待ち

### 状態遷移
```
開始 → 日付入力 → シフト選択 → 従業員入力 → 確認 → 完了
```

## 🧪 テスト仕様

### 単体テスト
- 日付バリデーションテスト
- 時間バリデーションテスト
- 従業員検索テスト
- 重複チェックテスト

### 統合テスト
- シフト交代フロー全体テスト
- シフト追加フロー全体テスト
- 欠勤申請フロー全体テスト
- 依頼確認フロー全体テスト

### テストケース
1. **正常フロー**: 各機能の正常な実行
2. **バリデーションエラー**: 不正な入力値
3. **権限エラー**: 権限のないユーザー
4. **データ不存在**: 存在しないデータの参照
5. **重複エラー**: 既存データとの重複

## 🚀 今後の拡張予定

### 機能拡張
- シフト変更履歴の管理
- シフトテンプレート機能
- 自動シフト生成機能
- シフト統計機能

### ユーザビリティ向上
- シフト一括操作機能
- シフトコピー機能
- シフト検索機能
- シフト通知機能

---

**最終更新日**: 2024年12月
**バージョン**: 1.0.0
