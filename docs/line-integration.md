# LINE連携機能仕様書

## 1. 概要

既存のグループLINEでのシフト交代連携を維持しながら、システムとの自動連携を実現するLINE Bot機能。

## 2. 背景・目的

### 2.1. 現在の課題
- グループLINEでシフト交代の連携を取っている
- シフト交代成立後、オーナーが手動でシフト予定を書き換える必要がある
- LINEを遡って正しい勤務時間を追跡する必要があり面倒

### 2.2. LINE連携の目的
- 既存のLINEでの連携体験を維持
- シフト交代の自動化とシステム連携
- 手動でのシフト表更新作業の削減

## 3. 機能分離設計

### 3.1. グループLINE機能
**対象**: 店舗のグループLINE
**目的**: シフト交代の連携・調整

#### 利用可能機能
- **シフト交代依頼**: グループ内でシフト交代の依頼を送信
- **シフト交代承認**: 依頼されたシフト交代を承認・否認
- **全員シフト確認**: 店舗全体のシフト状況を確認
- **シフト変更通知**: シフト変更があった際のグループ通知

#### 制限事項
- 個人情報（給与情報、詳細な勤怠履歴）は表示しない
- プライベートな情報は個人LINEで対応

### 3.2. 個人LINE機能
**対象**: 各従業員の個人LINE
**目的**: 個人の勤怠管理・情報確認

#### 利用可能機能
- **シフト確認**: 自分のシフト一覧表示
- **勤怠確認**: 自分の勤怠状況確認
- **給与確認**: 103万の壁ゲージの状況確認
- **打刻リマインダー**: 打刻忘れのリマインダー受信
- **個人通知**: シフト承認結果、給与アラートなど

#### 制限事項
- 他の従業員の情報は確認できない
- シフト交代依頼はグループLINEで行う

## 4. 機能要件

### 4.1. 基本機能
- **友達追加**: 従業員がLINE Botを友達追加
- **認証連携**: LINEアカウントと勤怠管理システムの従業員IDを紐付け
- **権限管理**: オーナーと従業員の権限を適切に管理
- **グループ・個人識別**: グループLINEと個人LINEを適切に識別

### 4.2. グループLINE機能

#### シフト交代機能
- **シフト交代依頼**: グループ内でシフト交代の依頼を送信
- **交代承認**: 依頼されたシフト交代を承認・否認
- **自動更新**: 承認されたシフト交代を自動でシステムに反映
- **交代候補表示**: 交代可能な従業員の候補を表示

##### シフト確認機能
- **全員シフト確認**: 店舗全体のシフト状況を確認
- **日別シフト表示**: 特定の日のシフト状況を詳細表示
- **シフト状況の可視化**: 誰がいつ働くかを一目で確認

#### 通知機能
- **シフト変更通知**: シフト変更があった際のグループ通知

### 4.3. 個人LINE機能

#### 確認機能
- **シフト確認**: 自分のシフト一覧をLINEで確認
- **勤怠状況確認**: 自分の勤怠状況をLINEで確認
- **給与状況確認**: 103万の壁ゲージの状況をLINEで確認

#### 通知機能
- **打刻リマインダー**: 打刻忘れのリマインダーをLINEで送信
- **103万の壁アラート**: 給与が103万円に近づいた際のLINE通知
- **個人通知**: シフト承認結果、給与アラートなど

## 5. ユーザー体験設計

### 5.1. グループLINEでのシフト交代フロー
```
1. 従業員AがグループLINEで「シフト交代したい」と送信
2. Botが従業員Aのシフト一覧を表示
3. 従業員Aが交代したいシフトを選択
4. Botが交代相手の候補を表示（グループ内の従業員）
5. 従業員Aが交代相手を選択
6. Botが交代相手に依頼メッセージを送信
7. 交代相手が承認・否認をグループLINEで返信
8. 承認された場合、システムが自動でシフト表を更新
9. グループ内に結果を通知
```

### 5.2. 個人LINEでの確認フロー
```
1. 従業員が個人LINEで「シフト確認」と送信
2. Botが個人のシフト一覧を表示
3. 従業員が「給与確認」と送信
4. Botが103万の壁ゲージの状況を表示
5. 従業員が「勤怠確認」と送信
6. Botが個人の勤怠状況を表示
```

### 5.3. グループLINEでの全員シフト確認フロー
```
1. 従業員がグループLINEで「全員シフト」と送信
2. Botが店舗全体のシフト一覧を表示
3. 従業員が特定の日付を選択（オプション）
4. Botが該当日の詳細なシフト状況を表示
5. 必要に応じてシフト交代依頼に進む
```

### 5.4. コマンド設計

#### グループLINEコマンド
- **シフト交代** - シフト交代依頼
- **承認** - シフト交代承認
- **否認** - シフト交代否認
- **全員シフト** - 店舗全体のシフト状況確認

#### 個人LINEコマンド
- **シフト確認** - 自分のシフト一覧表示
- **勤怠確認** - 勤怠状況確認
- **給与確認** - 給与状況確認
- **ヘルプ** - 利用可能なコマンド一覧

## 6. 認証・初期設定フロー

### 6.1. 初回登録フロー
```
1. 従業員がLINE Botを友達追加
2. Botが「勤怠管理システムに登録しますか？」と確認
3. 従業員が「はい」を選択
4. Botが「従業員IDを入力してください」と要求
5. 従業員がIDを入力（例：3313254, 3316116）
6. Botが「認証コードを送信しました」と通知
7. システムが従業員のメールアドレスに6桁の認証コードを送信
8. 従業員が認証コードをLINEで入力
9. 認証完了、利用開始
```

### 6.2. 認証方式
- **メール認証コード方式**: 既存の認証システムを活用
- **6桁の認証コード**: 10分間有効
- **従業員ID**: 既存システムのIDを使用

## 7. メッセージフォーマット・UI設計

### 7.1. メッセージデザイン例

#### シフト確認メッセージ
```
📅 12月のシフト予定

12/1 (金) 18:00-22:00 ✅
12/3 (日) 18:00-24:00 ✅
12/5 (火) 16:00-20:00 ✅

[シフト交代] [給与確認] [ヘルプ]
```

#### 給与確認メッセージ
```
💰 給与状況（103万の壁ゲージ）

現在: 85.2万円
目標: 103万円
達成率: 82.7%

🟡 注意圏（70-89%）

[詳細確認] [シフト確認]
```

#### 全員シフト確認メッセージ
```
📅 12月の全員シフト予定

【12/1 (金)】
18:00-22:00 田中さん ✅
20:00-24:00 佐藤さん ✅

【12/3 (日)】
16:00-20:00 山田さん ✅
18:00-24:00 鈴木さん ✅

【12/5 (火)】
18:00-22:00 高橋さん ✅

[シフト交代] [ヘルプ]
```

### 7.2. UI設計方針
- **テキスト + クイックリプライ**: シンプルで高速
- **絵文字活用**: 視覚的に分かりやすい
- **情報整理**: 見やすい形式で表示

## 8. エラーハンドリング・例外処理

### 8.1. エラーメッセージ例

#### システムエラー時
```
❌ エラーが発生しました
「シフト確認」と入力してください
```

#### システム障害時
```
🔧 システムメンテナンス中です
しばらくしてから再度お試しください
```

#### 不正コマンド時
```
❓ コマンドが正しくありません
「ヘルプ」と入力して利用可能なコマンドを確認してください
```

### 8.2. エラー処理方針
- **親切なエラーメッセージ**: ユーザーに分かりやすく
- **次のアクション提示**: 何をすべきかを明確に
- **システム状態の適切な伝達**: 状況を正確に通知

## 9. データ同期・整合性

### 9.1. データ同期ルール
- **シフト変更時**: 即座にLINEに通知
- **勤怠データ**: 1時間ごとに同期
- **給与データ**: 1日1回（深夜）に更新
- **競合時**: 最新のデータを優先

### 9.2. 同期方針
- **リアルタイム性とパフォーマンスのバランス**
- **データの整合性確保**
- **システム負荷の考慮**

## 10. 技術要件

### 10.1. LINE Bot API連携
- LINE Messaging APIの利用
- Webhookエンドポイントの実装
- メッセージの送受信処理
- グループ・個人の識別処理

### 10.2. 認証・セキュリティ
- LINEアカウントと従業員IDの安全な紐付け
- アクセストークンの管理
- 不正アクセスの防止
- グループ・個人の適切な権限管理

### 10.3. データ連携
- 既存の勤怠管理システムとの連携
- シフト表の自動更新
- リアルタイムでのデータ同期
- グループ・個人での情報分離

## 11. 実装優先度

### 11.1. Phase 1: 基本機能
- LINE Bot友達追加・認証
- グループ・個人の識別機能
- 基本的なシフト確認機能
- 基本的なシフト交代機能

### 11.2. Phase 2: 高度な機能
- 自動通知機能
- 勤怠確認機能
- 給与状況確認機能

### 11.3. Phase 3: 拡張機能
- 統計・レポート機能
- カスタマイズ機能
- 多言語対応

## 12. 制約事項・考慮点

### 12.1. 技術的制約
- Google Apps Scriptでの実装
- LINE Messaging APIの制限
- レスポンス時間の制限
- グループ・個人の識別制限

### 12.2. 運用面の考慮
- 従業員のLINE利用状況
- プライバシーの配慮
- オフライン時の対応
- グループ・個人での情報管理

### 12.3. セキュリティ考慮
- 個人情報の適切な管理
- グループ・個人での情報分離
- 不正アクセスの防止
- データの暗号化

## 13. 運用フロー

### 13.1. 初期設定
1. 店舗のグループLINEにBotを追加
2. 各従業員が個人LINEでBotを友達追加
3. 従業員IDとLINEアカウントの紐付け
4. 権限設定（オーナー・従業員）

### 13.2. 日常運用
1. グループLINEでのシフト交代連携
2. 個人LINEでの勤怠・給与確認
3. 自動通知による情報共有

### 13.3. メンテナンス
1. 定期的なデータ同期確認
2. 基本的なエラーログの確認
3. ユーザーフィードバックの収集
4. 必要に応じた機能改善
