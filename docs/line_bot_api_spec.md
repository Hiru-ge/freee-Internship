# LINE Bot API仕様書

## 概要

勤怠管理システムのLINE Bot連携機能のAPI仕様書です。

## エンドポイント

### POST /webhook/callback

LINE Botからのwebhookを受信するエンドポイントです。

#### リクエスト

**URL**: `/webhook/callback`  
**Method**: `POST`  
**Content-Type**: `application/json`

**Headers**:
```
Content-Type: application/json
X-Line-Signature: <signature>
```

**Body**: LINE Bot webhook payload
```json
{
  "events": [
    {
      "type": "message",
      "message": {
        "type": "text",
        "text": "ヘルプ"
      },
      "source": {
        "type": "user",
        "userId": "U1234567890abcdef1234567890abcdef1"
      },
      "replyToken": "replytoken1234567890abcdef1234567890abcdef",
      "timestamp": 1234567890123
    }
  ]
}
```

#### レスポンス

**Success Response**:
- **Status**: `200 OK`
- **Body**: なし

**Error Responses**:
- **Status**: `400 Bad Request` - 署名検証失敗
- **Status**: `500 Internal Server Error` - サーバーエラー

#### 処理フロー

1. リクエスト受信
2. 署名検証
3. イベント解析
4. メッセージ処理
5. レスポンス送信

## メッセージ処理

### 対応メッセージタイプ

| メッセージタイプ | 対応状況 | 説明 |
|-----------------|---------|------|
| `text` | ✅ 対応 | テキストメッセージ |
| `image` | ❌ 未対応 | 画像メッセージ |
| `video` | ❌ 未対応 | 動画メッセージ |
| `audio` | ❌ 未対応 | 音声メッセージ |
| `file` | ❌ 未対応 | ファイルメッセージ |
| `location` | ❌ 未対応 | 位置情報メッセージ |
| `sticker` | ❌ 未対応 | スタンプメッセージ |

### 対応イベントタイプ

| イベントタイプ | 対応状況 | 説明 |
|---------------|---------|------|
| `message` | ✅ 対応 | メッセージイベント |
| `follow` | ❌ 未対応 | 友達追加イベント |
| `unfollow` | ❌ 未対応 | 友達削除イベント |
| `join` | ❌ 未対応 | グループ参加イベント |
| `leave` | ❌ 未対応 | グループ退出イベント |
| `postback` | ❌ 未対応 | ポストバックイベント |

## コマンド仕様

### ヘルプコマンド

**コマンド**: `ヘルプ`, `help`

**処理**:
1. 利用可能なコマンド一覧を生成
2. ヘルプメッセージを返信

**レスポンス**:
```
勤怠管理システムへようこそ！

利用可能なコマンド:
- ヘルプ: このメッセージを表示
- 認証: 認証コードを生成
- シフト: シフト情報を確認
- 勤怠: 勤怠状況を確認
```

### 認証コマンド

**コマンド**: `認証`

**処理**:
1. 従業員名の入力を要求
2. 認証コードをメール送信
3. 認証コードの入力を要求
4. 認証完了後、LINEアカウントと従業員アカウントを紐付け

**レスポンス**:
```
認証を開始します。
従業員名を入力してください（例：田中 太郎）
```

### シフトコマンド

**コマンド**: `シフト`

**処理**:
1. 認証状態をチェック
2. 未認証の場合：認証が必要な旨を通知
3. 認証済みの場合：個人のシフト情報を表示

**レスポンス**:
```
📅 12月のシフト予定

12/1 (金) 18:00-22:00 ✅
12/3 (日) 18:00-24:00 ✅
12/5 (火) 16:00-20:00 ✅
```

### シフト交代コマンド

**コマンド**: `シフト交代`

**処理**:
1. 認証状態をチェック
2. 未認証の場合：認証が必要な旨を通知
3. 認証済みの場合：日付入力の案内を表示

**レスポンス**:
```
📋 シフト交代依頼

交代したいシフトの日付を入力してください。

例: 09/16

※過去の日付は選択できません。
```

### シフト追加コマンド

**コマンド**: `シフト追加`

**処理**:
1. 認証状態とオーナー権限をチェック
2. 未認証の場合：認証が必要な旨を通知
3. 非オーナーの場合：オーナーのみが利用可能な旨を通知
4. 個人チャットの場合：グループチャットでのみ利用可能な旨を通知
5. 認証済みオーナーの場合：日付入力の案内を表示

**レスポンス**:
```
📅 シフト追加依頼

日付を入力してください（例：2025-01-15）
※ 過去の日付は指定できません
```

**日付入力後の処理**:
1. 日付形式の検証
2. 過去日付のチェック
3. 時間入力の案内を表示

**時間入力後の処理**:
1. 時間形式の検証
2. 従業員選択の案内を表示

**従業員選択の案内**:
```
👥 対象従業員を選択してください

💡 入力例：
• 田中太郎
• 田中
• 複数人: 田中太郎,佐藤花子

※ 複数人に送信する場合は「,」で区切って入力してください
```

**従業員選択後の処理**:
1. 従業員名の検索
2. 重複チェック
3. 確認画面の表示

**確認画面**:
```
📋 シフト追加依頼の確認

📅 日付: 01/15 (水)
⏰ 時間: 09:00-18:00
👥 対象: 田中太郎, 佐藤花子

この内容で依頼を送信しますか？
「はい」または「いいえ」で回答してください。
```

**依頼送信後の処理**:
1. 複数のシフト追加リクエストを作成
2. メール通知を送信
3. 送信完了メッセージを表示

**送信完了メッセージ**:
```
✅ 2名の従業員にシフト追加依頼を送信しました。
対象従業員に通知が送信されます。
```


### 未知のコマンド

**処理**:
1. 未知のコマンドであることを通知
2. ヘルプコマンドの案内

**レスポンス**:
```
申し訳ございませんが、そのコマンドは認識できませんでした。
'ヘルプ'と入力すると利用可能なコマンドが表示されます。
```

## エラーハンドリング

### エラー種別

#### 1. 署名検証エラー

**発生条件**: LINE webhookの署名検証に失敗

**処理**:
1. ログに警告を出力
2. `400 Bad Request`を返却

**ログ出力**:
```
LINE Bot signature validation failed
```

#### 2. メッセージ処理エラー

**発生条件**: メッセージ処理中にエラーが発生

**処理**:
1. エラーログを出力
2. ユーザーにエラーメッセージを送信

**ログ出力**:
```
LINE Bot message handling error: <error_message>
```

**ユーザーへの応答**:
```
エラーが発生しました。しばらく時間をおいてから再度お試しください。
```

#### 3. システムエラー

**発生条件**: 予期しないシステムエラーが発生

**処理**:
1. エラーログを出力
2. `500 Internal Server Error`を返却

**ログ出力**:
```
LINE Bot webhook error: <error_message>
```

## セキュリティ

### 署名検証

LINE webhookの署名検証を実装しています。

**検証方法**:
1. `X-Line-Signature`ヘッダーから署名を取得
2. リクエストボディと`LINE_CHANNEL_SECRET`でHMAC-SHA256を計算
3. 署名を比較して検証

**実装箇所**: `WebhookController#callback`

### 認証スキップ

webhookエンドポイントのみ認証をスキップしています。

**実装箇所**: `WebhookController`
```ruby
skip_before_action :require_login, if: -> { action_name == 'callback' }
```

## ログ仕様

### ログレベル

| レベル | 用途 | 出力内容 |
|--------|------|----------|
| `WARN` | 署名検証失敗 | セキュリティ関連の警告 |
| `ERROR` | エラー発生 | エラーの詳細情報 |
| `INFO` | 通常処理 | 処理の成功ログ（将来実装予定） |

### ログ出力例

```
[WARN] LINE Bot signature validation failed
[ERROR] LINE Bot message handling error: undefined method `message' for Hash
[ERROR] LINE Bot webhook error: Connection timeout
```

## パフォーマンス

### レスポンス時間

- **目標**: 3秒以内
- **現在の実装**: 1秒以内（テスト環境）

### スループット

- **目標**: 100リクエスト/分
- **現在の実装**: 未測定

## 監視項目

### メトリクス

1. **レスポンス時間**: webhook処理時間
2. **エラー率**: エラー発生率
3. **スループット**: リクエスト処理数
4. **可用性**: サービス稼働率

### アラート条件

1. **エラー率**: 5%以上
2. **レスポンス時間**: 5秒以上
3. **可用性**: 99%未満

## 今後の拡張予定

### Phase 9-1: 認証機能

- ユーザー認証
- セッション管理
- 認証コード生成
- データベース設計（Employeeテーブルにline_id追加、LineMessageLogテーブル作成）

### Phase 9-2: シフト管理

- シフト確認
- シフト申請
- シフト変更通知

### Phase 9-3: シフト追加リクエスト機能 ✅ **完了**

- シフト追加リクエストフローの実装
- シフト追加リクエスト用のFlex Message作成
- 既存のシフト追加承認機能との統合
- テスト作成（TDD手法）

### Phase 9-3.1: シフト追加リクエスト機能修正 ✅ **完了**

- 会話状態管理の修正（グループメッセージでの会話状態チェック復活）
- ユーザー体験の改善（日付警告、従業員入力ガイド改善）
- 複数人へのリクエスト送信機能の復活
- メール通知機能の復活
- 包括的なテストの整備（20テスト、78アサーション、すべて成功）

### Phase 9-3: 機能拡張（将来予定）

- 打刻リマインダー機能
- シフト変更通知機能
- その他の便利機能

## 参考資料

- [LINE Messaging API リファレンス](https://developers.line.biz/en/reference/messaging-api/)
- [LINE Bot SDK for Ruby](https://github.com/line/line-bot-sdk-ruby)
- [Rails API ガイド](https://guides.rubyonrails.org/api_app.html)
