# 認証システム仕様書

LINE Botと従業員アカウントの紐付け認証システムの詳細仕様です。

## 🎯 概要

従業員がLINEアカウントと勤怠管理システムの従業員アカウントを安全に紐付けるための認証システムです。

## 🔐 認証フロー

### 1. 認証開始
```
ユーザー → 「認証」コマンド入力
```

**条件**:
- 個人チャットでのみ実行可能
- グループチャットでは「認証は個人チャットで行ってください」と返答

**レスポンス**:
```
従業員名を入力してください。
例: 田中太郎
```

### 2. 従業員名入力
```
ユーザー → 従業員名入力（例：田中太郎）
```

**処理**:
1. 従業員名の正規化（カタカナ→ひらがな、スペース除去）
2. Freee APIから従業員情報を検索
3. 部分一致検索で従業員を特定

**成功時**:
```
認証コードを送信しました。
メールの送信には数分かかる場合があります。
認証コードを入力してください。
```

**失敗時**:
```
該当する従業員が見つかりませんでした。
正しい従業員名を入力してください。
```

### 3. 認証コード生成・送信
```
システム → 認証コード生成 → メール送信
```

**処理**:
1. 6桁のランダム認証コード生成
2. 認証コードをデータベースに保存（有効期限：30分）
3. 従業員のメールアドレスに認証コードを送信

**メール内容**:
```
件名: 【勤怠管理システム】認証コード

勤怠管理システムの認証コードをお送りします。

認証コード: 123456

このコードをLINE Botに入力して認証を完了してください。
認証コードの有効期限は30分です。

※このメールに心当たりがない場合は、無視してください。
```

### 4. 認証コード入力
```
ユーザー → 認証コード入力（例：123456）
```

**処理**:
1. 入力された認証コードの検証
2. 有効期限の確認
3. 従業員アカウントとLINEアカウントの紐付け

**成功時**:
```
認証が完了しました！
これでシフト管理機能をご利用いただけます。
```

**失敗時**:
```
認証コードが正しくありません。
再度認証コードを入力してください。
```

## 🗄️ データベース設計

### ConversationState テーブル
```sql
CREATE TABLE conversation_states (
  id BIGINT PRIMARY KEY,
  line_user_id VARCHAR(255) NOT NULL,
  state VARCHAR(255) NOT NULL,
  state_data TEXT,
  expires_at DATETIME NOT NULL,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
```

**用途**: 認証フローの状態管理

**状態**:
- `waiting_for_employee_name`: 従業員名入力待ち
- `waiting_for_verification_code`: 認証コード入力待ち

### VerificationCode テーブル
```sql
CREATE TABLE verification_codes (
  id BIGINT PRIMARY KEY,
  employee_id VARCHAR(255) NOT NULL,
  code VARCHAR(6) NOT NULL,
  expires_at DATETIME NOT NULL,
  used_at DATETIME,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
```

**用途**: 認証コードの管理

### Employee テーブル
```sql
CREATE TABLE employees (
  id BIGINT PRIMARY KEY,
  employee_id VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255),
  role VARCHAR(50) NOT NULL,
  line_id VARCHAR(255),
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
```

**用途**: 従業員情報とLINEアカウントの紐付け

## 🔍 従業員検索仕様

### 検索ロジック
1. **正規化処理**:
   - カタカナ → ひらがな変換
   - スペース・全角スペース除去
   - 大文字・小文字統一

2. **検索方法**:
   - 完全一致検索
   - 部分一致検索（前方一致、後方一致、中間一致）

3. **検索対象**:
   - Freee APIから取得した従業員名
   - 正規化された名前での検索

### 検索例
```
入力: "タナカ タロウ"
正規化: "たなか たろう"
検索: "たなかたろう" で部分一致検索
```

## ⏰ 有効期限管理

### 認証コード
- **有効期限**: 30分
- **自動削除**: 期限切れのコードは自動削除
- **再利用不可**: 使用済みコードは再利用不可

### 会話状態
- **有効期限**: 1時間
- **自動削除**: 期限切れの状態は自動削除
- **中断可能**: 新しいコマンドで状態をリセット可能

## 🛡️ セキュリティ対策

### 認証コード
- **ランダム生成**: 6桁のランダム数字
- **有効期限**: 30分の短期間
- **使用制限**: 1回のみ使用可能
- **メール送信**: 従業員の登録メールアドレスに送信

### アクセス制御
- **個人チャット限定**: 認証は個人チャットでのみ実行
- **状態管理**: 会話状態による適切な処理分岐
- **エラーハンドリング**: 不正な入力に対する適切なエラーメッセージ

### データ保護
- **暗号化**: 認証コードはハッシュ化して保存
- **ログ管理**: 認証試行のログ記録
- **自動削除**: 期限切れデータの自動削除

## 🔄 エラーハンドリング

### 認証エラー
| エラー | 原因 | 対応 |
|--------|------|------|
| 従業員が見つからない | 名前の入力ミス | 正しい名前の再入力 |
| 認証コードが無効 | コードの入力ミス | 正しいコードの再入力 |
| 認証コード期限切れ | 30分経過 | 認証フローの再実行 |
| 既に認証済み | 重複認証 | 認証完了メッセージ |

### システムエラー
| エラー | 原因 | 対応 |
|--------|------|------|
| メール送信失敗 | SMTP設定問題 | 管理者への通知 |
| Freee API接続失敗 | API接続問題 | エラーメッセージ表示 |
| データベースエラー | DB接続問題 | エラーログ記録 |

## 📊 監視・ログ

### ログ出力
- 認証開始ログ
- 認証成功ログ
- 認証失敗ログ
- エラーログ

### 監視項目
- 認証成功率
- 認証コード送信成功率
- 平均認証時間
- エラー発生率

## 🧪 テスト仕様

### 単体テスト
- 従業員名正規化テスト
- 認証コード生成テスト
- 有効期限チェックテスト
- エラーハンドリングテスト

### 統合テスト
- 認証フロー全体テスト
- メール送信テスト
- データベース連携テスト
- エラーシナリオテスト

### テストケース
1. **正常フロー**: 認証開始 → 従業員名入力 → 認証コード送信 → 認証完了
2. **従業員名エラー**: 存在しない従業員名入力
3. **認証コードエラー**: 間違った認証コード入力
4. **期限切れ**: 認証コードの有効期限切れ
5. **重複認証**: 既に認証済みのユーザー

## 🚀 今後の拡張予定

### 機能拡張
- 二要素認証の追加
- 認証コードのSMS送信
- 認証履歴の管理
- 認証の無効化機能

### セキュリティ強化
- 認証試行回数制限
- IPアドレス制限
- デバイス認証
- 生体認証連携

---

**最終更新日**: 2024年12月
**バージョン**: 1.0.0
