# テスト仕様書

## 概要

GASからRailsへの移行において、機能の完全性を保証するためのテストスイートです。

## テスト構成

### 1. 認証システムテスト
- ログイン・ログアウト
- パスワード変更・忘れ機能

### 2. シフト管理機能テスト
- シフト表示（オーナー・従業員別）
- 月次ナビゲーション
- 103万の壁ゲージ

### 3. シフト交代機能テスト
- シフト交代・追加リクエスト
- 承認・否認機能
- 権限チェック
- **シフト交代承認・否認機能テスト（TDD手法で実装）**
  - 承認処理の正常系テスト
  - 否認処理の正常系テスト
  - 複数リクエストの競合処理テスト
  - 権限チェックテスト
  - シフト削除時のエラーハンドリングテスト

### 4. 給与管理機能テスト
- 給与計算・表示
- 103万の壁計算
- 時間帯別時給

### 5. ダッシュボード機能テスト
- ダッシュボード表示
- 認証制御

### 6. セキュリティテスト（Phase 6で追加）
- **セッションタイムアウトテスト**: 24時間後の自動ログアウト
- **CSRF保護テスト**: クロスサイトリクエストフォージェリ攻撃の防止
- **入力値検証テスト**: 不正な入力値の検証
- **権限チェックテスト**: 不正な権限昇格の防止
- **外部キー制約テスト**: データ整合性の保証
- **データベースインデックステスト**: パフォーマンスの確認

### 7. 給与計算サービステスト
- 時間帯別勤務時間計算
- 月次集計
- エラーハンドリング

### 8. 共通サービステスト（Phase 13で追加）
- **ShiftExchangeServiceテスト**: シフト交代リクエストの共通処理テスト
  - 過去日付チェックテスト
  - 重複リクエストチェックテスト
  - 複数承認者チェックテスト
  - 正常リクエスト作成テスト
  - 承認・拒否処理テスト
  - 権限チェックテスト
  - パラメータ検証テスト
  - ステータス取得テスト
  - キャンセル処理テスト
  - 通知処理テスト（承認・拒否・nilチェック）

- **ShiftAdditionServiceテスト**: シフト追加リクエストの共通処理テスト
  - 過去日付チェックテスト
  - 重複リクエストチェックテスト（複数許可）
  - 正常リクエスト作成テスト
  - 承認・拒否処理テスト
  - 権限チェックテスト
  - パラメータ検証テスト
  - ステータス取得テスト
  - 既存シフトとのマージテスト
  - 複数リクエストの非排他制御テスト
  - 通知処理テスト（承認・拒否・追加リクエスト）

### 9. シフト重複チェックサービステスト
- シフト重複チェック
- 境界値テスト
- エラーハンドリング

## テストデータ

### フィクスチャ
- `owner`: 店長（employee_id: '3313254'）
- `employee1`: 従業員1（employee_id: '3316120'）
- `employee2`: 従業員2（employee_id: '3317741'）

## テスト実行

```bash
# 全テスト実行
rails test

# 特定のテストファイル実行
rails test test/controllers/auth_controller_test.rb
```

## テスト結果

- **総テスト数**: 227テスト
- **成功**: 227テスト
- **失敗**: 0テスト
- **エラー**: 0テスト
- **アサーション数**: 706アサーション

## TDD実装記録（Phase 9-2.5）

### シフト交代承認・否認機能の修正

#### Redフェーズ（失敗するテストの作成）
1. **外部キー制約エラーの発見**
   - `ActiveRecord::InvalidForeignKey`エラーの特定
   - テストデータの不整合問題の特定

2. **認証エラーの発見**
   - `ActiveModel::UnknownAttributeError: unknown attribute 'email'`の特定
   - セッション管理の問題の特定

3. **権限チェックエラーの発見**
   - `NoMethodError: undefined method 'session'`の特定
   - テストクラスの不適切な継承の特定

#### Greenフェーズ（テストを通す最小限の実装）
1. **外部キー制約エラーの解決**
   - `ShiftExchange.where(shift_id: original_shift.id).update_all(shift_id: nil)`の追加
   - 処理順序の最適化

2. **認証エラーの解決**
   - セッション直接設定による認証回避
   - `@controller.session[:authenticated] = true`の実装

3. **権限チェックエラーの解決**
   - `ActionController::TestCase`への変更
   - 適切なセッション管理の実装

#### Refactorフェーズ（コードの品質向上）
1. **処理順序の最適化**
   - 他のリクエスト拒否を先に実行
   - シフト削除前の関連データクリア

2. **エラーハンドリングの改善**
   - シフト削除時の適切なエラーメッセージ
   - 権限チェックの強化

3. **テストの分離と独立性の確保**
   - 各テストが独立して実行可能
   - データベース状態の適切な管理

## テスト保守性向上（2025年1月）

### 実装内容
- **日付・時刻依存テストの動的化**: ハードコードされた日付例を動的生成に変更
- **サービスコードの修正**: `app/services/line_bot_service.rb`の日付例を動的生成
- **テストコードの修正**: 全テストファイルの日付期待値を動的計算に変更

### 修正されたファイル
- `app/services/line_bot_service.rb`: 日付例の動的生成
- `test/services/line_bot_shift_addition_test.rb`: 日付期待値の動的計算
- `test/services/line_bot_service_test.rb`: ハードコードされた日付の動的計算
- `test/services/line_bot_service_shift_exchange_test.rb`: 日付例の動的生成
- `test/services/line_bot_service_shift_exchange_redesign_test.rb`: 日付例の動的生成
- `test/services/clock_service_test.rb`: タイムゾーン計算ロジックの改善

### 技術的成果
- **保守性向上**: テストが時間に依存しなくなり、長期間安定して動作
- **一貫性確保**: サービスコードとテストコードの両方で日付例を動的生成
- **品質向上**: 227テスト、706アサーション、すべて成功

## 品質保証

- GAS互換性の確認
- エラーハンドリングのテスト
- 権限チェックの検証
- 並列実行による高速化
- **テスト保守性**: 日付・時刻に依存しない安定したテストスイート

## 共通サービステスト（Phase 13 - 2025年1月）

### 実装内容
- **ShiftExchangeServiceテスト**: シフト交代リクエストの共通処理テスト（13テストケース）
- **ShiftAdditionServiceテスト**: シフト追加リクエストの共通処理テスト（14テストケース）
- **通知処理テスト**: 承認・拒否・追加リクエスト通知のテスト
- **重複テスト削除**: 不要になった重複テストファイルの削除
- **未使用メソッド削除**: 重複した`generate_request_id`メソッドの整理

### テストカバレッジ
- **過去日付チェック**: シフト依頼の過去日付検証
- **重複リクエストチェック**: 同一シフトへの重複依頼検証
- **権限チェック**: 承認・拒否権限の検証
- **パラメータ検証**: 必須項目の検証
- **ステータス管理**: リクエストステータスの適切な更新
- **通知処理**: メール通知の適切な送信
- **エラーハンドリング**: 異常系の適切な処理

### 実装完了情報
- **実装日**: 2025年1月
- **実装手法**: TDDのRefactorフェーズ
- **実装時間**: 12時間
- **最終テスト結果**: 418テスト、1196アサーション、100%成功
- **影響**: コードの重複削減、保守性・一貫性・テスタビリティの向上

## 追加統合対象のテスト（Phase 13-4以降）

### Phase 13-4: シフト承認処理の統合テスト ✅ **完了**
- **ShiftApprovalsControllerテスト**: 共通サービスを使用するように修正後のテスト
- **承認・拒否処理テスト**: 共通サービスの承認メソッドを使用するテスト
- **権限チェックテスト**: 承認権限の適切な検証
- **通知処理テスト**: 承認・拒否通知の適切な送信
- **仕様修正テスト**: シフトが削除された場合の承認拒否テスト
- **データ整合性テスト**: 無効なリクエストの承認防止テスト

### Phase 13-5: シフト表示処理の統合テスト
- **共通シフト表示サービステスト**: 新規作成予定のサービスのテスト
- **シフトデータ取得テスト**: WebとLINEの統合されたシフト取得処理
- **従業員情報取得テスト**: 統合された従業員情報取得処理

### Phase 13-6: 通知処理の完全統合テスト
- **残存重複通知処理テスト**: 完全統合後の通知処理テスト
- **通知ロジック統一テスト**: 統一された通知ロジックのテスト

---
