# メールアドレス変更機能 仕様書

## 1. 機能概要

Webアプリケーション上で従業員が自身のメールアドレスを変更し、その変更をfreee人事労務の従業員情報にも同期させる機能を実装します。

### 1.1 目的
- 従業員がWebアプリケーション上でメールアドレスを変更できるようにする
- 変更内容をfreee人事労務の従業員情報にも即座に反映させる
- 引き渡し先が独自のメールアドレスでシステムを運用できるようにする

### 1.2 前提条件
- freee API v1の従業員情報更新機能を使用
- 既存の認証システムを活用
- 現在のfreee API連携機能を拡張

## 2. 機能要件

### 2.1 基本機能
- **従業員自身によるメールアドレス変更**
  - ログイン済み従業員が自身のメールアドレスを変更可能
  - 現在のメールアドレスを表示
  - 新しいメールアドレスの入力・確認
  - 変更内容の保存

- **管理者による従業員メールアドレス変更**
  - オーナー権限を持つユーザーが他の従業員のメールアドレスを変更可能
  - 従業員一覧からの選択
  - 対象従業員のメールアドレス変更

### 2.2 freee API連携
- **従業員情報更新API呼び出し**
  - メールアドレス変更時にfreee APIを呼び出し
  - エンドポイント: `PUT /hr/api/v1/employees/{employee_id}`
  - リクエストボディに新しいメールアドレスを含める

- **データ同期**
  - Webアプリケーションとfreee人事労務のデータ整合性を保つ
  - 変更失敗時のロールバック処理

### 2.3 バリデーション
- **メールアドレス形式チェック**
  - RFC準拠のメールアドレス形式
  - 重複チェック（同一会社内での重複防止）

- **権限チェック**
  - 従業員は自身のメールアドレスのみ変更可能
  - オーナーは全従業員のメールアドレス変更可能

## 3. 技術仕様

### 3.1 API仕様

#### 3.1.1 freee API 従業員情報更新
```
PUT /hr/api/v1/employees/{employee_id}
Content-Type: application/json
Authorization: Bearer {access_token}

{
  "employee": {
    "email": "new_email@example.com"
  }
}
```

#### 3.1.2 レスポンス
```json
{
  "employee": {
    "id": 1234567,
    "display_name": "従業員名",
    "email": "new_email@example.com",
    "company_id": 123456
  }
}
```

### 3.2 データベース設計

#### 3.2.1 既存テーブル活用
- `employees`テーブルは変更なし
- メールアドレスはfreee APIから動的取得を継続

#### 3.2.2 新規テーブル（オプション）
```sql
CREATE TABLE email_change_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  employee_id VARCHAR NOT NULL,
  old_email VARCHAR NOT NULL,
  new_email VARCHAR NOT NULL,
  changed_by VARCHAR NOT NULL,
  changed_at DATETIME NOT NULL,
  freee_api_success BOOLEAN NOT NULL,
  created_at DATETIME NOT NULL,
  updated_at DATETIME NOT NULL
);
```

### 3.3 ファイル構成

#### 3.3.1 新規作成ファイル
```
app/controllers/employees_controller.rb          # 従業員管理コントローラー
app/services/employee_email_update_service.rb   # メールアドレス更新サービス
app/views/employees/edit_email.html.erb         # メールアドレス変更画面
app/views/employees/index.html.erb              # 従業員一覧画面
```

#### 3.3.2 修正ファイル
```
app/services/freee_api_service.rb               # freee API更新機能追加
app/models/employee.rb                          # メールアドレス変更メソッド追加
config/routes.rb                                # ルーティング追加
```

## 4. 画面仕様

### 4.1 従業員一覧画面
- **URL**: `/employees`
- **アクセス権限**: オーナーのみ
- **表示内容**:
  - 従業員一覧（ID、名前、現在のメールアドレス）
  - 各従業員の「メールアドレス変更」ボタン

### 4.2 メールアドレス変更画面
- **URL**: `/employees/{employee_id}/edit_email`
- **アクセス権限**: 本人またはオーナー
- **表示内容**:
  - 現在のメールアドレス表示
  - 新しいメールアドレス入力フィールド
  - 確認用メールアドレス入力フィールド
  - 変更ボタン、キャンセルボタン

### 4.3 レスポンシブ対応
- モバイル・タブレット・デスクトップ対応
- 既存のUIデザインと統一

## 5. エラーハンドリング

### 5.1 バリデーションエラー
- **メールアドレス形式エラー**
  - エラーメッセージ: "正しいメールアドレス形式で入力してください"
  - 入力フィールドにハイライト表示

- **メールアドレス重複エラー**
  - エラーメッセージ: "このメールアドレスは既に使用されています"
  - freee APIから取得した従業員一覧と照合

### 5.2 freee API連携エラー
- **API接続エラー**
  - エラーメッセージ: "freee人事労務との連携に失敗しました。しばらく時間をおいて再度お試しください。"
  - ログに詳細エラー情報を記録

- **権限エラー（403）**
  - エラーメッセージ: "メールアドレスの変更権限がありません"
  - 管理者に連絡を促すメッセージ

- **従業員が見つからない（404）**
  - エラーメッセージ: "従業員情報が見つかりません"
  - 従業員一覧に戻るリンクを表示

### 5.3 システムエラー
- **データベースエラー**
  - エラーメッセージ: "システムエラーが発生しました。管理者にお問い合わせください。"
  - ログに詳細エラー情報を記録

## 6. セキュリティ要件

### 6.1 認証・認可
- **セッション認証**
  - 既存のセッション認証システムを活用
  - セッション期限切れ時の適切な処理

- **権限チェック**
  - 従業員は自身のメールアドレスのみ変更可能
  - オーナーは全従業員のメールアドレス変更可能
  - CSRF保護の実装

### 6.2 データ保護
- **入力値サニタイゼーション**
  - メールアドレス入力値の適切な検証
  - XSS攻撃の防止

- **ログ記録**
  - メールアドレス変更の監査ログ
  - 変更者、変更日時、変更内容の記録

## 7. パフォーマンス要件

### 7.1 レスポンス時間
- **画面表示**: 2秒以内
- **メールアドレス変更処理**: 5秒以内
- **freee API呼び出し**: 3秒以内

### 7.2 キャッシュ戦略
- **従業員一覧**: 5分間キャッシュ
- **freee API呼び出し**: レート制限対応

## 8. テスト仕様

### 8.1 単体テスト
- **EmployeeEmailUpdateService**
  - 正常系: メールアドレス変更成功
  - 異常系: freee API連携失敗
  - 異常系: バリデーションエラー

- **FreeeApiService**
  - 従業員情報更新API呼び出し
  - エラーレスポンス処理

### 8.2 統合テスト
- **メールアドレス変更フロー**
  - 画面表示から変更完了まで
  - freee API連携の確認

- **権限チェック**
  - 従業員権限での制限確認
  - オーナー権限での全従業員変更確認

### 8.3 エンドツーエンドテスト
- **実際のfreee API連携**
  - テスト環境でのfreee API呼び出し
  - メールアドレス変更の確認

## 9. 実装スケジュール

### Phase 1: 基盤実装 (30分)
- freee API更新機能の実装
- EmployeeEmailUpdateServiceの実装
- 基本的なテスト実装

### Phase 2: UI実装 (20分)
- 従業員一覧画面の実装
- メールアドレス変更画面の実装
- ルーティング設定

### Phase 3: テスト・検証 (10分)
- 統合テストの実装
- 動作確認
- ドキュメント更新

## 10. 運用・保守

### 10.1 監視
- **freee API呼び出し成功率**
- **メールアドレス変更処理時間**
- **エラー発生率**

### 10.2 ログ管理
- **アクセスログ**: メールアドレス変更の実行ログ
- **エラーログ**: freee API連携エラーの詳細
- **監査ログ**: メールアドレス変更の履歴

### 10.3 バックアップ・復旧
- **データベースバックアップ**: 既存のバックアップ戦略を継続
- **設定ファイルバックアップ**: 環境変数のバックアップ

## 11. 今後の拡張予定

### 11.1 機能拡張
- **一括メールアドレス変更**: CSVインポート機能
- **メールアドレス変更通知**: 変更完了時のメール通知
- **変更履歴表示**: 過去の変更履歴の確認機能

### 11.2 技術改善
- **非同期処理**: 大量データ処理時の非同期化
- **API最適化**: freee API呼び出しの最適化
- **UI改善**: より使いやすいインターフェース

---

## 付録

### A. freee API リファレンス
- [freee API 従業員情報更新](https://developer.freee.co.jp/reference/hr#tag/employee)
- [freee API 認証](https://developer.freee.co.jp/reference/hr#section/Authentication)

### B. エラーコード一覧
| エラーコード | 説明 | 対処法 |
|-------------|------|--------|
| 400 | リクエスト形式エラー | 入力値を確認 |
| 401 | 認証エラー | アクセストークンを確認 |
| 403 | 権限エラー | 権限設定を確認 |
| 404 | 従業員が見つからない | 従業員IDを確認 |
| 500 | サーバーエラー | 管理者に連絡 |

### C. 設定例
```ruby
# config/initializers/freee_api.rb
Rails.application.config.freee_api = {
  "access_token" => ENV['FREEE_ACCESS_TOKEN'],
  "company_id" => ENV['FREEE_COMPANY_ID']
}
```
