# セットアップガイド

勤怠管理システムのセットアップ手順を説明します。このガイドに従うことで、独自のfreee会社でシステムを運用できます。

## 目次

1. [前提条件](#前提条件)
2. [freee人事労務での準備](#freee人事労務での準備)
3. [環境変数設定](#環境変数設定)
4. [動作確認](#動作確認)
5. [トラブルシューティング](#トラブルシューティング)

## 前提条件

### 必要なアカウント
- **freee人事労務**: 従業員・給与データ取得用

**注意**:
- その他の環境変数（Gmail、LINE Bot、Fly.io等）は既に設定済みです
- fly.ioでの動作確認について：fly.io上では、freeeアクセストークン（6時間で失効）を使用しているため、長時間の動作確認は困難です。本格的な動作確認は、独自のfreee APIトークンを取得してから行ってください

### オーナー権限の決定について
**重要**: オーナー権限は**シードデータ作成時**に決定され、その後は固定されます。

- 環境変数`OWNER_EMPLOYEE_ID`が設定されている場合：指定された従業員IDがオーナーとして設定されます
- 環境変数`OWNER_EMPLOYEE_ID`が設定されていない場合：すべての従業員が従業員権限として設定されます
- シードデータ作成後は、データベースの`role`カラムで権限が管理されます

## freee人事労務での準備

### 1. freee人事労務アカウントの準備

1. [freee人事労務](https://hr.freee.co.jp/)にアクセス
2. アカウントを作成またはログイン
3. 会社情報を登録・設定

### 2. 従業員データの登録

**重要**: 従業員名は自由に設定できます。「店長太郎」「テスト太郎」などの名前で登録する必要はありません。

#### 従業員登録手順
1. freee人事労務の管理画面にログイン
2. 「従業員管理」→「従業員一覧」を選択
3. 「従業員を追加」をクリック
4. 以下の情報を入力：
   - **氏名**: 任意の名前（例：田中太郎、佐藤花子など）
   - **メールアドレス**: 実際に使用するメールアドレス
   - **部署**: 適切な部署を設定
   - **役職**: 適切な役職を設定

#### 推奨従業員構成
- **オーナー**: 1名（管理者権限）
- **従業員**: 2-3名（一般従業員）

### 3. freee API設定

#### APIアプリケーションの作成
1. [freee API管理画面](https://secure.freee.co.jp/oauth/applications)にアクセス
2. 「新しいアプリケーション」をクリック
3. 以下の情報を入力：
   - **アプリケーション名**: 勤怠管理システム
   - **説明**: 勤怠管理・シフト管理システム
   - **コールバックURL**: `http://localhost:3000/auth/callback`（開発環境）
4. 「作成」をクリック

#### アクセストークンの取得
1. 作成したアプリケーションを選択
2. 「アクセストークン」タブを選択
3. 「新しいトークンを生成」をクリック
4. 生成されたトークンをコピー（後で使用）

#### 会社IDの確認
1. freee人事労務の管理画面で「設定」→「会社情報」を選択
2. URLの`/companies/`の後の数字が会社ID

## 環境変数設定

### 1. 環境変数の設定

環境変数は以下の方法で設定できます：

#### 開発環境の場合
プロジェクトルートの`.env`ファイルで、以下の**freee関連の環境変数のみ**を更新してください：

```bash
# freee API設定（必須）
FREEE_ACCESS_TOKEN=取得したアクセストークン
FREEE_COMPANY_ID=取得した会社ID

# オーナー設定（必須）
OWNER_EMPLOYEE_ID=オーナーの従業員ID
```

#### 本番環境（Fly.io）の場合
以下のコマンドで環境変数を設定してください：

```bash
# freee API設定（必須）
flyctl secrets set FREEE_ACCESS_TOKEN="取得したアクセストークン"
flyctl secrets set FREEE_COMPANY_ID="取得した会社ID"
flyctl secrets set OWNER_EMPLOYEE_ID="オーナーの従業員ID"
```

**注意**:
- その他の環境変数はGitHub以外の方法(GoogleDrive等経由)で渡します
- その他の環境変数（Gmail、LINE Bot等）は既に設定済みのため、変更不要です

### 2. 各環境変数の取得方法

#### FREEE_ACCESS_TOKEN
- freee API管理画面で生成したアクセストークン

#### FREEE_COMPANY_ID
- freee人事労務の会社情報画面のURLから取得

#### OWNER_EMPLOYEE_ID
- freee人事労務の従業員一覧でオーナーの従業員IDを確認
- 従業員IDは従業員名の横に表示される数字

**注意**: その他の環境変数（Gmail、LINE Bot等）は既に設定済みのため、変更不要です。

## 動作確認

### 1. システム起動

```bash
# 依存関係のインストール
bundle install

# データベースのセットアップ
rails db:create
rails db:migrate
rails db:seed

# サーバーの起動
rails server
```

### 2. 動作確認項目

#### 基本機能
- [ ] ログイン機能
- [ ] シフト確認機能
- [ ] 勤怠打刻機能
- [ ] 給与表示機能

#### シフト管理機能
- [ ] シフト交代依頼
- [ ] シフト交代承認
- [ ] シフト追加依頼
- [ ] 欠勤申請

#### LINE Bot機能
- [ ] 認証機能
- [ ] シフト確認
- [ ] シフト交代依頼
- [ ] 欠勤申請

#### メール通知機能
- [ ] 認証コード送信
- [ ] シフト依頼通知
- [ ] 承認結果通知

## トラブルシューティング

### よくある問題と解決方法

#### 1. freee API接続エラー

**症状**: 「freee APIから従業員データを取得できませんでした」

**原因と対処法**:
- **アクセストークンが無効**: freee API管理画面で新しいトークンを生成
- **会社IDが間違っている**: freee人事労務の会社情報で正しいIDを確認
- **API制限に達している**: しばらく時間をおいて再試行

#### 2. オーナー権限エラー

**症状**: オーナー機能が使えない

**原因と対処法**:
- **OWNER_EMPLOYEE_IDが間違っている**: freee人事労務で正しい従業員IDを確認
- **環境変数が設定されていない**: .envファイルでOWNER_EMPLOYEE_IDを設定

### デバッグ手順

#### 1. ログの確認
```bash
# 開発環境
tail -f log/development.log
```

#### 2. 環境変数の確認
```bash
# 開発環境
rails console
ENV["FREEE_ACCESS_TOKEN"]
ENV["OWNER_EMPLOYEE_ID"]
```

#### 3. データベースの確認
```bash
# 開発環境
rails console
Employee.all
Employee.where(role: "owner")
```

## セキュリティ注意事項

### 1. 環境変数の管理
- `.env`ファイルをGitにコミットしない
- 本番環境の認証情報を開発環境で使用しない
- 定期的にパスワードを変更する

### 2. アクセス制限
- 定期的にアクセスログを確認する
- 不要な従業員アカウントは削除する

### 3. データ保護
- 本番データを開発環境にコピーしない
- バックアップを定期的に取得する
- 機密情報をログに出力しない

## サポート

### ドキュメント
- [API仕様書](API_DOCUMENTATION.md)
- [システム仕様書](SYSTEM_SPECIFICATIONS.md)
- [トラブルシューティングガイド](TROUBLESHOOTING_GUIDE.md)

### よくある質問
- [FAQ](FAQ.md)

---

このガイドに従ってセットアップを行うことで、勤怠管理システムを正常に動作させることができます。問題が発生した場合は、トラブルシューティングセクションを参照してください。
